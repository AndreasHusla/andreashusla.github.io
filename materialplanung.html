<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materialplanung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            background-color: #34495e;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: #34495e;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }

        .tab:hover {
            background-color: #2c3e50;
        }

        .tab.active {
            background-color: #3498db;
        }

        .tab-content {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            height: 100px;
            resize: vertical;
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button.danger {
            background-color: #e74c3c;
        }

        button.danger:hover {
            background-color: #c0392b;
        }

        button.success {
            background-color: #27ae60;
        }

        button.success:hover {
            background-color: #229954;
        }

        .file-input {
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .actions {
            white-space: nowrap;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .bom-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .bom-item select, .bom-item input {
            margin-right: 10px;
            width: auto;
            min-width: 150px;
        }

        .requirements-result {
            background-color: #e8f5e8;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Materialplanung System</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('products')">Produkte</button>
            <button class="tab" onclick="showTab('boms')">Stücklisten</button>
            <button class="tab" onclick="showTab('inventory')">Lagerstand</button>
            <button class="tab" onclick="showTab('demand')">Bedarf</button>
            <button class="tab" onclick="showTab('requirements')">Bedarfsermittlung</button>
            <button class="tab" onclick="showTab('data')">Daten</button>
        </div>

        <div class="tab-content">
            <!-- Produkte Tab -->
            <div id="products" class="tab-panel active">
                <div class="grid">
                    <div class="card">
                        <h3>Neues Produkt anlegen</h3>
                        <form id="productForm">
                            <div class="form-group">
                                <label for="productNumber">Produktnummer:</label>
                                <input type="text" id="productNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="productName">Artikelname:</label>
                                <input type="text" id="productName" required>
                            </div>
                            <div class="form-group">
                                <label for="productCost">Kosten (€):</label>
                                <input type="number" id="productCost" step="0.01" required>
                            </div>
                            <button type="submit">Produkt hinzufügen</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>CSV Import - Produkte</h3>
                        <div class="file-input">
                            <label for="productsCSV">Produktliste (CSV):</label>
                            <input type="file" id="productsCSV" accept=".csv">
                            <small>Format: Produktnummer; Artikelname; Kosten</small>
                        </div>
                        <button onclick="importProductsCSV()">Produkte importieren</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Produktliste</h3>
                    <button onclick="clearAllProducts()" class="danger" style="margin-bottom: 15px;">Alle Produkte löschen</button>
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Produktnummer</th>
                                <th>Artikelname</th>
                                <th>Kosten (€)</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Stücklisten Tab -->
            <div id="boms" class="tab-panel">
                <div class="grid">
                    <div class="card">
                        <h3>Neue Stückliste anlegen</h3>
                        <form id="bomForm">
                            <div class="form-group">
                                <label for="bomProduct">Hauptprodukt:</label>
                                <select id="bomProduct" required></select>
                            </div>
                            <div class="form-group">
                                <label>Bauteile:</label>
                                <div id="bomItems"></div>
                                <button type="button" onclick="addBomItem()">Bauteil hinzufügen</button>
                            </div>
                            <button type="submit">Stückliste speichern</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>CSV Import - Stücklisten</h3>
                        <div class="file-input">
                            <label for="bomsCSV">Stücklisten (CSV):</label>
                            <input type="file" id="bomsCSV" accept=".csv">
                            <small>Format: Hauptprodukt; Bauteil; Menge</small>
                        </div>
                        <button onclick="importBomsCSV()">Stücklisten importieren</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Stücklisten Übersicht</h3>
                    <button onclick="clearAllBoms()" class="danger" style="margin-bottom: 15px;">Alle Stücklisten löschen</button>
                    <div id="bomsDisplay"></div>
                </div>
            </div>

            <!-- Lagerstand Tab -->
            <div id="inventory" class="tab-panel">
                <div class="grid">
                    <div class="card">
                        <h3>Lagerstand manuell bearbeiten</h3>
                        <form id="inventoryForm">
                            <div class="form-group">
                                <label for="inventoryProduct">Produkt:</label>
                                <select id="inventoryProduct" required></select>
                            </div>
                            <div class="form-group">
                                <label for="inventoryQuantity">Menge:</label>
                                <input type="number" id="inventoryQuantity" required>
                            </div>
                            <button type="submit">Lagerstand aktualisieren</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>CSV Import - Lagerstand</h3>
                        <div class="file-input">
                            <label for="inventoryCSV">Lagerstand (CSV):</label>
                            <input type="file" id="inventoryCSV" accept=".csv">
                            <small>Format: Produktnummer; Menge</small>
                        </div>
                        <button onclick="importInventoryCSV()">Lagerstand importieren</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Aktueller Lagerstand</h3>
                    <button onclick="clearAllInventory()" class="danger" style="margin-bottom: 15px;">Gesamten Lagerstand löschen</button>
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Produktnummer</th>
                                <th>Artikelname</th>
                                <th>Menge</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Bedarf Tab -->
            <div id="demand" class="tab-panel">
                <div class="grid">
                    <div class="card">
                        <h3>Bedarf manuell eingeben</h3>
                        <form id="demandForm">
                            <div class="form-group">
                                <label for="demandProduct">Hauptprodukt:</label>
                                <input type="text" id="demandProduct" list="demandProductList" placeholder="Produktnummer oder Name eingeben..." required>
                                <datalist id="demandProductList"></datalist>
                                <small>Tippe um zu suchen oder wähle aus der Liste</small>
                            </div>
                            <div class="form-group">
                                <label for="demandQuantity">Benötigte Menge:</label>
                                <input type="number" id="demandQuantity" required>
                            </div>
                            <button type="submit">Bedarf hinzufügen</button>
                        </form>
                    </div>
                    <div class="card">
                        <h3>CSV Import - Bedarf</h3>
                        <div class="file-input">
                            <label for="demandCSV">Bedarf (CSV):</label>
                            <input type="file" id="demandCSV" accept=".csv">
                            <small>Format: Produktnummer; Menge</small>
                        </div>
                        <button onclick="importDemandCSV()">Bedarf importieren</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Aktueller Bedarf</h3>
                    <button onclick="clearAllDemand()" class="danger" style="margin-bottom: 15px;">Gesamten Bedarf löschen</button>
                    <table id="demandTable">
                        <thead>
                            <tr>
                                <th>Produktnummer</th>
                                <th>Artikelname</th>
                                <th>Benötigte Menge</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Bedarfsermittlung Tab -->
            <div id="requirements" class="tab-panel">
                <div class="card">
                    <h3>Bedarfsermittlung</h3>
                    <p>Hier wird basierend auf dem Bedarf, den Stücklisten und dem Lagerstand ermittelt, welche Materialien bestellt werden müssen.</p>
                    <button onclick="calculateRequirements()" class="success">Bedarfsermittlung durchführen</button>
                    <button onclick="clearRequirementsResult()" class="danger">Ergebnis löschen</button>
                    <div id="requirementsResult"></div>
                </div>
            </div>

            <!-- Daten Tab -->
            <div id="data" class="tab-panel">
                <div class="grid">
                    <div class="card">
                        <h3>Daten exportieren</h3>
                        <button onclick="exportData()" class="success">JSON Backup herunterladen</button>
                        <p><small>Lädt alle Daten als JSON-Datei herunter</small></p>
                    </div>
                    <div class="card">
                        <h3>Daten importieren</h3>
                        <div class="file-input">
                            <label for="dataImport">JSON Backup:</label>
                            <input type="file" id="dataImport" accept=".json">
                        </div>
                        <button onclick="importData()">Daten importieren</button>
                        <p><small>Lädt alle Daten aus einer JSON-Backup-Datei</small></p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Daten löschen</h3>
                    <button onclick="clearAllData()" class="danger">Alle Daten löschen</button>
                    <p><small>Achtung: Dieser Vorgang kann nicht rückgängig gemacht werden!</small></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Datenstrukturen
        let products = {};
        let boms = {};
        let inventory = {};
        let demand = {};

        // App initialisieren
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateProductSelects();
            renderTables();
        });

        // Tab-Funktionalität
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Tab-Button aktivieren
            const targetTab = document.querySelector(`.tab[onclick*="${tabName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            document.getElementById(tabName).classList.add('active');
        }

        // Daten laden und speichern
        function loadData() {
            const savedData = localStorage.getItem('materialplanung');
            if (savedData) {
                const data = JSON.parse(savedData);
                products = data.products || {};
                boms = data.boms || {};
                inventory = data.inventory || {};
                demand = data.demand || {};
            }
        }

        function saveData() {
            const data = { products, boms, inventory, demand };
            localStorage.setItem('materialplanung', JSON.stringify(data));
        }

        // Produkte verwalten
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productNumber = document.getElementById('productNumber').value;
            const productName = document.getElementById('productName').value;
            const productCost = parseFloat(document.getElementById('productCost').value);
            
            if (products[productNumber]) {
                showAlert('Produktnummer bereits vorhanden!', 'error');
                return;
            }
            
            products[productNumber] = {
                name: productName,
                cost: productCost
            };
            
            saveData();
            updateProductSelects();
            renderTables();
            this.reset();
            showAlert('Produkt erfolgreich hinzugefügt!', 'success');
        });

        function editProduct(productNumber) {
            const product = products[productNumber];
            
            const newProductNumber = prompt('Neue Produktnummer:', productNumber);
            if (!newProductNumber || newProductNumber === productNumber) {
                return; // Abgebrochen oder keine Änderung
            }
            
            if (products[newProductNumber]) {
                showAlert('Produktnummer bereits vorhanden!', 'error');
                return;
            }
            
            const newProductName = prompt('Neuer Artikelname:', product.name);
            if (!newProductName) return;
            
            const newCost = prompt('Neue Kosten (€):', product.cost);
            if (!newCost || isNaN(parseFloat(newCost))) return;
            
            // Altes Produkt löschen
            delete products[productNumber];
            
            // Neues Produkt hinzufügen
            products[newProductNumber] = {
                name: newProductName,
                cost: parseFloat(newCost)
            };
            
            // Referenzen in anderen Daten aktualisieren
            if (inventory[productNumber]) {
                inventory[newProductNumber] = inventory[productNumber];
                delete inventory[productNumber];
            }
            
            if (demand[productNumber]) {
                demand[newProductNumber] = demand[productNumber];
                delete demand[productNumber];
            }
            
            // In Stücklisten aktualisieren
            Object.keys(boms).forEach(bomKey => {
                if (bomKey === productNumber) {
                    // Hauptprodukt-Stückliste umbenennen
                    boms[newProductNumber] = boms[productNumber];
                    delete boms[productNumber];
                } else if (boms[bomKey][productNumber]) {
                    // Als Komponente in anderen Stücklisten
                    boms[bomKey][newProductNumber] = boms[bomKey][productNumber];
                    delete boms[bomKey][productNumber];
                }
            });
            
            saveData();
            updateProductSelects();
            renderTables();
            showAlert('Produkt erfolgreich bearbeitet!', 'success');
        }

        function deleteProduct(productNumber) {
            if (confirm('Produkt wirklich löschen?')) {
                delete products[productNumber];
                delete inventory[productNumber];
                delete demand[productNumber];
                
                // Aus Stücklisten entfernen
                Object.keys(boms).forEach(bomKey => {
                    if (bomKey === productNumber) {
                        delete boms[bomKey];
                    } else if (boms[bomKey][productNumber]) {
                        delete boms[bomKey][productNumber];
                    }
                });
                
                saveData();
                updateProductSelects();
                renderTables();
                showAlert('Produkt gelöscht!', 'success');
            }
        }

        // Stücklisten verwalten
        function addBomItem() {
            const bomItems = document.getElementById('bomItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bom-item';
            
            itemDiv.innerHTML = `
                <select required>
                    <option value="">Bauteil wählen...</option>
                    ${Object.keys(products).map(key => 
                        `<option value="${key}">${key} - ${products[key].name}</option>`
                    ).join('')}
                </select>
                <input type="number" placeholder="Menge" required min="1">
                <button type="button" onclick="this.parentElement.remove()">Entfernen</button>
            `;
            
            bomItems.appendChild(itemDiv);
        }

        document.getElementById('bomForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productNumber = document.getElementById('bomProduct').value;
            const bomItems = document.querySelectorAll('#bomItems .bom-item');
            
            const bomData = {};
            bomItems.forEach(item => {
                const component = item.querySelector('select').value;
                const quantity = parseInt(item.querySelector('input').value);
                
                if (component && quantity > 0) {
                    bomData[component] = quantity;
                }
            });
            
            if (Object.keys(bomData).length === 0) {
                showAlert('Mindestens ein Bauteil erforderlich!', 'error');
                return;
            }
            
            boms[productNumber] = bomData;
            saveData();
            renderBoms();
            this.reset();
            document.getElementById('bomItems').innerHTML = '';
            showAlert('Stückliste gespeichert!', 'success');
        });

        // Lagerstand verwalten
        document.getElementById('inventoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productNumber = document.getElementById('inventoryProduct').value;
            const quantity = parseInt(document.getElementById('inventoryQuantity').value);
            
            inventory[productNumber] = quantity;
            saveData();
            renderTables();
            this.reset();
            showAlert('Lagerstand aktualisiert!', 'success');
        });

        // Echtzeit-Suche für Bedarf-Produktauswahl
        document.getElementById('demandProduct').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            updateDemandProductList(searchTerm);
        });

        // Bedarf verwalten
        document.getElementById('demandForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productInput = document.getElementById('demandProduct').value.trim();
            const quantity = parseInt(document.getElementById('demandQuantity').value);
            
            // Produktnummer extrahieren (falls Format "Nummer - Name" oder "Name (Nummer)")
            let productNumber = productInput;
            
            // Prüfe verschiedene Eingabeformate
            if (productInput.includes(' - ')) {
                // Format: "100001 - Produktname"
                productNumber = productInput.split(' - ')[0].trim();
            } else if (productInput.includes('(') && productInput.includes(')')) {
                // Format: "Produktname (100001)"
                const match = productInput.match(/\(([^)]+)\)/);
                if (match) {
                    productNumber = match[1].trim();
                }
            } else {
                // Direkte Eingabe der Produktnummer oder Produktname
                // Prüfe ob es eine gültige Produktnummer ist
                if (!products[productInput]) {
                    // Suche nach Produktname
                    const foundProduct = Object.keys(products).find(key => 
                        products[key].name.toLowerCase().includes(productInput.toLowerCase())
                    );
                    if (foundProduct) {
                        productNumber = foundProduct;
                    }
                }
            }
            
            // Validierung
            if (!products[productNumber]) {
                showAlert(`Produkt "${productInput}" nicht gefunden! Bitte gültige Produktnummer oder -name eingeben.`, 'error');
                return;
            }
            
            demand[productNumber] = (demand[productNumber] || 0) + quantity;
            saveData();
            renderTables();
            this.reset();
            showAlert(`Bedarf für ${productNumber} - ${products[productNumber].name} hinzugefügt!`, 'success');
        });

        // Hilfsfunktion für robustes CSV-Lesen mit verschiedenen Kodierungen
        function readCSVFile(file, callback) {
            // Erste Versuche mit UTF-8
            const reader = new FileReader();
            reader.onload = function(e) {
                let text = e.target.result;
                
                // Prüfe auf Encoding-Probleme (ersetzt �)
                if (text.includes('�') || text.includes('\ufffd')) {
                    console.log('UTF-8 fehlgeschlagen, versuche Windows-1252...');
                    // Versuche Windows-1252 (häufig bei Excel)
                    const reader2 = new FileReader();
                    reader2.onload = function(e2) {
                        let text2 = e2.target.result;
                        if (text2.includes('�') || text2.includes('\ufffd')) {
                            console.log('Windows-1252 fehlgeschlagen, versuche ISO-8859-1...');
                            // Versuche ISO-8859-1
                            const reader3 = new FileReader();
                            reader3.onload = function(e3) {
                                callback(e3.target.result);
                            };
                            reader3.readAsText(file, 'ISO-8859-1');
                        } else {
                            callback(text2);
                        }
                    };
                    reader2.readAsText(file, 'windows-1252');
                } else {
                    callback(text);
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // CSV Import-Funktionen
        function importProductsCSV() {
            const file = document.getElementById('productsCSV').files[0];
            if (!file) {
                showAlert('Bitte eine Datei auswählen!', 'error');
                return;
            }
            
            readCSVFile(file, function(csv) {
                const lines = csv.split(/\r?\n/);
                let imported = 0;
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    console.log(`Zeile ${index + 1}:`, line);
                    if (line) { // Leere Zeilen überspringen
                        // Spezielle Behandlung für Windows-Zeilenendings in den Daten selbst
                        if (line.includes('\r')) {
                            // Zeile enthält mehrere Datensätze, diese aufteilen
                            const subLines = line.split('\r').filter(l => l.trim());
                            console.log('SubLines gefunden:', subLines);
                            subLines.forEach((subLine, subIndex) => {
                                subLine = subLine.trim();
                                if (subLine) {
                                    const parts = subLine.split(';').map(s => s.trim());
                                    console.log(`SubLine ${index + 1}.${subIndex + 1} Parts:`, parts);
                                    const [productNumber, productName, cost] = parts;
                                    const normalizedCost = cost ? cost.replace(',', '.') : cost;
                                    console.log(`Debug Import: productNumber='${productNumber}', productName='${productName}', cost='${cost}', normalizedCost='${normalizedCost}', parseFloat(normalizedCost)=${parseFloat(normalizedCost)}, isNaN=${isNaN(parseFloat(normalizedCost))}`);
                                    if (productNumber && productName && cost !== undefined && cost !== '' && !isNaN(parseFloat(normalizedCost))) {
                                        products[productNumber] = {
                                            name: productName,
                                            cost: parseFloat(normalizedCost)
                                        };
                                        imported++;
                                        console.log('Importiert Produkt:', productNumber, productName, parseFloat(normalizedCost));
                                    }
                                }
                            });
                        } else {
                            const parts = line.split(';').map(s => s.trim());
                            console.log('Parts:', parts);
                            const [productNumber, productName, cost] = parts;
                            const normalizedCost = cost ? cost.replace(',', '.') : cost;
                            console.log('ProductNumber:', productNumber, 'ProductName:', productName, 'Cost:', cost, 'NormalizedCost:', normalizedCost);
                            console.log(`Debug Import: productNumber='${productNumber}', productName='${productName}', cost='${cost}', normalizedCost='${normalizedCost}', parseFloat(normalizedCost)=${parseFloat(normalizedCost)}, isNaN=${isNaN(parseFloat(normalizedCost))}`);
                            if (productNumber && productName && cost !== undefined && cost !== '' && !isNaN(parseFloat(normalizedCost))) {
                                products[productNumber] = {
                                    name: productName,
                                    cost: parseFloat(normalizedCost)
                                };
                                imported++;
                                console.log('Importiert Produkt:', productNumber, productName, parseFloat(normalizedCost));
                            } else {
                                console.log(`Zeile ${index + 1} übersprungen - ProductNumber: '${productNumber}', ProductName: '${productName}', Cost: '${cost}', normalizedCost: '${normalizedCost}', isNaN: ${isNaN(parseFloat(normalizedCost))}`);
                            }
                        }
                    }
                });
                
                saveData();
                updateProductSelects();
                renderTables();
                showAlert(`${imported} Produkte importiert!`, 'success');
            });
        }

        function importBomsCSV() {
            const file = document.getElementById('bomsCSV').files[0];
            if (!file) {
                showAlert('Bitte eine Datei auswählen!', 'error');
                return;
            }
            
            readCSVFile(file, function(csv) {
                const lines = csv.split(/\r?\n/);
                let imported = 0;
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    console.log(`Zeile ${index + 1}:`, line);
                    if (line) { // Leere Zeilen überspringen
                        // Spezielle Behandlung für Windows-Zeilenendings in den Daten selbst
                        if (line.includes('\r')) {
                            // Zeile enthält mehrere Datensätze, diese aufteilen
                            const subLines = line.split('\r').filter(l => l.trim());
                            console.log('SubLines gefunden:', subLines);
                            subLines.forEach((subLine, subIndex) => {
                                subLine = subLine.trim();
                                if (subLine) {
                                    const parts = subLine.split(';').map(s => s.trim());
                                    console.log(`SubLine ${index + 1}.${subIndex + 1} Parts:`, parts);
                                    const [mainProduct, component, quantity] = parts;
                                    if (mainProduct && component && quantity && !isNaN(parseInt(quantity))) {
                                        if (!boms[mainProduct]) {
                                            boms[mainProduct] = {};
                                        }
                                        boms[mainProduct][component] = parseInt(quantity);
                                        imported++;
                                        console.log('Importiert BOM:', mainProduct, component, parseInt(quantity));
                                    }
                                }
                            });
                        } else {
                            const parts = line.split(';').map(s => s.trim());
                            console.log('Parts:', parts);
                            const [mainProduct, component, quantity] = parts;
                            console.log('MainProduct:', mainProduct, 'Component:', component, 'Quantity:', quantity);
                            if (mainProduct && component && quantity && !isNaN(parseInt(quantity))) {
                                if (!boms[mainProduct]) {
                                    boms[mainProduct] = {};
                                }
                                boms[mainProduct][component] = parseInt(quantity);
                                imported++;
                                console.log('Importiert BOM:', mainProduct, component, parseInt(quantity));
                            } else {
                                console.log(`Zeile ${index + 1} übersprungen - MainProduct: '${mainProduct}', Component: '${component}', Quantity: '${quantity}', isNaN: ${isNaN(parseInt(quantity))}`);
                            }
                        }
                    }
                });
                
                saveData();
                renderBoms();
                showAlert(`${imported} Stücklisteneinträge importiert!`, 'success');
            });
        }

        function importInventoryCSV() {
            const file = document.getElementById('inventoryCSV').files[0];
            if (!file) {
                showAlert('Bitte eine Datei auswählen!', 'error');
                return;
            }
            
            readCSVFile(file, function(csv) {
                console.log('CSV Inhalt:', csv);
                const lines = csv.split(/\r?\n/);
                console.log('Anzahl Zeilen:', lines.length);
                let imported = 0;
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    console.log(`Zeile ${index + 1}:`, line);
                    if (line) { // Leere Zeilen überspringen
                        // Spezielle Behandlung für Windows-Zeilenendings in den Daten selbst
                        if (line.includes('\r')) {
                            // Zeile enthält mehrere Datensätze, diese aufteilen
                            const subLines = line.split('\r').filter(l => l.trim());
                            console.log('SubLines gefunden:', subLines);
                            subLines.forEach((subLine, subIndex) => {
                                subLine = subLine.trim();
                                if (subLine) {
                                    const parts = subLine.split(';').map(s => s.trim());
                                    console.log(`SubLine ${index + 1}.${subIndex + 1} Parts:`, parts);
                                    const [productNumber, quantity] = parts;
                                    if (productNumber && quantity !== '' && quantity !== undefined && !isNaN(parseInt(quantity))) {
                                        inventory[productNumber] = parseInt(quantity);
                                        imported++;
                                        console.log('Importiert:', productNumber, parseInt(quantity));
                                    }
                                }
                            });
                        } else {
                            const parts = line.split(';').map(s => s.trim());
                            console.log('Parts:', parts);
                            const [productNumber, quantity] = parts;
                            console.log('ProductNumber:', productNumber, 'Quantity:', quantity);
                            if (productNumber && quantity !== '' && quantity !== undefined && !isNaN(parseInt(quantity))) {
                                inventory[productNumber] = parseInt(quantity);
                                imported++;
                                console.log('Importiert:', productNumber, parseInt(quantity));
                            } else {
                                console.log(`Zeile ${index + 1} übersprungen - ProductNumber: '${productNumber}', Quantity: '${quantity}', isNaN: ${isNaN(parseInt(quantity))}`);
                            }
                        }
                    }
                });
                
                saveData();
                renderTables();
                showAlert(`${imported} von ${lines.filter(l => l.trim()).length} Lagerstand-Einträge importiert!`, 'success');
            });
        }

        function importDemandCSV() {
            const file = document.getElementById('demandCSV').files[0];
            if (!file) {
                showAlert('Bitte eine Datei auswählen!', 'error');
                return;
            }
            
            readCSVFile(file, function(csv) {
                console.log('CSV Inhalt:', csv);
                const lines = csv.split(/\r?\n/);
                console.log('Anzahl Zeilen:', lines.length);
                let imported = 0;
                
                lines.forEach((line, index) => {
                    line = line.trim();
                    console.log(`Zeile ${index + 1}:`, line);
                    if (line) { // Leere Zeilen überspringen
                        // Spezielle Behandlung für Windows-Zeilenendings in den Daten selbst
                        if (line.includes('\r')) {
                            // Zeile enthält mehrere Datensätze, diese aufteilen
                            const subLines = line.split('\r').filter(l => l.trim());
                            console.log('SubLines gefunden:', subLines);
                            subLines.forEach((subLine, subIndex) => {
                                subLine = subLine.trim();
                                if (subLine) {
                                    const parts = subLine.split(';').map(s => s.trim());
                                    console.log(`SubLine ${index + 1}.${subIndex + 1} Parts:`, parts);
                                    const [productNumber, quantity] = parts;
                                    if (productNumber && quantity !== '' && quantity !== undefined && !isNaN(parseInt(quantity))) {
                                        demand[productNumber] = (demand[productNumber] || 0) + parseInt(quantity);
                                        imported++;
                                        console.log('Importiert Bedarf:', productNumber, parseInt(quantity));
                                    }
                                }
                            });
                        } else {
                            const parts = line.split(';').map(s => s.trim());
                            console.log('Parts:', parts);
                            const [productNumber, quantity] = parts;
                            console.log('ProductNumber:', productNumber, 'Quantity:', quantity);
                            if (productNumber && quantity !== '' && quantity !== undefined && !isNaN(parseInt(quantity))) {
                                demand[productNumber] = (demand[productNumber] || 0) + parseInt(quantity);
                                imported++;
                                console.log('Importiert Bedarf:', productNumber, parseInt(quantity));
                            } else {
                                console.log(`Zeile ${index + 1} übersprungen - ProductNumber: '${productNumber}', Quantity: '${quantity}', isNaN: ${isNaN(parseInt(quantity))}`);
                            }
                        }
                    }
                });
                
                saveData();
                renderTables();
                showAlert(`${imported} von ${lines.filter(l => l.trim()).length} Bedarfs-Einträge importiert!`, 'success');
            });
        }

        // ERP-konforme Bedarfsermittlung
        function calculateRequirements() {
            console.log('=== Starte ERP-konforme Bedarfsermittlung ===');
            
            // Datenstrukturen für MRP-Lauf
            const netRequirements = {}; // Nettobedarf pro Ebene
            const plannedOrders = {};   // Geplante Aufträge/Bestellungen
            const purchaseParts = {};   // Einkaufsteile
            const manufactureParts = {}; // Fertigungsteile
            
            // 1. Schritt: Berechne Produktebenen (Low-Level-Codes)
            function calculateProductLevels() {
                const levels = {};
                const visited = new Set();
                
                function calculateLevel(productNumber, currentPath = []) {
                    if (currentPath.includes(productNumber)) {
                        console.warn(`Zyklus erkannt: ${currentPath.join(' -> ')} -> ${productNumber}`);
                        return 0;
                    }
                    
                    if (levels[productNumber] !== undefined) {
                        return levels[productNumber];
                    }
                    
                    if (!boms[productNumber]) {
                        // Einkaufsteil (niedrigste Ebene)
                        levels[productNumber] = 0;
                        // Debug für kritische Artikel
                        if (['100041', '101048', '100068', '900285', '900286'].includes(productNumber)) {
                            console.log(`*** EBENEN-DEBUG ${productNumber}: Einkaufsteil, Ebene = 0 ***`);
                        }
                        return 0;
                    }
                    
                    let maxLevel = 0;
                    const newPath = [...currentPath, productNumber];
                    
                    // Debug für kritische Artikel
                    if (['100041', '101048', '100068', '900285', '900286'].includes(productNumber)) {
                        console.log(`*** EBENEN-DEBUG ${productNumber}: Hat Stückliste, prüfe Komponenten ***`);
                        console.log(`    Komponenten:`, Object.keys(boms[productNumber]));
                    }
                    
                    Object.keys(boms[productNumber]).forEach(component => {
                        const componentLevel = calculateLevel(component, newPath);
                        maxLevel = Math.max(maxLevel, componentLevel + 1);
                        
                        // Debug für kritische Artikel
                        if (['100041', '101048', '100068', '900285', '900286'].includes(productNumber)) {
                            console.log(`    ${component}: Ebene ${componentLevel}, maxLevel jetzt ${maxLevel}`);
                        }
                    });
                    
                    levels[productNumber] = maxLevel;
                    
                    // Debug für kritische Artikel
                    if (['100041', '101048', '100068', '900285', '900286'].includes(productNumber)) {
                        console.log(`*** EBENEN-DEBUG ${productNumber}: Finale Ebene = ${maxLevel} ***`);
                    }
                    
                    return maxLevel;
                }
                
                // Berechne Ebenen für alle Produkte
                Object.keys(products).forEach(productNumber => {
                    calculateLevel(productNumber);
                });
                
                console.log('Produktebenen:', levels);
                return levels;
            }
            
            // 2. Schritt: Sortiere Produkte nach Ebenen (niedrigste zuerst)
            const productLevels = calculateProductLevels();
            const sortedProducts = Object.keys(productLevels)
                .sort((a, b) => productLevels[a] - productLevels[b]);
            
            console.log('Sortierte Produkte (nach Ebenen):', sortedProducts);
            
            // 3. Schritt: Initialer Primärbedarf
            console.log('\\n=== Primärbedarf ===');
            Object.keys(demand).forEach(productNumber => {
                const quantity = demand[productNumber];
                netRequirements[productNumber] = (netRequirements[productNumber] || 0) + quantity;
                console.log(`Primärbedarf: ${productNumber} = ${quantity}`);
                
                // Spezielle Debug-Ausgabe für 100892, 100041, 900286, 900285
                if (productNumber === '100892') {
                    console.log(`*** DEBUG 100892: Primärbedarf gesetzt auf ${quantity} ***`);
                }
                if (productNumber === '100041') {
                    console.log(`*** DEBUG 100041: Primärbedarf gesetzt auf ${quantity} ***`);
                }
                if (productNumber === '900286') {
                    console.log(`*** DEBUG 900286: Primärbedarf gesetzt auf ${quantity} ***`);
                }
                if (productNumber === '900285') {
                    console.log(`*** DEBUG 900285: Primärbedarf gesetzt auf ${quantity} ***`);
                }
            });
            
            // 4. Schritt: Iterative MRP-Verarbeitung
            console.log('\\n=== Iterative MRP-Verarbeitung ===');
            
            let iteration = 0;
            let hasChanges = true;
            const maxIterations = 20; // Schutz vor Endlosschleifen
            
            while (hasChanges && iteration < maxIterations) {
                iteration++;
                hasChanges = false;
                console.log(`\\n=== Iteration ${iteration} ===`);
                
                // Erstelle Kopie der aktuellen Nettoanforderungen für Vergleich
                const previousNetRequirements = { ...netRequirements };
                
                for (let level = 0; level <= Math.max(...Object.values(productLevels)); level++) {
                    console.log(`\\n--- Ebene ${level} ---`);
                    
                    const productsAtLevel = sortedProducts.filter(p => productLevels[p] === level);
                    
                    productsAtLevel.forEach(productNumber => {
                        const grossRequirement = netRequirements[productNumber] || 0;
                        
                        // Debug für relevante Artikel - auch wenn kein Bedarf
                        if (['100041', '900286', '900285', '101048'].includes(productNumber)) {
                            console.log(`*** DEBUG ${productNumber}: Prüfung in Ebene ${level} (Iteration ${iteration}) ***`);
                            console.log(`    Bruttobedarf: ${grossRequirement}`);
                            console.log(`    Wird verarbeitet: ${grossRequirement > 0 ? 'Ja' : 'Nein'}`);
                        }
                        
                        if (grossRequirement <= 0) return;
                        
                        // Prüfe, ob dieser Artikel bereits in einer vorherigen Iteration verarbeitet wurde
                        if (plannedOrders[productNumber] && iteration > 1) {
                            // Artikel bereits verarbeitet, überspringe
                            return;
                        }
                        
                        console.log(`\\nVerarbeite: ${productNumber} (Ebene ${level}, Iteration ${iteration})`);
                        console.log(`  Bruttobedarf: ${grossRequirement}`);
                        
                        // Spezielle Debug-Ausgabe für relevante Artikel
                        if (['100892', '100041', '900286', '900285', '101048'].includes(productNumber)) {
                            console.log(`*** DEBUG ${productNumber}: Wird in Ebene ${level} verarbeitet (Iteration ${iteration}) ***`);
                            console.log(`    Bruttobedarf: ${grossRequirement}`);
                            console.log(`    Lagerbestand: ${inventory[productNumber] || 0}`);
                            console.log(`    Hat Stückliste: ${boms[productNumber] ? 'Ja' : 'Nein'}`);
                            if (boms[productNumber]) {
                                console.log(`    Stückliste:`, boms[productNumber]);
                            }
                        }
                        
                        // Verfügbarer Lagerbestand
                        const availableStock = inventory[productNumber] || 0;
                        console.log(`  Lagerbestand: ${availableStock}`);
                        
                        // Nettobedarf berechnen
                        const netRequirement = Math.max(0, grossRequirement - availableStock);
                        console.log(`  Nettobedarf: ${netRequirement}`);
                        
                        if (netRequirement > 0) {
                            // Geplante Bestellung/Fertigung
                            plannedOrders[productNumber] = netRequirement;
                            
                            if (boms[productNumber]) {
                                // Fertigungsteil - Sekundärbedarf generieren
                                manufactureParts[productNumber] = netRequirement;
                                console.log(`  -> Fertigungsauftrag: ${netRequirement}`);
                                console.log(`  -> Generiere Sekundärbedarf:`);
                                
                                Object.keys(boms[productNumber]).forEach(component => {
                                    const componentQuantity = boms[productNumber][component] * netRequirement;
                                    const previousTotal = netRequirements[component] || 0;
                                    netRequirements[component] = previousTotal + componentQuantity;
                                    console.log(`    ${component}: +${componentQuantity} (total: ${netRequirements[component]})`);
                                    
                                    // Markiere Änderung wenn neuer Bedarf entstanden ist
                                    if (componentQuantity > 0) {
                                        hasChanges = true;
                                    }
                                    
                                    // Debug wenn 900286 oder 900285 Komponenten generieren
                                    if (['900286', '900285'].includes(productNumber)) {
                                        console.log(`*** DEBUG ${productNumber}: Generiert Sekundärbedarf für ${component} ***`);
                                        console.log(`    Stücklistenmenge: ${boms[productNumber][component]}`);
                                        console.log(`    Fertigungsauftrag: ${netRequirement}`);
                                        console.log(`    Bedarf für ${component}: ${componentQuantity}`);
                                        console.log(`    Vorheriger Gesamtbedarf: ${previousTotal}`);
                                        console.log(`    Neuer Gesamtbedarf: ${netRequirements[component]}`);
                                    }
                                    
                                    // Spezielle Debug-Ausgabe für 100892 und 100041
                                    if (component === '100892') {
                                        console.log(`*** DEBUG 100892: Wird von ${productNumber} benötigt ***`);
                                        console.log(`    Stücklistenmenge: ${boms[productNumber][component]}`);
                                        console.log(`    Fertigungsauftrag: ${netRequirement}`);
                                        console.log(`    Bedarf für 100892: ${componentQuantity}`);
                                        console.log(`    Vorheriger Gesamtbedarf: ${previousTotal}`);
                                        console.log(`    Neuer Gesamtbedarf: ${netRequirements[component]}`);
                                    }
                                    if (component === '100041') {
                                        console.log(`*** DEBUG 100041: Wird von ${productNumber} benötigt ***`);
                                        console.log(`    Stücklistenmenge: ${boms[productNumber][component]}`);
                                        console.log(`    Fertigungsauftrag: ${netRequirement}`);
                                        console.log(`    Bedarf für 100041: ${componentQuantity}`);
                                        console.log(`    Vorheriger Gesamtbedarf: ${previousTotal}`);
                                        console.log(`    Neuer Gesamtbedarf: ${netRequirements[component]}`);
                                    }
                                });
                            } else {
                                // Einkaufsteil
                                purchaseParts[productNumber] = netRequirement;
                                console.log(`  -> Bestellvorschlag: ${netRequirement}`);
                            }
                        } else {
                            console.log(`  -> Kein Bedarf (durch Lager gedeckt)`);
                        }
                    });
                }
                
                console.log(`\\n=== Ende Iteration ${iteration} ===`);
                console.log(`Änderungen in dieser Iteration: ${hasChanges ? 'Ja' : 'Nein'}`);
            }
            
            if (iteration >= maxIterations) {
                console.warn(`Warnung: Maximale Anzahl Iterationen (${maxIterations}) erreicht!`);
            } else {
                console.log(`\\nMRP-Lauf nach ${iteration} Iteration(en) abgeschlossen.`);
            }
            
            // 5. Schritt: Ergebnisse zusammenstellen
            console.log('\\n=== Endergebnisse ===');
            console.log('Geplante Aufträge:', plannedOrders);
            console.log('Einkaufsteile:', purchaseParts);
            console.log('Fertigungsteile:', manufactureParts);
            console.log('Alle Nettoanforderungen:', netRequirements);
            
            const finalRequirements = {};
            
            // WICHTIG: Verwende plannedOrders (nicht netRequirements) für finale Darstellung
            // Das sind die tatsächlich zu beschaffenden/fertigenden Mengen
            Object.keys(plannedOrders).forEach(productNumber => {
                const needed = plannedOrders[productNumber];
                const available = inventory[productNumber] || 0;
                const grossRequirement = netRequirements[productNumber] || needed;
                
                if (needed > 0) {
                    finalRequirements[productNumber] = {
                        required: grossRequirement,
                        available: available,
                        needed: needed,
                        cost: products[productNumber] ? (products[productNumber].cost || 0) * needed : 0,
                        level: productLevels[productNumber] || 0
                    };
                }
            });
            
            // Zusätzlich: Prüfe ob es Nettoanforderungen gibt, die nicht in plannedOrders stehen
            // (Kann bei Komponenten passieren, die nur als Sekundärbedarf benötigt werden)
            Object.keys(netRequirements).forEach(productNumber => {
                if (!plannedOrders[productNumber] && netRequirements[productNumber] > 0) {
                    const available = inventory[productNumber] || 0;
                    const grossRequirement = netRequirements[productNumber];
                    const needed = Math.max(0, grossRequirement - available);
                    
                    if (needed > 0) {
                        console.log(`Zusätzlicher Bedarf gefunden: ${productNumber} = ${needed}`);
                        
                        finalRequirements[productNumber] = {
                            required: grossRequirement,
                            available: available,
                            needed: needed,
                            cost: products[productNumber] ? (products[productNumber].cost || 0) * needed : 0,
                            level: productLevels[productNumber] || 0
                        };
                        
                        // Klassifiziere als Einkaufs- oder Fertigungsteil
                        if (boms[productNumber]) {
                            manufactureParts[productNumber] = needed;
                        } else {
                            purchaseParts[productNumber] = needed;
                        }
                    }
                }
            });
            
            console.log('\\n=== Finale Requirements ===');
            console.log('Final Requirements:', finalRequirements);
            console.log('Finale Einkaufsteile:', purchaseParts);
            console.log('Finale Fertigungsteile:', manufactureParts);
            
            displayRequirements(finalRequirements, purchaseParts, manufactureParts);
        }

        let currentFilter = 'all'; // Global für Filter-Status
        
        function displayRequirements(requirements, purchaseParts, manufactureParts) {
            const resultDiv = document.getElementById('requirementsResult');
            
            if (Object.keys(requirements).length === 0) {
                resultDiv.innerHTML = '<div class="alert success">Kein zusätzlicher Materialbedarf erforderlich!</div>';
                return;
            }
            
            // Separate Einkaufsteile und Fertigungsteile
            const purchaseRequirements = {};
            const manufactureRequirements = {};
            
            Object.keys(requirements).forEach(productNumber => {
                if (purchaseParts[productNumber]) {
                    purchaseRequirements[productNumber] = requirements[productNumber];
                } else if (manufactureParts[productNumber]) {
                    manufactureRequirements[productNumber] = requirements[productNumber];
                }
            });
            
            // Gesamtkosten berechnen
            const purchaseCost = Object.keys(purchaseRequirements).reduce((sum, key) => 
                sum + (purchaseRequirements[key].cost || 0), 0);
            const manufactureCost = Object.keys(manufactureRequirements).reduce((sum, key) => 
                sum + (manufactureRequirements[key].cost || 0), 0);
            const totalCost = purchaseCost + manufactureCost;
            
            let html = '<div class="requirements-result">';
            
            // Kostenübersicht oben
            html += `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; color: white;">💰 Kostenübersicht Materialbedarf</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${purchaseCost.toFixed(2)} €</div>
                        <div style="opacity: 0.9;">🛒 Einkaufskosten</div>
                        <div style="opacity: 0.7;">${Object.keys(purchaseRequirements).length} Artikel</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold;">${manufactureCost.toFixed(2)} €</div>
                        <div style="opacity: 0.9;">🏭 Fertigungskosten</div>
                        <div style="opacity: 0.7;">${Object.keys(manufactureRequirements).length} Artikel</div>
                    </div>
                    <div style="text-align: center; border-left: 2px solid rgba(255,255,255,0.3); padding-left: 15px;">
                        <div style="font-size: 28px; font-weight: bold;">${totalCost.toFixed(2)} €</div>
                        <div style="opacity: 0.9;">💎 Gesamtkosten</div>
                        <div style="opacity: 0.7;">${Object.keys(requirements).length} Artikel total</div>
                    </div>
                </div>
            </div>`;
            
            // Prüfe Artikel ohne Kosten
            const noCostItems = Object.keys(requirements).filter(key => 
                !products[key] || (products[key].cost || 0) === 0);
            
            // Filter-Buttons
            html += `<div style="margin-bottom: 20px; text-align: center;">
                <div style="margin-bottom: 10px;">
                    <button onclick="filterRequirements('all')" class="${currentFilter === 'all' ? 'success' : ''}" 
                            style="margin-right: 10px;">🔍 Alle anzeigen (${Object.keys(requirements).length})</button>
                    <button onclick="filterRequirements('purchase')" class="${currentFilter === 'purchase' ? 'success' : ''}" 
                            style="margin-right: 10px;">🛒 Nur Einkauf (${Object.keys(purchaseRequirements).length})</button>
                    <button onclick="filterRequirements('manufacture')" class="${currentFilter === 'manufacture' ? 'success' : ''}" 
                            style="margin-right: 10px;">🏭 Nur Fertigung (${Object.keys(manufactureRequirements).length})</button>
                    <button onclick="filterRequirements('nocost')" class="${currentFilter === 'nocost' ? 'success' : ''}" 
                            style="margin-right: 10px; ${noCostItems.length > 0 ? 'background-color: #f39c12; color: white;' : ''}">
                            ⚠️ Ohne Kosten (${noCostItems.length})</button>
                </div>
                <div>
                    <button onclick="exportRequirementsCSV()" style="background-color: #27ae60; color: white; margin-right: 10px;">
                            📊 CSV Export</button>
                    <button onclick="exportRequirementsPDF()" style="background-color: #8e44ad; color: white;">
                            📄 PDF Export</button>
                </div>
            </div>`;
            
            // Container für gefilterte Inhalte
            html += '<div id="filteredRequirements"></div>';
            
            html += '</div></div>'; // Schließe filteredRequirements und requirements-result
            
            // Speichere Daten für Filterung
            window.requirementsData = {
                requirements,
                purchaseRequirements,
                manufactureRequirements
            };
            
            resultDiv.innerHTML = html;
            
            // Initial alle anzeigen
            filterRequirements('all');
        }

        // Filter-Funktionen für Bedarfsermittlung
        function filterRequirements(filterType) {
            currentFilter = filterType;
            
            if (!window.requirementsData) return;
            
            const { requirements, purchaseRequirements, manufactureRequirements } = window.requirementsData;
            const container = document.getElementById('filteredRequirements');
            
            if (!container) return;
            
            // Erstelle purchaseParts und manufactureParts aus den requirementsData
            const purchaseParts = {};
            const manufactureParts = {};
            
            Object.keys(purchaseRequirements).forEach(key => {
                purchaseParts[key] = purchaseRequirements[key].needed;
            });
            
            Object.keys(manufactureRequirements).forEach(key => {
                manufactureParts[key] = manufactureRequirements[key].needed;
            });
            
            let html = '';
            
            // Button-Status aktualisieren
            document.querySelectorAll('#requirementsResult button').forEach(btn => {
                btn.classList.remove('success');
            });
            
            // Filter-Logik
            let itemsToShow = {};
            
            if (filterType === 'nocost') {
                // Alle Artikel ohne Kosten
                Object.keys(requirements).forEach(key => {
                    if (!products[key] || (products[key].cost || 0) === 0) {
                        itemsToShow[key] = requirements[key];
                    }
                });
                
                // Unterteile nach Einkauf/Fertigung
                const noCostPurchase = {};
                const noCostManufacture = {};
                
                Object.keys(itemsToShow).forEach(key => {
                    if (purchaseParts[key]) {
                        noCostPurchase[key] = itemsToShow[key];
                    } else if (manufactureParts[key]) {
                        noCostManufacture[key] = itemsToShow[key];
                    }
                });
                
                html += '<h4 style="color: #f39c12; margin-top: 20px;">⚠️ Artikel ohne Kostensätze:</h4>';
                
                // Standard für nocost ist 'nocost-all' wenn nicht anders angegeben
                if (currentFilter === 'nocost') {
                    currentFilter = 'nocost-all';
                }
                
                // Zusätzliche Sub-Filter für "Ohne Kosten"
                html += `<div style="margin-bottom: 15px; text-align: center;">
                    <button onclick="filterRequirements('nocost-all')" class="${currentFilter === 'nocost-all' ? 'success' : ''}" 
                            style="margin-right: 10px; font-size: 12px; padding: 5px 10px;">🔍 Alle (${Object.keys(itemsToShow).length})</button>
                    <button onclick="filterRequirements('nocost-purchase')" class="${currentFilter === 'nocost-purchase' ? 'success' : ''}" 
                            style="margin-right: 10px; font-size: 12px; padding: 5px 10px;">🛒 Nur Einkauf (${Object.keys(noCostPurchase).length})</button>
                    <button onclick="filterRequirements('nocost-manufacture')" class="${currentFilter === 'nocost-manufacture' ? 'success' : ''}" 
                            style="font-size: 12px; padding: 5px 10px;">🏭 Nur Fertigung (${Object.keys(noCostManufacture).length})</button>
                </div>`;
                
                // Bestimme welche Items angezeigt werden sollen
                let displayItems = itemsToShow;
                if (currentFilter === 'nocost-purchase') {
                    displayItems = noCostPurchase;
                } else if (currentFilter === 'nocost-manufacture') {
                    displayItems = noCostManufacture;
                }
                
                html += '<table style="margin-bottom: 20px;"><thead><tr><th>Typ</th><th>Ebene</th><th>Produktnummer</th><th>Artikelname</th><th>Benötigt</th><th>Verfügbar</th><th>Zu beschaffen</th><th>Kosten (€)</th><th>Aktionen</th></tr></thead><tbody>';
                
                Object.keys(displayItems).forEach(productNumber => {
                    const req = displayItems[productNumber];
                    const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                    const currentCost = products[productNumber] ? (products[productNumber].cost || 0) : 0;
                    const itemType = purchaseParts[productNumber] ? '🛒 Einkauf' : '🏭 Fertigung';
                    const bgColor = purchaseParts[productNumber] ? '#ffebee' : '#e3f2fd';
                    
                    html += `<tr style="background-color: ${bgColor};">
                        <td>${itemType}</td>
                        <td>${req.level || 0}</td>
                        <td>${productNumber}</td>
                        <td>${productName}</td>
                        <td>${req.required}</td>
                        <td>${req.available}</td>
                        <td><strong>${req.needed}</strong></td>
                        <td><input type="number" step="0.01" value="${currentCost}" style="width: 80px;" 
                             onchange="updateProductCost('${productNumber}', this.value)" /></td>
                        <td><button onclick="updateProductCost('${productNumber}', document.querySelector('input[onchange*=\\\'${productNumber}\\\']').value)" 
                             style="padding: 5px 10px; font-size: 12px;">💾 Speichern</button></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                
            } else if (filterType.startsWith('nocost-')) {
                // Rekursiver Aufruf für Sub-Filter
                filterRequirements('nocost');
                return;
            } else if (filterType === 'all' || filterType === 'purchase') {
                // Einkaufsteile anzeigen
                if (Object.keys(purchaseRequirements).length > 0) {
                    html += '<h4 style="color: #e74c3c; margin-top: 20px;">🛒 Einkaufsteile (zu bestellen):</h4>';
                    html += '<table style="margin-bottom: 20px;"><thead><tr><th>Ebene</th><th>Produktnummer</th><th>Artikelname</th><th>Benötigt</th><th>Verfügbar</th><th>Zu bestellen</th><th>Kosten (€)</th></tr></thead><tbody>';
                    
                    // Sortiere nach Ebenen
                    const sortedPurchase = Object.keys(purchaseRequirements)
                        .sort((a, b) => (purchaseRequirements[a].level || 0) - (purchaseRequirements[b].level || 0));
                    
                    sortedPurchase.forEach(productNumber => {
                        const req = purchaseRequirements[productNumber];
                        const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                        
                        html += `<tr style="background-color: #ffebee;">
                            <td>${req.level || 0}</td>
                            <td>${productNumber}</td>
                            <td>${productName}</td>
                            <td>${req.required}</td>
                            <td>${req.available}</td>
                            <td><strong>${req.needed}</strong></td>
                            <td><strong>${(req.cost || 0).toFixed(2)}</strong></td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table>`;
                }
            }
            
            if (filterType === 'all' || filterType === 'manufacture') {
                // Fertigungsteile anzeigen
                if (Object.keys(manufactureRequirements).length > 0) {
                    html += '<h4 style="color: #2980b9; margin-top: 20px;">🏭 Fertigungsteile (zu produzieren):</h4>';
                    html += '<table style="margin-bottom: 20px;"><thead><tr><th>Ebene</th><th>Produktnummer</th><th>Artikelname</th><th>Benötigt</th><th>Verfügbar</th><th>Zu fertigen</th><th>Kosten (€)</th></tr></thead><tbody>';
                    
                    // Sortiere nach Ebenen (höchste zuerst für Fertigung)
                    const sortedManufacture = Object.keys(manufactureRequirements)
                        .sort((a, b) => (manufactureRequirements[b].level || 0) - (manufactureRequirements[a].level || 0));
                    
                    sortedManufacture.forEach(productNumber => {
                        const req = manufactureRequirements[productNumber];
                        const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                        
                        html += `<tr style="background-color: #e3f2fd;">
                            <td>${req.level || 0}</td>
                            <td>${productNumber}</td>
                            <td>${productName}</td>
                            <td>${req.required}</td>
                            <td>${req.available}</td>
                            <td><strong>${req.needed}</strong></td>
                            <td><strong>${(req.cost || 0).toFixed(2)}</strong></td>
                        </tr>`;
                    });
                    
                    html += `</tbody></table>`;
                }
            }
            
            if (html === '') {
                html = '<p style="text-align: center; color: #666; margin: 40px 0;">Keine Daten für den ausgewählten Filter.</p>';
            }
            
            container.innerHTML = html;
            
            // Button-Highlight aktualisieren
            const activeButton = document.querySelector(`#requirementsResult button[onclick="filterRequirements('${filterType}')"]`);
            if (activeButton) {
                activeButton.classList.add('success');
            }
            
            // Spezielle Behandlung für nocost Sub-Filter
            if (filterType.startsWith('nocost')) {
                // Haupt-nocost Button auch hervorheben
                const mainNoCostButton = document.querySelector(`#requirementsResult button[onclick="filterRequirements('nocost')"]`);
                if (mainNoCostButton) {
                    mainNoCostButton.classList.add('success');
                }
            }
        }
        
        // Produktkosten direkt in Bedarfsermittlung aktualisieren
        function updateProductCost(productNumber, newCost) {
            const cost = parseFloat(newCost) || 0;
            
            if (!products[productNumber]) {
                showAlert(`Produkt ${productNumber} nicht gefunden!`, 'error');
                return;
            }
            
            products[productNumber].cost = cost;
            saveData();
            showAlert(`Kosten für ${productNumber} auf ${cost.toFixed(2)} € aktualisiert!`, 'success');
            
            // Bedarfsermittlung neu berechnen um aktualisierte Kosten zu zeigen
            calculateRequirements();
        }
        
        // CSV Export der Bedarfsermittlung
        function exportRequirementsCSV() {
            if (!window.requirementsData) {
                showAlert('Keine Bedarfsermittlung verfügbar!', 'error');
                return;
            }
            
            const { requirements, purchaseRequirements, manufactureRequirements } = window.requirementsData;
            
            let csvContent = 'Typ;Ebene;Produktnummer;Artikelname;Benötigt;Verfügbar;Zu beschaffen;Kosten pro Einheit;Gesamtkosten\n';
            
            // Einkaufsteile
            Object.keys(purchaseRequirements).forEach(productNumber => {
                const req = purchaseRequirements[productNumber];
                const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                const unitCost = products[productNumber] ? (products[productNumber].cost || 0) : 0;
                
                csvContent += `Einkauf;${req.level || 0};${productNumber};${productName};${req.required};${req.available};${req.needed};${unitCost.toFixed(2)};${(req.cost || 0).toFixed(2)}\n`;
            });
            
            // Fertigungsteile
            Object.keys(manufactureRequirements).forEach(productNumber => {
                const req = manufactureRequirements[productNumber];
                const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                const unitCost = products[productNumber] ? (products[productNumber].cost || 0) : 0;
                
                csvContent += `Fertigung;${req.level || 0};${productNumber};${productName};${req.required};${req.available};${req.needed};${unitCost.toFixed(2)};${(req.cost || 0).toFixed(2)}\n`;
            });
            
            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Bedarfsermittlung_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showAlert('CSV-Export erfolgreich heruntergeladen!', 'success');
        }
        
        // PDF Export der Bedarfsermittlung
        function exportRequirementsPDF() {
            if (!window.requirementsData) {
                showAlert('Keine Bedarfsermittlung verfügbar!', 'error');
                return;
            }
            
            // Vereinfachter PDF-Export als HTML-Print
            const { requirements, purchaseRequirements, manufactureRequirements } = window.requirementsData;
            
            // Berechne Kosten
            const purchaseCost = Object.keys(purchaseRequirements).reduce((sum, key) => 
                sum + (purchaseRequirements[key].cost || 0), 0);
            const manufactureCost = Object.keys(manufactureRequirements).reduce((sum, key) => 
                sum + (manufactureRequirements[key].cost || 0), 0);
            const totalCost = purchaseCost + manufactureCost;
            
            const printWindow = window.open('', '_blank');
            let printContent = `
                <html>
                <head>
                    <title>Bedarfsermittlung ${new Date().toLocaleDateString()}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        h1, h2 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f8f9fa; }
                        .summary { background-color: #e8f5e8; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
                        .purchase-row { background-color: #ffebee; }
                        .manufacture-row { background-color: #e3f2fd; }
                    </style>
                </head>
                <body>
                    <h1>Bedarfsermittlung vom ${new Date().toLocaleDateString()}</h1>
                    <div class="summary">
                        <h2>Kostenübersicht</h2>
                        <p><strong>Einkaufskosten:</strong> ${purchaseCost.toFixed(2)} € (${Object.keys(purchaseRequirements).length} Artikel)</p>
                        <p><strong>Fertigungskosten:</strong> ${manufactureCost.toFixed(2)} € (${Object.keys(manufactureRequirements).length} Artikel)</p>
                        <p><strong>Gesamtkosten:</strong> ${totalCost.toFixed(2)} € (${Object.keys(requirements).length} Artikel total)</p>
                    </div>`;
                    
            if (Object.keys(purchaseRequirements).length > 0) {
                printContent += '<h2>🛒 Einkaufsteile</h2><table><thead><tr><th>Ebene</th><th>Produktnummer</th><th>Artikelname</th><th>Benötigt</th><th>Verfügbar</th><th>Zu bestellen</th><th>Kosten (€)</th></tr></thead><tbody>';
                
                Object.keys(purchaseRequirements).forEach(productNumber => {
                    const req = purchaseRequirements[productNumber];
                    const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                    
                    printContent += `<tr class="purchase-row">
                        <td>${req.level || 0}</td>
                        <td>${productNumber}</td>
                        <td>${productName}</td>
                        <td>${req.required}</td>
                        <td>${req.available}</td>
                        <td><strong>${req.needed}</strong></td>
                        <td><strong>${(req.cost || 0).toFixed(2)}</strong></td>
                    </tr>`;
                });
                
                printContent += '</tbody></table>';
            }
            
            if (Object.keys(manufactureRequirements).length > 0) {
                printContent += '<h2>🏭 Fertigungsteile</h2><table><thead><tr><th>Ebene</th><th>Produktnummer</th><th>Artikelname</th><th>Benötigt</th><th>Verfügbar</th><th>Zu fertigen</th><th>Kosten (€)</th></tr></thead><tbody>';
                
                Object.keys(manufactureRequirements).forEach(productNumber => {
                    const req = manufactureRequirements[productNumber];
                    const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                    
                    printContent += `<tr class="manufacture-row">
                        <td>${req.level || 0}</td>
                        <td>${productNumber}</td>
                        <td>${productName}</td>
                        <td>${req.required}</td>
                        <td>${req.available}</td>
                        <td><strong>${req.needed}</strong></td>
                        <td><strong>${(req.cost || 0).toFixed(2)}</strong></td>
                    </tr>`;
                });
                
                printContent += '</tbody></table>';
            }
            
            printContent += '</body></html>';
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
            
            showAlert('PDF-Export wird vorbereitet...', 'success');
        }

        // UI-Hilfsfunktionen
        function updateProductSelects() {
            const selects = ['bomProduct', 'inventoryProduct'];
            
            // Normale Select-Dropdowns aktualisieren
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Produkt wählen...</option>';
                    
                    Object.keys(products).forEach(key => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${key} - ${products[key].name}`;
                        select.appendChild(option);
                    });
                }
            });
            
            // Spezielle Behandlung für die durchsuchbare Bedarf-Datalist
            updateDemandProductList();
        }
        
        function updateDemandProductList(searchTerm = '') {
            const datalist = document.getElementById('demandProductList');
            if (datalist) {
                datalist.innerHTML = '';
                
                const filteredProducts = Object.keys(products).filter(key => {
                    const product = products[key];
                    if (!searchTerm) return true;
                    
                    return key.toLowerCase().includes(searchTerm) || 
                           product.name.toLowerCase().includes(searchTerm);
                });
                
                // Limitiere auf maximal 50 Ergebnisse für Performance
                filteredProducts.slice(0, 50).forEach(key => {
                    const product = products[key];
                    
                    // Option für Produktnummer - Name
                    const optionByNumber = document.createElement('option');
                    optionByNumber.value = key;
                    optionByNumber.textContent = `${key} - ${product.name}`;
                    datalist.appendChild(optionByNumber);
                    
                    // Option für Name (Produktnummer) - falls Name vom Suchbegriff besser passt
                    if (product.name && product.name !== key && 
                        product.name.toLowerCase().includes(searchTerm) && 
                        !key.toLowerCase().includes(searchTerm)) {
                        const optionByName = document.createElement('option');
                        optionByName.value = key;
                        optionByName.textContent = `${product.name} (${key})`;
                        datalist.appendChild(optionByName);
                    }
                });
                
                // Zeige Anzahl der Ergebnisse (nur bei Suche)
                if (searchTerm && filteredProducts.length > 50) {
                    console.log(`${filteredProducts.length} Produkte gefunden, zeige erste 50`);
                }
            }
        }

        function renderTables() {
            renderProductsTable();
            renderInventoryTable();
            renderDemandTable();
            renderBoms();
        }

        function renderProductsTable() {
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = '';
            
            Object.keys(products).forEach(key => {
                const product = products[key];
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${key}</td>
                    <td>${product.name || 'Unbekannt'}</td>
                    <td>${(product.cost || 0).toFixed(2)}</td>
                    <td class="actions">
                        <button onclick="editProduct('${key}')">Bearbeiten</button>
                        <button onclick="deleteProduct('${key}')" class="danger">Löschen</button>
                    </td>
                `;
            });
        }

        function renderInventoryTable() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            
            Object.keys(products).forEach(key => {
                const product = products[key];
                const quantity = inventory[key] || 0;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${key}</td>
                    <td>${product.name}</td>
                    <td>${quantity}</td>
                    <td class="actions">
                        <button onclick="deleteInventory('${key}')" class="danger">Löschen</button>
                    </td>
                `;
            });
        }

        function renderDemandTable() {
            const tbody = document.querySelector('#demandTable tbody');
            tbody.innerHTML = '';
            
            Object.keys(demand).forEach(key => {
                if (products[key]) {
                    const product = products[key];
                    const quantity = demand[key];
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${key}</td>
                        <td>${product.name}</td>
                        <td>${quantity}</td>
                        <td class="actions">
                            <button onclick="deleteDemand('${key}')" class="danger">Löschen</button>
                        </td>
                    `;
                }
            });
        }

        function renderBoms() {
            const display = document.getElementById('bomsDisplay');
            display.innerHTML = '';
            
            Object.keys(boms).forEach(productNumber => {
                const productName = products[productNumber] ? products[productNumber].name : 'Unbekannt';
                const bomDiv = document.createElement('div');
                bomDiv.className = 'card';
                bomDiv.style.marginBottom = '10px';
                
                let html = `<h4>${productNumber} - ${productName}</h4><ul>`;
                Object.keys(boms[productNumber]).forEach(component => {
                    const componentName = products[component] ? products[component].name : 'Unbekannt';
                    const quantity = boms[productNumber][component];
                    html += `<li>${component} - ${componentName}: ${quantity} Stück</li>`;
                });
                html += `</ul><button onclick="editBom('${productNumber}')">Bearbeiten</button><button onclick="deleteBom('${productNumber}')" class="danger">Stückliste löschen</button>`;
                
                bomDiv.innerHTML = html;
                display.appendChild(bomDiv);
            });
        }

        // Löschfunktionen
        function deleteInventory(productNumber) {
            if (confirm('Lagerstand löschen?')) {
                delete inventory[productNumber];
                saveData();
                renderTables();
                showAlert('Lagerstand gelöscht!', 'success');
            }
        }

        function deleteDemand(productNumber) {
            if (confirm('Bedarf löschen?')) {
                delete demand[productNumber];
                saveData();
                renderTables();
                showAlert('Bedarf gelöscht!', 'success');
            }
        }

        function editBom(productNumber) {
            // Aktuelles BOM-Formular leeren
            document.getElementById('bomProduct').value = productNumber;
            document.getElementById('bomItems').innerHTML = '';
            
            // Bestehende Komponenten laden
            if (boms[productNumber]) {
                Object.keys(boms[productNumber]).forEach(component => {
                    const quantity = boms[productNumber][component];
                    const bomItems = document.getElementById('bomItems');
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bom-item';
                    
                    itemDiv.innerHTML = `
                        <select required>
                            <option value="">Bauteil wählen...</option>
                            ${Object.keys(products).map(key => 
                                `<option value="${key}" ${key === component ? 'selected' : ''}>${key} - ${products[key].name}</option>`
                            ).join('')}
                        </select>
                        <input type="number" placeholder="Menge" required min="1" value="${quantity}">
                        <button type="button" onclick="this.parentElement.remove()">Entfernen</button>
                    `;
                    
                    bomItems.appendChild(itemDiv);
                });
            }
            
            // Zum Stücklisten-Tab wechseln
            showTab('boms');
            
            showAlert('Stückliste zur Bearbeitung geladen!', 'success');
        }

        function deleteBom(productNumber) {
            if (confirm('Stückliste löschen?')) {
                delete boms[productNumber];
                saveData();
                renderBoms();
                showAlert('Stückliste gelöscht!', 'success');
            }
        }

        // Datenexport und -import
        function exportData() {
            const data = { products, boms, inventory, demand };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `materialplanung_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Backup erfolgreich heruntergeladen!', 'success');
        }

        function importData() {
            const file = document.getElementById('dataImport').files[0];
            if (!file) {
                showAlert('Bitte eine Datei auswählen!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    products = data.products || {};
                    boms = data.boms || {};
                    inventory = data.inventory || {};
                    demand = data.demand || {};
                    
                    saveData();
                    updateProductSelects();
                    renderTables();
                    showAlert('Daten erfolgreich importiert!', 'success');
                } catch (error) {
                    showAlert('Fehler beim Importieren der Daten!', 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Spezifische Löschfunktionen für jeden Tab
        function clearAllProducts() {
            if (confirm('Wirklich alle Produkte löschen? Dies löscht auch alle zugehörigen Stücklisten, Lagerbestände und Bedarfe!')) {
                products = {};
                boms = {};
                inventory = {};
                demand = {};
                
                saveData();
                updateProductSelects();
                renderTables();
                document.getElementById('requirementsResult').innerHTML = '';
                showAlert('Alle Produkte und zugehörige Daten gelöscht!', 'success');
            }
        }

        function clearAllBoms() {
            if (confirm('Wirklich alle Stücklisten löschen?')) {
                boms = {};
                
                saveData();
                renderBoms();
                document.getElementById('requirementsResult').innerHTML = '';
                showAlert('Alle Stücklisten gelöscht!', 'success');
            }
        }

        function clearAllInventory() {
            if (confirm('Wirklich den gesamten Lagerstand löschen?')) {
                inventory = {};
                
                saveData();
                renderTables();
                document.getElementById('requirementsResult').innerHTML = '';
                showAlert('Gesamter Lagerstand gelöscht!', 'success');
            }
        }

        function clearAllDemand() {
            if (confirm('Wirklich den gesamten Bedarf löschen?')) {
                demand = {};
                
                saveData();
                renderTables();
                document.getElementById('requirementsResult').innerHTML = '';
                showAlert('Gesamter Bedarf gelöscht!', 'success');
            }
        }

        function clearRequirementsResult() {
            document.getElementById('requirementsResult').innerHTML = '';
            showAlert('Bedarfsermittlungs-Ergebnis gelöscht!', 'success');
        }

        function clearAllData() {
            if (confirm('Wirklich alle Daten löschen? Dieser Vorgang kann nicht rückgängig gemacht werden!')) {
                products = {};
                boms = {};
                inventory = {};
                demand = {};
                
                localStorage.removeItem('materialplanung');
                updateProductSelects();
                renderTables();
                document.getElementById('requirementsResult').innerHTML = '';
                showAlert('Alle Daten gelöscht!', 'success');
            }
        }

        // Alert-System
        function showAlert(message, type) {
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            document.querySelector('.container').insertBefore(alert, document.querySelector('.tabs'));
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>