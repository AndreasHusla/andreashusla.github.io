<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schafverwaltung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sheep-card {
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .sheep-card:hover {
            transform: translateY(-2px);
        }
        .alert-card {
            border-left: 4px solid #dc3545;
        }
        .legend {
            font-size: 0.85rem;
        }
        .legend-item {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
        }
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border: 1px solid #dee2e6;
        }
        .navbar-brand {
            font-weight: bold;
        }
        .action-buttons {
            gap: 5px;
        }
        
        /* Stammbaum-Styles */
        .family-tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .tree-level {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .tree-node {
            background: white;
            border: 2px solid #28a745;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            min-width: 120px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .tree-node.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        
        .tree-node.female {
            border-color: #e91e63;
            background-color: #fce4ec;
        }
        
        .tree-node.male {
            border-color: #2196f3;
            background-color: #e3f2fd;
        }
        
        .tree-node.deleted {
            opacity: 0.6;
            border-style: dashed;
        }
        
        .tree-node-name {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }
        
        .tree-node-info {
            font-size: 0.7rem;
            color: #666;
        }
        
        .tree-connector {
            position: relative;
            width: 100%;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .tree-connector::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #ccc;
            z-index: -1;
        }
        
        .tree-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .tree-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-sheep"></i> Schafverwaltung</a>
            <div class="d-flex">
                <button class="btn btn-outline-light me-2" onclick="exportData()">
                    <i class="fas fa-download"></i> JSON Export
                </button>
                <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
                <button class="btn btn-outline-light" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload"></i> JSON Import
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Dashboard -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Dashboard - Erinnerungen</h5>
                    </div>
                    <div class="card-body" id="alertsContainer">
                        <!-- Alerts werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="mainTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#overview">Übersicht</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#addSheep">Schaf hinzufügen</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#statistics" onclick="updateStatistics()">Statistiken</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#familyTree" onclick="generateFamilyTree()">Stammbaum</a>
            </li>
        </ul>

        <div class="tab-content mt-3">
            <!-- Übersicht Tab -->
            <div class="tab-pane fade show active" id="overview">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Schafe suchen..." onkeyup="filterSheep()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filterSelect" onchange="displaySheep()">
                            <option value="active">Aktive Schafe</option>
                            <option value="all">Alle Schafe (inkl. gelöschte)</option>
                            <option value="deleted">Nur gelöschte Schafe</option>
                            <option value="noEarTag">Ohne Ohrmarke</option>
                            <option value="withEarTag">Mit Ohrmarke</option>
                            <option value="needsEarTag">Ohrmarke erforderlich (≥5 Monate)</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="sortSelect" onchange="displaySheep()">
                            <option value="number">Nach Nummer sortieren</option>
                            <option value="name">Nach Name sortieren</option>
                            <option value="birthDate">Nach Geburtsdatum sortieren</option>
                            <option value="earTag">Nach Ohrmarke sortieren</option>
                        </select>
                    </div>
                </div>
                
                <!-- Legende -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="legend d-flex flex-wrap align-items-center">
                                    <strong class="me-3">Legende:</strong>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #28a745;"></div>
                                        Mit Ohrmarke
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #ffc107;"></div>
                                        Unter 5 Monate (ohne Ohrmarke)
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #dc3545;"></div>
                                        Über 5 Monate (ohne Ohrmarke)
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #6c757d;"></div>
                                        Gelöschte Schafe
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="sheepContainer">
                    <!-- Schafe werden hier dynamisch eingefügt -->
                </div>
            </div>

            <!-- Schaf hinzufügen Tab -->
            <div class="tab-pane fade" id="addSheep">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Neues Schaf hinzufügen</h5>
                    </div>
                    <div class="card-body">
                        <form id="sheepForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="sheepName" class="form-label">Name (optional)</label>
                                        <input type="text" class="form-control" id="sheepName" placeholder="z.B. Bella, Max, etc.">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="birthDate" class="form-label">Geburtsdatum *</label>
                                        <input type="date" class="form-control" id="birthDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="earTag" class="form-label">Ohrmarkennummer</label>
                                        <input type="text" class="form-control" id="earTag" placeholder="z.B. DE-123456789">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="gender" class="form-label">Geschlecht</label>
                                        <select class="form-select" id="gender">
                                            <option value="">Nicht angegeben</option>
                                            <option value="weiblich">Weiblich</option>
                                            <option value="männlich">Männlich</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="motherSheep" class="form-label">Mutterschaf</label>
                                        <select class="form-select" id="motherSheep">
                                            <option value="">Kein Mutterschaf zuordnen</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">Notizen</label>
                                        <textarea class="form-control" id="notes" rows="2" placeholder="Besondere Merkmale, Gesundheit, etc."></textarea>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-plus"></i> Schaf hinzufügen
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                <i class="fas fa-undo"></i> Formular zurücksetzen
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Statistiken Tab -->
            <div class="tab-pane fade" id="statistics">
                <!-- Zeitraum-Filter -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Zeitraum auswählen</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label small"><strong>Statistik-Modus:</strong></label>
                                        <div class="btn-group w-100 mb-2" role="group">
                                            <button type="button" class="btn btn-outline-info active" id="statsModeAll" onclick="setStatsMode('all')">
                                                <i class="fas fa-baby"></i> Geboren im Zeitraum
                                            </button>
                                            <button type="button" class="btn btn-outline-success" id="statsModeActive" onclick="setStatsMode('active')">
                                                <i class="fas fa-sheep"></i> Aktueller Bestand
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label small"><strong>Zeitraum:</strong></label>
                                        <div class="btn-group flex-wrap w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStatsPeriod('week')">
                                                <i class="fas fa-calendar-week"></i> Woche
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStatsPeriod('month')">
                                                <i class="fas fa-calendar-day"></i> Monat
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStatsPeriod('30days')">
                                                <i class="fas fa-calendar-minus"></i> 30 Tage
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="setStatsPeriod('year')">
                                                <i class="fas fa-calendar"></i> Jahr
                                            </button>
                                            <button type="button" class="btn btn-outline-primary btn-sm active" onclick="setStatsPeriod('all')">
                                                <i class="fas fa-infinity"></i> Alle
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="date" class="form-control form-control-sm" id="statsDateFrom" placeholder="Von">
                                            </div>
                                            <div class="col-6">
                                                <input type="date" class="form-control form-control-sm" id="statsDateTo" placeholder="Bis">
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary mt-2 w-100" onclick="setStatsCustomRange()">
                                            <i class="fas fa-search"></i> Benutzerdef. Zeitraum
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Aktueller Zeitraum: <span id="currentStatsPeriod">Gesamte Zeit</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Gesamtübersicht -->
                    <div class="col-md-3 mb-4">
                        <div class="card text-center bg-primary text-white">
                            <div class="card-body">
                                <i class="fas fa-sheep fa-2x mb-2"></i>
                                <h3 class="card-title" id="statTotalSheep">0</h3>
                                <p class="card-text" id="statTotalLabel">Gesamt</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card text-center bg-success text-white">
                            <div class="card-body">
                                <i class="fas fa-tag fa-2x mb-2"></i>
                                <h3 class="card-title" id="statWithEarTags">0</h3>
                                <p class="card-text">Mit Ohrmarke</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card text-center bg-warning text-dark">
                            <div class="card-body">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <h3 class="card-title" id="statNeedEarTags">0</h3>
                                <p class="card-text">Benötigen Ohrmarke</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card text-center bg-secondary text-white">
                            <div class="card-body">
                                <i class="fas fa-trash fa-2x mb-2"></i>
                                <h3 class="card-title" id="statDeleted">0</h3>
                                <p class="card-text" id="statDeletedLabel">Gelöschte</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Geschlechterverteilung -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-venus-mars"></i> Geschlechterverteilung</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Weiblich</span>
                                        <span id="statFemaleCount">0</span>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar" style="background-color: #e91e63;" id="statFemaleBar"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Männlich</span>
                                        <span id="statMaleCount">0</span>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-info" id="statMaleBar"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="d-flex justify-content-between">
                                        <span>Nicht angegeben</span>
                                        <span id="statUnknownCount">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-secondary" id="statUnknownBar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Altersverteilung -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-birthday-cake"></i> Altersverteilung</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Lämmer (0-5 Monate)</span>
                                        <span id="statLambs">0</span>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" id="statLambsBar"></div>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between">
                                        <span>Jungtiere (5-12 Monate)</span>
                                        <span id="statYoung">0</span>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" id="statYoungBar"></div>
                                    </div>
                                </div>
                                <div>
                                    <div class="d-flex justify-content-between">
                                        <span>Erwachsene (12+ Monate)</span>
                                        <span id="statAdults">0</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-primary" id="statAdultsBar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Neugeborene -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-baby"></i> Geborene Schafe <small id="birthsPeriodLabel">(gesamte Zeit)</small></h5>
                            </div>
                            <div class="card-body" id="recentBirths">
                                <!-- Wird dynamisch gefüllt -->
                            </div>
                        </div>
                    </div>

                    <!-- Mütter mit Nachwuchs -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-heart"></i> Mütter mit Nachwuchs</h5>
                            </div>
                            <div class="card-body" id="mothersWithChildren">
                                <!-- Wird dynamisch gefüllt -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- Löschungsstatistiken -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Löschungsstatistiken</h5>
                            </div>
                            <div class="card-body">
                                <div class="row" id="deletionStats">
                                    <!-- Wird dynamisch gefüllt -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lammverluste -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-heart-broken"></i> Lammverluste nach Mutterschaf</h5>
                            </div>
                            <div class="card-body" id="lambLossStats">
                                <!-- Wird dynamisch gefüllt -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stammbaum Tab -->
            <div class="tab-pane fade" id="familyTree">
                <div class="tree-info">
                    <h5><i class="fas fa-sitemap"></i> Familienstammbaum</h5>
                    <p class="mb-0">Hier können Sie die Familienbeziehungen zwischen Ihren Schafen visualisieren. Wählen Sie ein Schaf aus, um dessen Stammbaum anzuzeigen.</p>
                </div>
                
                <div class="tree-controls">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary active" id="treeViewMode" onclick="setTreeViewMode('ancestors')">
                            <i class="fas fa-arrow-up"></i> Vorfahren
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTreeViewMode('descendants')">
                            <i class="fas fa-arrow-down"></i> Nachkommen
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="setTreeViewMode('full')">
                            <i class="fas fa-sitemap"></i> Vollständig
                        </button>
                    </div>
                    
                    <select class="form-select" id="treeSheepSelect" style="max-width: 300px;" onchange="generateFamilyTree()">
                        <option value="">Schaf für Stammbaum auswählen...</option>
                    </select>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="showDeletedInTree" onchange="generateFamilyTree()">
                        <label class="form-check-label" for="showDeletedInTree">
                            Gelöschte Schafe anzeigen
                        </label>
                    </div>
                </div>
                
                <!-- Legende für Stammbaum -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="legend d-flex flex-wrap align-items-center">
                                    <strong class="me-3">Legende:</strong>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #fce4ec; border-color: #e91e63;"></div>
                                        Weiblich
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #e3f2fd; border-color: #2196f3;"></div>
                                        Männlich
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: white; border-color: #28a745;"></div>
                                        Unbekannt
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: #e7f3ff; border-color: #007bff;"></div>
                                        Ausgewählt
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-color" style="background-color: white; border: 2px dashed #ccc; opacity: 0.6;"></div>
                                        Gelöscht
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="familyTreeContainer" class="family-tree">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Wählen Sie ein Schaf aus der Dropdown-Liste aus, um dessen Stammbaum anzuzeigen.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schaf bearbeiten</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editSheepId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editName" class="form-label">Name (optional)</label>
                                    <input type="text" class="form-control" id="editName" placeholder="z.B. Bella, Max, etc.">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBirthDate" class="form-label">Geburtsdatum *</label>
                                    <input type="date" class="form-control" id="editBirthDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editEarTag" class="form-label">Ohrmarkennummer</label>
                                    <input type="text" class="form-control" id="editEarTag">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editGender" class="form-label">Geschlecht</label>
                                    <select class="form-select" id="editGender">
                                        <option value="">Nicht angegeben</option>
                                        <option value="weiblich">Weiblich</option>
                                        <option value="männlich">Männlich</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editMotherSheep" class="form-label">Mutterschaf</label>
                                    <select class="form-select" id="editMotherSheep">
                                        <option value="">Kein Mutterschaf zuordnen</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editNotes" class="form-label">Notizen</label>
                                    <textarea class="form-control" id="editNotes" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-success" onclick="saveEditedSheep()">Änderungen speichern</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Schaf löschen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="deleteSheepId">
                    <p>Möchten Sie das Schaf "<span id="deleteSheepName"></span>" wirklich löschen?</p>
                    <div class="mb-3">
                        <label for="deleteReason" class="form-label">Grund für das Löschen *</label>
                        <select class="form-select" id="deleteReason" required>
                            <option value="">Grund auswählen...</option>
                            <option value="verkauft">Verkauft</option>
                            <option value="verstorben">Verstorben</option>
                            <option value="gerissen">Gerissen</option>
                            <option value="geschlachtet">Geschlachtet</option>
                            <option value="verloren">Verloren/Entlaufen</option>
                            <option value="anderer_betrieb">An anderen Betrieb abgegeben</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="deleteNotes" class="form-label">Zusätzliche Notizen</label>
                        <textarea class="form-control" id="deleteNotes" rows="2" placeholder="Optionale Details..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Schaf löschen</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let sheep = [];
        
        // Nächste Schafnummer generieren
        function getNextSheepNumber() {
            if (sheep.length === 0) return 1;
            
            // Finde die höchste Nummer (auch bei gelöschten Schafen)
            const maxNumber = Math.max(...sheep.map(s => s.number || 0));
            return maxNumber + 1;
        }

        // Daten aus localStorage laden
        function loadData() {
            const savedSheep = localStorage.getItem('sheep');
            
            if (savedSheep) {
                sheep = JSON.parse(savedSheep);
                
                // Für bestehende Schafe ohne Nummer: Nummern nachträglich vergeben
                let nextNum = 1;
                sheep.forEach(s => {
                    if (!s.number) {
                        s.number = nextNum++;
                    }
                });
                
                // Sortiere nach Nummer, um Lücken zu vermeiden
                sheep.sort((a, b) => (a.number || 0) - (b.number || 0));
                
                // Speichere die aktualisierten Daten
                saveData();
            }
        }

        // Daten in localStorage speichern
        function saveData() {
            localStorage.setItem('sheep', JSON.stringify(sheep));
        }

        // Schaf hinzufügen
        document.getElementById('sheepForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const birthDate = document.getElementById('birthDate').value;
            const today = new Date().toISOString().split('T')[0];
            
            if (birthDate > today) {
                alert('Das Geburtsdatum kann nicht in der Zukunft liegen!');
                return;
            }
            
            // Nächste laufende Nummer generieren
            const nextNumber = getNextSheepNumber();
            
            const newSheep = {
                id: Date.now().toString(),
                number: nextNumber,
                name: document.getElementById('sheepName').value || `Schaf #${nextNumber}`,
                birthDate: birthDate,
                earTag: document.getElementById('earTag').value,
                gender: document.getElementById('gender').value,
                motherSheepId: document.getElementById('motherSheep').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date().toISOString()
            };

            sheep.push(newSheep);
            saveData();
            displaySheep();
            updateMotherSheepDropdowns();
            checkAlerts();
            resetForm();
            
            // Zur Übersicht wechseln
            const overviewTab = new bootstrap.Tab(document.querySelector('[href="#overview"]'));
            overviewTab.show();
            
            alert('Schaf erfolgreich hinzugefügt!');
        });

        // Formular zurücksetzen
        function resetForm() {
            document.getElementById('sheepForm').reset();
        }

        // Schafe anzeigen
        function displaySheep() {
            const container = document.getElementById('sheepContainer');
            const sortBy = document.getElementById('sortSelect').value;
            const filterBy = document.getElementById('filterSelect').value;
            
            // Filtern
            let filteredSheep = [...sheep];
            switch(filterBy) {
                case 'active':
                    filteredSheep = sheep.filter(s => !s.deleted);
                    break;
                case 'deleted':
                    filteredSheep = sheep.filter(s => s.deleted);
                    break;
                case 'noEarTag':
                    filteredSheep = sheep.filter(s => !s.deleted && !s.earTag);
                    break;
                case 'withEarTag':
                    filteredSheep = sheep.filter(s => !s.deleted && s.earTag);
                    break;
                case 'needsEarTag':
                    filteredSheep = sheep.filter(s => {
                        const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                        return !s.deleted && !s.earTag && age.totalMonths >= 5;
                    });
                    break;
                case 'all':
                default:
                    filteredSheep = [...sheep];
                    break;
            }
            
            // Sortieren
            const sortedSheep = filteredSheep.sort((a, b) => {
                switch(sortBy) {
                    case 'number':
                        return (a.number || 0) - (b.number || 0);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'birthDate':
                        return new Date(b.birthDate) - new Date(a.birthDate);
                    case 'earTag':
                        return (a.earTag || '').localeCompare(b.earTag || '');
                    default:
                        return 0;
                }
            });

            container.innerHTML = '';
            
            if (sortedSheep.length === 0) {
                const filterBy = document.getElementById('filterSelect').value;
                let message = 'Noch keine Schafe registriert.';
                
                if (sheep.length > 0) {
                    switch(filterBy) {
                        case 'active':
                            message = 'Keine aktiven Schafe gefunden.';
                            break;
                        case 'deleted':
                            message = 'Keine gelöschten Schafe gefunden.';
                            break;
                        case 'noEarTag':
                            message = 'Keine aktiven Schafe ohne Ohrmarke gefunden.';
                            break;
                        case 'withEarTag':
                            message = 'Keine aktiven Schafe mit Ohrmarke gefunden.';
                            break;
                        case 'needsEarTag':
                            message = 'Keine aktiven Schafe gefunden, die eine Ohrmarke benötigen.';
                            break;
                    }
                }
                
                container.innerHTML = `<div class="col-12"><div class="alert alert-info">${message}</div></div>`;
                return;
            }

            sortedSheep.forEach(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                const motherName = s.motherSheepId ? (sheep.find(m => m.id === s.motherSheepId && !m.deleted)?.name || 'Unbekannt') : 'Keine';
                const needsEarTag = !s.earTag && age.months >= 5 && !s.deleted;
                
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-3';
                
                let cardContent = '';
                if (s.deleted) {
                    // Gelöschte Schafe
                    cardContent = `
                        <div class="card sheep-card" style="border-left: 4px solid #6c757d; opacity: 0.7;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">#${s.number || 'N/A'} - ${s.name} <span class="badge bg-secondary">Gelöscht</span></h5>
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-birthday-cake"></i> ${formatDate(s.birthDate)} (${age.display})<br>
                                        <i class="fas fa-tag"></i> ${s.earTag || 'Keine Ohrmarke'}<br>
                                        <i class="fas fa-venus-mars"></i> ${s.gender || 'Nicht angegeben'}<br>
                                        <i class="fas fa-heart"></i> Mutter: ${motherName}<br>
                                        <i class="fas fa-calendar-times"></i> Gelöscht: ${formatDate(s.deletedAt)}<br>
                                        <i class="fas fa-info-circle"></i> Grund: ${s.deleteReason}
                                    </small>
                                </p>
                                ${s.deleteNotes ? `<p class="card-text"><small><i class="fas fa-sticky-note"></i> ${s.deleteNotes}</small></p>` : ''}
                                <div class="d-flex action-buttons">
                                    <button class="btn btn-sm btn-outline-success" onclick="restoreSheep('${s.id}')">
                                        <i class="fas fa-undo"></i> Wiederherstellen
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="permanentDelete('${s.id}')">
                                        <i class="fas fa-trash-alt"></i> Endgültig löschen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Aktive Schafe - Farbkodierung für Ohrmarken-Status
                    let cardStyle = '';
                    let badgeContent = '';
                    
                    if (!s.earTag) {
                        if (age.totalMonths >= 5) {
                            // Über 5 Monate ohne Ohrmarke = ROT
                            cardStyle = 'border-left: 4px solid #dc3545; background-color: #fff5f5;';
                            badgeContent = '<span class="badge bg-danger">Ohrmarke erforderlich!</span>';
                        } else {
                            // Unter 5 Monate ohne Ohrmarke = GELB
                            cardStyle = 'border-left: 4px solid #ffc107; background-color: #fffbf0;';
                            badgeContent = '<span class="badge bg-warning text-dark">Noch keine Ohrmarke nötig</span>';
                        }
                    } else {
                        // Mit Ohrmarke = Standard grün
                        cardStyle = 'border-left: 4px solid #28a745;';
                    }
                    
                    cardContent = `
                        <div class="card sheep-card" style="${cardStyle}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">#${s.number || 'N/A'} - ${s.name}</h5>
                                    ${badgeContent}
                                </div>
                                <p class="card-text">
                                    <small class="text-muted">
                                        <i class="fas fa-birthday-cake"></i> ${formatDate(s.birthDate)} (${age.display})<br>
                                        <i class="fas fa-tag"></i> ${s.earTag || 'Keine Ohrmarke'}<br>
                                        <i class="fas fa-venus-mars"></i> ${s.gender || 'Nicht angegeben'}<br>
                                        <i class="fas fa-heart"></i> Mutter: ${motherName}
                                    </small>
                                </p>
                                ${s.notes ? `<p class="card-text"><small><i class="fas fa-sticky-note"></i> ${s.notes}</small></p>` : ''}
                                <div class="d-flex action-buttons">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editSheep('${s.id}')">
                                        <i class="fas fa-edit"></i> Bearbeiten
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSheep('${s.id}')">
                                        <i class="fas fa-trash"></i> Löschen
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                card.innerHTML = cardContent;
                container.appendChild(card);
            });
        }

        // Schafe filtern
        function filterSheep() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.sheep-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const parent = card.closest('.col-md-6');
                if (text.includes(searchTerm)) {
                    parent.style.display = '';
                } else {
                    parent.style.display = 'none';
                }
            });
        }

        // Schaf bearbeiten
        function editSheep(id) {
            const s = sheep.find(sheep => sheep.id === id);
            if (!s) return;

            document.getElementById('editSheepId').value = s.id;
            document.getElementById('editName').value = s.name;
            document.getElementById('editBirthDate').value = s.birthDate;
            document.getElementById('editEarTag').value = s.earTag || '';
            document.getElementById('editGender').value = s.gender || '';
            document.getElementById('editMotherSheep').value = s.motherSheepId || '';
            document.getElementById('editNotes').value = s.notes || '';

            updateMotherSheepDropdowns();
            
            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        // Bearbeitetes Schaf speichern
        function saveEditedSheep() {
            const id = document.getElementById('editSheepId').value;
            const sheepIndex = sheep.findIndex(s => s.id === id);
            
            if (sheepIndex === -1) return;
            
            const birthDate = document.getElementById('editBirthDate').value;
            const today = new Date().toISOString().split('T')[0];
            
            if (birthDate > today) {
                alert('Das Geburtsdatum kann nicht in der Zukunft liegen!');
                return;
            }

            const editedName = document.getElementById('editName').value || `Schaf #${sheep[sheepIndex].number}`;
            
            sheep[sheepIndex] = {
                ...sheep[sheepIndex],
                name: editedName,
                birthDate: birthDate,
                earTag: document.getElementById('editEarTag').value,
                gender: document.getElementById('editGender').value,
                motherSheepId: document.getElementById('editMotherSheep').value,
                notes: document.getElementById('editNotes').value
            };

            saveData();
            displaySheep();
            updateMotherSheepDropdowns();
            updateTreeSheepDropdown();
            checkAlerts();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
            
            alert('Schaf erfolgreich aktualisiert!');
        }

        // Schaf löschen vorbereiten
        function deleteSheep(id) {
            const s = sheep.find(sheep => sheep.id === id);
            if (!s) return;

            document.getElementById('deleteSheepId').value = s.id;
            document.getElementById('deleteSheepName').textContent = s.name;
            document.getElementById('deleteReason').value = '';
            document.getElementById('deleteNotes').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // Löschen bestätigen (Soft Delete)
        function confirmDelete() {
            const id = document.getElementById('deleteSheepId').value;
            const reason = document.getElementById('deleteReason').value;
            const notes = document.getElementById('deleteNotes').value;
            
            if (!reason) {
                alert('Bitte geben Sie einen Grund für das Löschen an.');
                return;
            }

            const sheepIndex = sheep.findIndex(s => s.id === id);
            if (sheepIndex === -1) return;

            // Schaf als gelöscht markieren statt es zu entfernen
            sheep[sheepIndex].deleted = true;
            sheep[sheepIndex].deletedAt = new Date().toISOString();
            sheep[sheepIndex].deleteReason = reason;
            sheep[sheepIndex].deleteNotes = notes;
            
            saveData();
            displaySheep();
            updateMotherSheepDropdowns();
            checkAlerts();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();
            
            alert('Schaf wurde als gelöscht markiert!');
        }

        // Endgültig löschen
        function permanentDelete(id) {
            const confirmPermanent = confirm('Sind Sie sicher, dass Sie dieses Schaf ENDGÜLTIG löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden!');
            
            if (!confirmPermanent) return;
            
            const sheepIndex = sheep.findIndex(s => s.id === id);
            if (sheepIndex === -1) return;
            
            sheep.splice(sheepIndex, 1);
            
            saveData();
            displaySheep();
            updateMotherSheepDropdowns();
            
            alert('Schaf wurde endgültig gelöscht!');
        }

        // Schaf wiederherstellen
        function restoreSheep(id) {
            const sheepIndex = sheep.findIndex(s => s.id === id);
            if (sheepIndex === -1) return;
            
            delete sheep[sheepIndex].deleted;
            delete sheep[sheepIndex].deletedAt;
            delete sheep[sheepIndex].deleteReason;
            delete sheep[sheepIndex].deleteNotes;
            
            saveData();
            displaySheep();
            updateMotherSheepDropdowns();
            checkAlerts();
            
            alert('Schaf wurde wiederhergestellt!');
        }

        // Alter berechnen
        function calculateAge(birthDate, endDate = null) {
            const birth = new Date(birthDate);
            const now = endDate ? new Date(endDate) : new Date();
            
            // Zeitdifferenz in Millisekunden
            const diffTime = now.getTime() - birth.getTime();
            const totalDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // Jahre, Monate und Tage berechnen
            let years = now.getFullYear() - birth.getFullYear();
            let months = now.getMonth() - birth.getMonth();
            let days = now.getDate() - birth.getDate();
            
            // Tage korrigieren
            if (days < 0) {
                months--;
                // Letzter Tag des Vormonats
                const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0);
                days += prevMonth.getDate();
            }
            
            // Monate korrigieren
            if (months < 0) {
                years--;
                months += 12;
            }
            
            const totalMonths = years * 12 + months;
            
            let display = '';
            if (years > 0) {
                display = `${years} Jahr${years !== 1 ? 'e' : ''}`;
                if (months > 0) display += `, ${months} Monat${months !== 1 ? 'e' : ''}`;
                if (days > 0) display += `, ${days} Tag${days !== 1 ? 'e' : ''}`;
            } else if (months > 0) {
                display = `${months} Monat${months !== 1 ? 'e' : ''}`;
                if (days > 0) display += `, ${days} Tag${days !== 1 ? 'e' : ''}`;
            } else {
                display = `${totalDays} Tag${totalDays !== 1 ? 'e' : ''}`;
            }
            
            return { years, months, days, totalMonths, totalDays, display };
        }

        // Datum formatieren
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('de-DE');
        }

        // Mutterschaf-Dropdowns aktualisieren
        function updateMotherSheepDropdowns() {
            const dropdowns = [
                document.getElementById('motherSheep'),
                document.getElementById('editMotherSheep')
            ];
            
            dropdowns.forEach(dropdown => {
                if (!dropdown) return;
                
                const currentValue = dropdown.value;
                dropdown.innerHTML = '<option value="">Kein Mutterschaf zuordnen</option>';
                
                // Nur aktive, weibliche Schafe als Mutterschafe anzeigen
                sheep.filter(s => s.gender === 'weiblich' && !s.deleted).forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.id;
                    option.textContent = `#${s.number || 'N/A'} - ${s.name} (${s.earTag || 'Keine Ohrmarke'})`;
                    dropdown.appendChild(option);
                });
                
                dropdown.value = currentValue;
            });
        }

        // Alerts für Ohrmarken prüfen
        function checkAlerts() {
            const alertsContainer = document.getElementById('alertsContainer');
            const alerts = [];
            
            // Nur aktive Schafe für Alerts berücksichtigen
            sheep.filter(s => !s.deleted).forEach(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                if (!s.earTag && age.totalMonths >= 5) {
                    const urgency = age.totalMonths >= 12 ? 'DRINGEND' : 'erforderlich';
                    alerts.push({
                        sheep: s,
                        age: age,
                        message: `${s.name} benötigt ${urgency} eine Ohrmarke (${age.display} alt)`,
                        urgent: age.totalMonths >= 12
                    });
                }
            });
            
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '<div class="alert alert-success mb-0"><i class="fas fa-check-circle"></i> Alle Schafe sind ordnungsgemäß mit Ohrmarken versehen!</div>';
            } else {
                let html = '';
                alerts.forEach(alert => {
                    const alertClass = alert.urgent ? 'alert-danger' : 'alert-warning';
                    const iconClass = alert.urgent ? 'fas fa-exclamation-circle' : 'fas fa-exclamation-triangle';
                    const buttonClass = alert.urgent ? 'btn-outline-danger' : 'btn-outline-warning';
                    
                    html += `
                        <div class="alert ${alertClass} mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="${iconClass}"></i> ${alert.message}</span>
                                <button class="btn btn-sm ${buttonClass}" onclick="editSheep('${alert.sheep.id}')">
                                    <i class="fas fa-tag"></i> Ohrmarke hinzufügen
                                </button>
                            </div>
                        </div>
                    `;
                });
                alertsContainer.innerHTML = html;
            }
        }

        // Daten exportieren
        function exportData() {
            const data = {
                sheep: sheep,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('.')[0];
            a.download = `schafverwaltung-backup-${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            alert('Backup erfolgreich heruntergeladen!');
        }

        // Daten importieren
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.sheep && Array.isArray(data.sheep)) {
                        const activeSheep = data.sheep.filter(s => !s.deleted).length;
                        const deletedSheep = data.sheep.filter(s => s.deleted).length;
                        const confirmImport = confirm(`Möchten Sie die Daten importieren? Dies wird ${activeSheep} aktive Schafe und ${deletedSheep} gelöschte Einträge laden. Ihre aktuellen Daten werden überschrieben!`);
                        
                        if (confirmImport) {
                            sheep = data.sheep;
                            saveData();
                            displaySheep();
                            updateMotherSheepDropdowns();
                            checkAlerts();
                            alert('Daten erfolgreich importiert!');
                        }
                    } else {
                        alert('Ungültiges Backup-Format!');
                    }
                } catch (error) {
                    alert('Fehler beim Laden der Datei: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Input zurücksetzen
            event.target.value = '';
        }

        // App initialisieren
        function initApp() {
            loadData();
            displaySheep();
            updateMotherSheepDropdowns();
            updateTreeSheepDropdown();
            checkAlerts();
        }

        // Backup-Erinnerung beim Schließen der Seite
        window.addEventListener('beforeunload', function(e) {
            if (sheep.length > 0) {
                const message = 'Vergessen Sie nicht, ein Backup Ihrer Schafverwaltung zu erstellen, bevor Sie die Seite verlassen!';
                e.returnValue = message;
                return message;
            }
        });

        // Aktueller Statistikzeitraum und -modus
        let currentStatsPeriod = 'all';
        let currentStatsMode = 'all'; // 'all' = geboren im Zeitraum, 'active' = aktueller Bestand
        let customDateFrom = null;
        let customDateTo = null;

        // Stammbaum-Variablen
        let currentTreeViewMode = 'ancestors'; // 'ancestors', 'descendants', 'full'
        let selectedSheepForTree = null;

        // Statistik-Modus setzen
        function setStatsMode(mode) {
            currentStatsMode = mode;
            
            // Button-Status aktualisieren
            document.getElementById('statsModeAll').classList.remove('active');
            document.getElementById('statsModeActive').classList.remove('active');
            document.getElementById('statsMode' + (mode === 'all' ? 'All' : 'Active')).classList.add('active');
            
            updateStatistics();
        }

        // Zeitraum für Statistiken setzen
        function setStatsPeriod(period) {
            currentStatsPeriod = period;
            customDateFrom = null;
            customDateTo = null;
            
            // Button-Status aktualisieren - nur für Zeitraum-Buttons
            const parentGroup = event.target.closest('.btn-group');
            parentGroup.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            updateStatistics();
        }

        // Benutzerdefinierter Zeitraum
        function setStatsCustomRange() {
            const fromDate = document.getElementById('statsDateFrom').value;
            const toDate = document.getElementById('statsDateTo').value;
            
            if (!fromDate || !toDate) {
                alert('Bitte wählen Sie sowohl Start- als auch Enddatum aus.');
                return;
            }
            
            if (fromDate > toDate) {
                alert('Das Startdatum muss vor dem Enddatum liegen.');
                return;
            }
            
            currentStatsPeriod = 'custom';
            customDateFrom = new Date(fromDate);
            customDateTo = new Date(toDate);
            
            // Nur Zeitraum-Button-Status zurücksetzen
            document.querySelectorAll('.btn-group .btn-outline-primary').forEach(btn => btn.classList.remove('active'));
            
            updateStatistics();
        }

        // Filtere Schafe nach Zeitraum
        function filterSheepByPeriod(sheepArray, useCreatedDate = false) {
            const now = new Date();
            let startDate, endDate;
            
            switch(currentStatsPeriod) {
                case 'week':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - now.getDay()); // Montag der aktuellen Woche
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case '30days':
                    startDate = new Date(now);
                    startDate.setDate(now.getDate() - 30);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(now);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1);
                    endDate = new Date(now.getFullYear(), 11, 31);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'custom':
                    startDate = new Date(customDateFrom);
                    startDate.setHours(0, 0, 0, 0);
                    endDate = new Date(customDateTo);
                    endDate.setHours(23, 59, 59, 999);
                    break;
                    
                case 'all':
                default:
                    return sheepArray;
            }
            
            return sheepArray.filter(s => {
                const dateToCheck = useCreatedDate ? new Date(s.createdAt || s.birthDate) : new Date(s.birthDate);
                return dateToCheck >= startDate && dateToCheck <= endDate;
            });
        }

        // Zeitraum-Label aktualisieren
        function updatePeriodLabel() {
            const now = new Date();
            let label = '';
            
            switch(currentStatsPeriod) {
                case 'week':
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(startOfWeek.getDate() + 6);
                    label = `${formatDate(startOfWeek.toISOString())} - ${formatDate(endOfWeek.toISOString())}`;
                    break;
                case 'month':
                    label = now.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                    break;
                case '30days':
                    const thirtyDaysAgo = new Date(now);
                    thirtyDaysAgo.setDate(now.getDate() - 30);
                    label = `${formatDate(thirtyDaysAgo.toISOString())} - ${formatDate(now.toISOString())}`;
                    break;
                case 'year':
                    label = now.getFullYear().toString();
                    break;
                case 'custom':
                    label = `${formatDate(customDateFrom.toISOString())} - ${formatDate(customDateTo.toISOString())}`;
                    break;
                case 'all':
                default:
                    label = 'Gesamte Zeit';
                    break;
            }
            
            document.getElementById('currentStatsPeriod').textContent = label;
            document.getElementById('birthsPeriodLabel').textContent = `(${label})`;
            
            // Labels für Karten aktualisieren
            if (currentStatsMode === 'all') {
                document.getElementById('statTotalLabel').textContent = 'Alle (inkl. gelöschte)';
                document.getElementById('statDeletedLabel').textContent = 'Davon gelöscht';
            } else {
                document.getElementById('statTotalLabel').textContent = 'Aktueller Bestand';
                document.getElementById('statDeletedLabel').textContent = 'Gelöschte (0)';
            }
        }

        // Statistiken aktualisieren
        function updateStatistics() {
            updatePeriodLabel();
            
            let statsActiveSheep, statsDeletedSheep, allStatsSheep;
            
            if (currentStatsMode === 'all') {
                // "Geboren im Zeitraum" - ALLE Schafe die im Zeitraum geboren wurden (aktive + gelöschte)
                const activeSheep = sheep.filter(s => !s.deleted);
                const deletedSheep = sheep.filter(s => s.deleted);
                
                statsActiveSheep = filterSheepByPeriod(activeSheep);
                statsDeletedSheep = filterSheepByPeriod(deletedSheep);
                allStatsSheep = [...statsActiveSheep, ...statsDeletedSheep]; // Alle Schafe des Zeitraums
            } else {
                // "Aktueller Bestand" - nur aktuell aktive Schafe, gefiltert nach Geburtsdatum
                const activeSheep = sheep.filter(s => !s.deleted);
                
                statsActiveSheep = filterSheepByPeriod(activeSheep);
                statsDeletedSheep = []; // Keine gelöschten im aktuellen Bestand
                allStatsSheep = statsActiveSheep; // Nur aktive Schafe
            }
            
            // Grundzahlen - basierend auf allStatsSheep (alle relevanten Schafe des Modus)
            document.getElementById('statTotalSheep').textContent = allStatsSheep.length;
            document.getElementById('statWithEarTags').textContent = allStatsSheep.filter(s => s.earTag).length;
            document.getElementById('statDeleted').textContent = statsDeletedSheep.length;
            
            const needEarTags = allStatsSheep.filter(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                return !s.deleted && !s.earTag && age.totalMonths >= 5; // Nur nicht-gelöschte brauchen Ohrmarken
            });
            document.getElementById('statNeedEarTags').textContent = needEarTags.length;
            
            // Geschlechterverteilung - basierend auf allen relevanten Schafen
            const females = allStatsSheep.filter(s => s.gender === 'weiblich').length;
            const males = allStatsSheep.filter(s => s.gender === 'männlich').length;
            const unknown = allStatsSheep.filter(s => !s.gender || s.gender === '').length;
            const total = allStatsSheep.length || 1; // Vermeide Division durch 0
            
            document.getElementById('statFemaleCount').textContent = females;
            document.getElementById('statMaleCount').textContent = males;
            document.getElementById('statUnknownCount').textContent = unknown;
            
            document.getElementById('statFemaleBar').style.width = `${(females / total) * 100}%`;
            document.getElementById('statMaleBar').style.width = `${(males / total) * 100}%`;
            document.getElementById('statUnknownBar').style.width = `${(unknown / total) * 100}%`;
            
            // Altersverteilung - basierend auf allen relevanten Schafen
            const lambs = allStatsSheep.filter(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                return age.totalMonths < 5;
            }).length;
            
            const young = allStatsSheep.filter(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                return age.totalMonths >= 5 && age.totalMonths < 12;
            }).length;
            
            const adults = allStatsSheep.filter(s => {
                const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                return age.totalMonths >= 12;
            }).length;
            
            document.getElementById('statLambs').textContent = lambs;
            document.getElementById('statYoung').textContent = young;
            document.getElementById('statAdults').textContent = adults;
            
            document.getElementById('statLambsBar').style.width = `${(lambs / total) * 100}%`;
            document.getElementById('statYoungBar').style.width = `${(young / total) * 100}%`;
            document.getElementById('statAdultsBar').style.width = `${(adults / total) * 100}%`;
            
            // Geborene Schafe = alle Schafe des gewählten Modus und Zeitraums
            const recentBirths = allStatsSheep;
            
            const recentBirthsContainer = document.getElementById('recentBirths');
            if (recentBirths.length === 0) {
                const modeText = currentStatsMode === 'all' ? 'im gewählten Zeitraum geboren' : 'im aktuellen Bestand';
                recentBirthsContainer.innerHTML = `<p class="text-muted">Keine Schafe ${modeText}.</p>`;
            } else {
                recentBirthsContainer.innerHTML = recentBirths.map(s => {
                    const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
                    const status = s.deleted ? ' (gelöscht)' : '';
                    return `<div class="mb-1"><strong>#${s.number || 'N/A'} - ${s.name}${status}</strong> - ${formatDate(s.birthDate)} (${age.display})</div>`;
                }).join('');
            }
            
            // Mütter mit Nachwuchs - basierend auf allen relevanten Schafen
            const mothers = allStatsSheep.filter(s => s.gender === 'weiblich');
            const mothersWithChildren = mothers.filter(mother => {
                return allStatsSheep.some(child => child.motherSheepId === mother.id);
            });
            
            const mothersContainer = document.getElementById('mothersWithChildren');
            if (mothersWithChildren.length === 0) {
                mothersContainer.innerHTML = '<p class="text-muted">Keine Muttertiere mit registriertem Nachwuchs.</p>';
            } else {
                mothersContainer.innerHTML = mothersWithChildren.map(mother => {
                    const children = allStatsSheep.filter(s => s.motherSheepId === mother.id);
                    return `<div class="mb-2">
                        <strong>#${mother.number || 'N/A'} - ${mother.name}${mother.deleted ? ' (gelöscht)' : ''}</strong> 
                        <small class="text-muted">(${children.length} ${children.length === 1 ? 'Kind' : 'Kinder'})</small>
                        <br><small>${children.map(c => `#${c.number || 'N/A'} - ${c.name}` + (c.deleted ? ' (gelöscht)' : '')).join(', ')}</small>
                    </div>`;
                }).join('');
            }
            
            // Löschungsstatistiken - basierend auf Geburtsdatum der gelöschten Schafe
            const deletionReasons = {};
            statsDeletedSheep.forEach(s => {
                if (s.deleteReason) {
                    deletionReasons[s.deleteReason] = (deletionReasons[s.deleteReason] || 0) + 1;
                }
            });
            
            const deletionStatsContainer = document.getElementById('deletionStats');
            if (Object.keys(deletionReasons).length === 0) {
                deletionStatsContainer.innerHTML = '<div class="col-12"><p class="text-muted">Keine Löschungen dokumentiert.</p></div>';
            } else {
                const reasonLabels = {
                    'verkauft': 'Verkauft',
                    'verstorben': 'Verstorben',
                    'gerissen': 'Gerissen',
                    'geschlachtet': 'Geschlachtet',
                    'verloren': 'Verloren/Entlaufen',
                    'anderer_betrieb': 'Anderer Betrieb',
                    'sonstiges': 'Sonstiges'
                };
                
                deletionStatsContainer.innerHTML = Object.entries(deletionReasons).map(([reason, count]) => {
                    const label = reasonLabels[reason] || reason;
                    return `
                        <div class="col-md-6 mb-2">
                            <div class="card text-center">
                                <div class="card-body py-2">
                                    <h5 class="card-title mb-1">${count}</h5>
                                    <p class="card-text small mb-0">${label}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Lammverluste nach Mutterschaf
            const lambLossStatsContainer = document.getElementById('lambLossStats');
            
            // Finde alle verstorbenen Lämmer (≤ 3 Monate alt bei Tod, gelöscht mit Grund "verstorben")
            const deadLambs = statsDeletedSheep.filter(s => {
                if (s.deleteReason !== 'verstorben') return false;
                const ageAtDeath = calculateAge(s.birthDate, s.deletedAt);
                return ageAtDeath.totalMonths <= 3;
            });
            
            // Gruppiere nach Mutterschaf
            const motherLossStats = {};
            deadLambs.forEach(lamb => {
                if (lamb.motherSheepId) {
                    const mother = sheep.find(m => m.id === lamb.motherSheepId);
                    if (mother) {
                        const motherKey = mother.id;
                        if (!motherLossStats[motherKey]) {
                            motherLossStats[motherKey] = {
                                mother: mother,
                                deadLambs: [],
                                totalLambs: 0
                            };
                        }
                        motherLossStats[motherKey].deadLambs.push(lamb);
                    }
                }
            });
            
            // Berechne Gesamtzahl der Lämmer pro Mutter
            Object.keys(motherLossStats).forEach(motherId => {
                const totalLambs = sheep.filter(s => s.motherSheepId === motherId).length;
                motherLossStats[motherId].totalLambs = totalLambs;
            });
            
            // Sortiere nach Anzahl verstorbener Lämmer (absteigend)
            const sortedMothers = Object.values(motherLossStats).sort((a, b) => b.deadLambs.length - a.deadLambs.length);
            
            if (sortedMothers.length === 0) {
                lambLossStatsContainer.innerHTML = '<p class="text-muted">Keine Lammverluste dokumentiert (Lämmer ≤3 Monate, verstorben).</p>';
            } else {
                lambLossStatsContainer.innerHTML = `
                    <div class="mb-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Zeigt Mutterschafe mit verstorbenen Lämmern (≤3 Monate alt bei Tod)
                        </small>
                    </div>
                    ${sortedMothers.map(stat => {
                        const lossRate = ((stat.deadLambs.length / stat.totalLambs) * 100).toFixed(1);
                        const statusClass = stat.mother.deleted ? ' (gelöscht)' : '';
                        
                        return `
                            <div class="mb-3 p-2 border rounded ${stat.deadLambs.length >= 3 ? 'border-danger bg-light' : stat.deadLambs.length >= 2 ? 'border-warning' : 'border-secondary'}">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <strong>#${stat.mother.number || 'N/A'} - ${stat.mother.name}${statusClass}</strong>
                                    <span class="badge ${stat.deadLambs.length >= 3 ? 'bg-danger' : stat.deadLambs.length >= 2 ? 'bg-warning' : 'bg-secondary'}">
                                        ${stat.deadLambs.length} von ${stat.totalLambs} Lämmern (${lossRate}%)
                                    </span>
                                </div>
                                <div class="small text-muted">
                                    <div class="mb-1">
                                        <i class="fas fa-skull-crossbones"></i> Verstorbene Lämmer: 
                                        ${stat.deadLambs.map(lamb => {
                                            const ageAtDeath = calculateAge(lamb.birthDate, lamb.deletedAt);
                                            return `💀 #${lamb.number || 'N/A'} - ${lamb.name} (${ageAtDeath.display} alt)`;
                                        }).join(', ')}
                                    </div>
                                    <div>
                                        <i class="fas fa-tag"></i> Ohrmarke: ${stat.mother.earTag || 'Keine'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                `;
            }
        }

        // Stammbaum-Ansichtsmodus setzen
        function setTreeViewMode(mode) {
            currentTreeViewMode = mode;
            
            // Button-Status aktualisieren
            document.querySelectorAll('.tree-controls .btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            generateFamilyTree();
        }

        // Stammbaum-Dropdown aktualisieren
        function updateTreeSheepDropdown() {
            const dropdown = document.getElementById('treeSheepSelect');
            if (!dropdown) return;
            
            const currentValue = dropdown.value;
            dropdown.innerHTML = '<option value="">Schaf für Stammbaum auswählen...</option>';
            
            // Nur aktive Schafe für Stammbaum (es sei denn, gelöschte sind aktiviert)
            const showDeleted = document.getElementById('showDeletedInTree')?.checked || false;
            const sheepToShow = showDeleted ? sheep : sheep.filter(s => !s.deleted);
            
            sheepToShow.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = `#${s.number || 'N/A'} - ${s.name}${s.deleted ? ' (gelöscht)' : ''}`;
                dropdown.appendChild(option);
            });
            
            dropdown.value = currentValue;
        }

        // Vorfahren eines Schafs finden
        function findAncestors(sheepId, generations = 3) {
            const visited = new Set();
            const ancestors = [];
            
            function findParents(id, generation) {
                if (generation > generations || visited.has(id)) return;
                visited.add(id);
                
                const currentSheep = sheep.find(s => s.id === id);
                if (!currentSheep) return;
                
                if (currentSheep.motherSheepId) {
                    const mother = sheep.find(s => s.id === currentSheep.motherSheepId);
                    if (mother) {
                        ancestors.push({sheep: mother, generation: generation, relation: 'mother'});
                        findParents(mother.id, generation + 1);
                    }
                }
            }
            
            findParents(sheepId, 1);
            return ancestors;
        }

        // Nachkommen eines Schafs finden
        function findDescendants(sheepId, generations = 3) {
            const visited = new Set();
            const descendants = [];
            
            function findChildren(id, generation) {
                if (generation > generations || visited.has(id)) return;
                visited.add(id);
                
                const children = sheep.filter(s => s.motherSheepId === id);
                children.forEach(child => {
                    descendants.push({sheep: child, generation: generation, relation: 'child'});
                    findChildren(child.id, generation + 1);
                });
            }
            
            findChildren(sheepId, 1);
            return descendants;
        }

        // Stammbaum-Knoten erstellen
        function createTreeNode(s, isSelected = false) {
            const age = calculateAge(s.birthDate, s.deleted ? s.deletedAt : null);
            const node = document.createElement('div');
            
            let classes = 'tree-node';
            if (s.gender === 'weiblich') classes += ' female';
            else if (s.gender === 'männlich') classes += ' male';
            if (s.deleted) classes += ' deleted';
            if (isSelected) classes += ' selected';
            
            node.className = classes;
            node.onclick = () => selectSheepForTree(s.id);
            
            node.innerHTML = `
                <div class="tree-node-name">#${s.number || 'N/A'} - ${s.name}</div>
                <div class="tree-node-info">
                    ${formatDate(s.birthDate)}<br>
                    ${age.display}<br>
                    ${s.earTag || 'Keine Ohrmarke'}
                </div>
            `;
            
            return node;
        }

        // Schaf für Stammbaum auswählen
        function selectSheepForTree(sheepId) {
            document.getElementById('treeSheepSelect').value = sheepId;
            generateFamilyTree();
        }

        // Stammbaum generieren
        function generateFamilyTree() {
            const container = document.getElementById('familyTreeContainer');
            const sheepId = document.getElementById('treeSheepSelect').value;
            const showDeleted = document.getElementById('showDeletedInTree')?.checked || false;
            
            updateTreeSheepDropdown();
            
            if (!sheepId) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Wählen Sie ein Schaf aus der Dropdown-Liste aus, um dessen Stammbaum anzuzeigen.
                    </div>
                `;
                return;
            }
            
            const selectedSheep = sheep.find(s => s.id === sheepId);
            if (!selectedSheep) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Ausgewähltes Schaf wurde nicht gefunden.
                    </div>
                `;
                return;
            }
            
            // Filter für gelöschte Schafe anwenden
            const filteredSheep = showDeleted ? sheep : sheep.filter(s => !s.deleted);
            
            container.innerHTML = '';
            
            if (currentTreeViewMode === 'ancestors' || currentTreeViewMode === 'full') {
                // Vorfahren anzeigen
                const ancestors = findAncestors(sheepId, 3);
                const ancestorsByGeneration = {};
                
                ancestors.forEach(a => {
                    if (showDeleted || !a.sheep.deleted) {
                        if (!ancestorsByGeneration[a.generation]) {
                            ancestorsByGeneration[a.generation] = [];
                        }
                        ancestorsByGeneration[a.generation].push(a.sheep);
                    }
                });
                
                // Generationen von höchster zu niedrigster anzeigen
                const maxGeneration = Math.max(...Object.keys(ancestorsByGeneration).map(Number), 0);
                for (let gen = maxGeneration; gen >= 1; gen--) {
                    if (ancestorsByGeneration[gen]) {
                        const level = document.createElement('div');
                        level.className = 'tree-level';
                        level.innerHTML = `<h6 class="w-100 text-center text-muted">Generation -${gen}</h6>`;
                        
                        ancestorsByGeneration[gen].forEach(ancestor => {
                            level.appendChild(createTreeNode(ancestor));
                        });
                        
                        container.appendChild(level);
                        
                        if (gen > 1) {
                            const connector = document.createElement('div');
                            connector.className = 'tree-connector';
                            container.appendChild(connector);
                        }
                    }
                }
                
                if (maxGeneration > 0) {
                    const connector = document.createElement('div');
                    connector.className = 'tree-connector';
                    container.appendChild(connector);
                }
            }
            
            // Ausgewähltes Schaf anzeigen
            const centerLevel = document.createElement('div');
            centerLevel.className = 'tree-level';
            centerLevel.innerHTML = `<h6 class="w-100 text-center text-primary">Ausgewähltes Schaf</h6>`;
            centerLevel.appendChild(createTreeNode(selectedSheep, true));
            container.appendChild(centerLevel);
            
            if (currentTreeViewMode === 'descendants' || currentTreeViewMode === 'full') {
                // Nachkommen anzeigen
                const descendants = findDescendants(sheepId, 3);
                const descendantsByGeneration = {};
                
                descendants.forEach(d => {
                    if (showDeleted || !d.sheep.deleted) {
                        if (!descendantsByGeneration[d.generation]) {
                            descendantsByGeneration[d.generation] = [];
                        }
                        descendantsByGeneration[d.generation].push(d.sheep);
                    }
                });
                
                // Generationen von niedrigster zu höchster anzeigen
                const maxGeneration = Math.max(...Object.keys(descendantsByGeneration).map(Number), 0);
                for (let gen = 1; gen <= maxGeneration; gen++) {
                    if (descendantsByGeneration[gen]) {
                        const connector = document.createElement('div');
                        connector.className = 'tree-connector';
                        container.appendChild(connector);
                        
                        const level = document.createElement('div');
                        level.className = 'tree-level';
                        level.innerHTML = `<h6 class="w-100 text-center text-muted">Generation +${gen}</h6>`;
                        
                        descendantsByGeneration[gen].forEach(descendant => {
                            level.appendChild(createTreeNode(descendant));
                        });
                        
                        container.appendChild(level);
                    }
                }
            }
            
            // Statistiken anzeigen
            if (currentTreeViewMode === 'full') {
                const ancestors = findAncestors(sheepId, 10);
                const descendants = findDescendants(sheepId, 10);
                const totalFamily = ancestors.length + descendants.length + 1;
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'alert alert-success mt-3';
                statsDiv.innerHTML = `
                    <h6><i class="fas fa-chart-pie"></i> Familien-Statistiken</h6>
                    <div class="row">
                        <div class="col-md-4">Vorfahren: ${ancestors.length}</div>
                        <div class="col-md-4">Nachkommen: ${descendants.length}</div>
                        <div class="col-md-4">Gesamte Familie: ${totalFamily}</div>
                    </div>
                `;
                container.appendChild(statsDiv);
            }
            
            // Falls keine Verwandten gefunden wurden
            if (container.children.length === 1) { // Nur das ausgewählte Schaf
                const noRelativesDiv = document.createElement('div');
                noRelativesDiv.className = 'alert alert-info mt-3';
                noRelativesDiv.innerHTML = `
                    <i class="fas fa-info-circle"></i> Keine Familienbeziehungen für dieses Schaf gefunden.
                `;
                container.appendChild(noRelativesDiv);
            }
        }

        // App starten
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>