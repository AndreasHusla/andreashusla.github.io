<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè® Hotel Verwaltung - Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --orange: #f97316;
            --danger: #ef4444;
            --info: #06b6d4;
            --light: #f8fafc;
            --dark: #0f172a;
            --gray-50: #f8fafc;
            --gray-100: #f1f5f9;
            --gray-200: #e2e8f0;
            --gray-300: #cbd5e1;
            --gray-400: #94a3b8;
            --gray-500: #64748b;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1e293b;
            --gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius-sm: 0.375rem;
            --radius: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            --radius-xl: 1.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--gray-700);
            line-height: 1.6;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 1.5rem auto;
            background: white; 
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white; 
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="%23ffffff" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
            pointer-events: none;
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header-logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        #hotel-logo {
            max-height: 80px;
            max-width: 250px;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease;
        }
        
        .header-text {
            flex: 1;
        }
        
        .header h1 { 
            font-size: 3rem; 
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header p { 
            font-size: 1.2rem; 
            font-weight: 300;
            opacity: 0.9;
        }
        
        .nav-tabs { 
            display: flex;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .nav-tabs::-webkit-scrollbar {
            display: none;
        }
        
        .nav-tab { 
            flex: 1;
            min-width: fit-content;
            padding: 1rem 1.5rem;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-600);
            transition: all 0.2s ease;
            position: relative;
            white-space: nowrap;
        }
        
        .nav-tab:hover { 
            color: var(--primary);
            background: var(--gray-100);
        }
        
        .nav-tab.active { 
            color: var(--primary);
            background: white;
            font-weight: 600;
        }
        
        .nav-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: var(--radius) var(--radius) 0 0;
        }
        
        .content { 
            padding: 2rem;
            min-height: 600px;
            background: var(--gray-50);
        }
        
        .tab-pane { 
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-pane.active { 
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card { 
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            font-weight: 500;
            margin-top: 0.25rem;
        }
        
        /* Form Styles */
        .form-section {
            background: white;
            padding: 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
            margin-bottom: 1.5rem;
        }
        
        .form-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group { 
            margin-bottom: 1.5rem;
        }
        
        .form-group label { 
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-700);
            font-size: 0.875rem;
        }
        
        .form-control, .form-select { 
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 400;
            background: white;
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus { 
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1;
            white-space: nowrap;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-info {
            background: #0ea5e9;
            color: white;
        }
        
        .btn-info:hover {
            background: #0284c7;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-tertiary {
            background: #7c3aed;
            color: white;
        }
        
        .btn-tertiary:hover {
            background: #6d28d9;
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-outline {
            background: white;
            border: 2px solid var(--gray-200);
            color: var(--gray-700);
        }
        
        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Button Sizes */
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-xs {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            gap: 0.25rem;
        }
        
        /* Room Grid */
        .room-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-200);
        }
        
        .room-header h2 {
            color: var(--primary);
            margin-bottom: 0.5rem;
            font-size: 1.75rem;
        }
        
        .room-header p {
            margin: 0;
            font-size: 1rem;
        }
        
        .room-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        /* Booking Filters */
        .booking-filters {
            margin-bottom: 2rem;
        }
        
        .filter-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            background: var(--gray-50);
        }
        
        .filter-group h3 {
            margin: 0 0 1rem 0;
            color: var(--gray-700);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .filter-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .room-grid { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 0.75rem;
        }
        
        .room-card { 
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .room-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        
        .room-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .room-frei {
            border-color: var(--success);
        }
        
        .room-frei::before {
            background: var(--success);
        }
        
        .room-belegt {
            border-color: var(--danger);
        }
        
        .room-belegt::before {
            background: var(--danger);
        }
        
        .room-reserviert {
            border-color: var(--warning);
        }
        
        .room-reserviert::before {
            background: var(--warning);
        }
        
        .room-wartung {
            border-color: var(--primary);
        }
        
        .room-wartung::before {
            background: var(--primary);
        }
        
        .room-checkin {
            border-color: var(--info);
        }
        
        .room-checkin::before {
            background: var(--info);
        }
        
        .room-checkout {
            border-color: var(--orange);
        }
        
        .room-checkout::before {
            background: var(--orange);
        }
        
        .room-number {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--gray-900);
        }

        .room-name {
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 0.25rem;
            font-weight: 600;
            font-style: italic;
        }
        
        .room-type {
            font-size: 0.75rem;
            color: var(--gray-600);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .room-status {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .status-frei {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-belegt {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .status-reserviert {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-wartung {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }
        
        .status-checkin {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }
        
        .status-checkout {
            background: rgba(249, 115, 22, 0.1);
            color: var(--orange);
        }
        
        .status-belegt_abgeschlossen {
            background: rgba(156, 163, 175, 0.15);
            color: #6b7280;
            font-style: italic;
        }
        
        .status-checkin_completed {
            background: rgba(156, 163, 175, 0.15);
            color: #6b7280;
            border-left: 3px solid #06b6d4;
        }
        
        .status-checkout_completed {
            background: rgba(156, 163, 175, 0.15);
            color: #6b7280;
            border-left: 3px solid #f97316;
        }
        
        .status-checkout_checkin_completed {
            background: rgba(156, 163, 175, 0.15);
            color: #6b7280;
            border-left: 3px solid #6b7280;
        }
        
        .room-guest {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.5rem;
        }
        
        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }
        
        th {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        td {
            font-size: 0.875rem;
        }
        
        tr:hover {
            background: var(--gray-50);
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .badge-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }
        
        .badge-primary {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease;
        }
        
        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 0;
            border-radius: var(--radius-xl);
            width: 95%;
            max-width: 600px;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
        }
        
        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius);
            transition: all 0.2s ease;
        }
        
        .close:hover {
            color: var(--gray-600);
            background: var(--gray-200);
        }
        
        /* Alert System */
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }
        
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            border-left: 4px solid;
            box-shadow: var(--shadow-md);
            background: white;
            animation: slideInRight 0.3s ease;
            font-size: 0.875rem;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .alert-success {
            border-left-color: var(--success);
            color: var(--gray-700);
        }
        
        .alert-success::before {
            content: '‚úÖ ';
            color: var(--success);
            font-weight: bold;
        }
        
        .alert-danger {
            border-left-color: var(--danger);
            color: var(--gray-700);
        }
        
        .alert-danger::before {
            content: '‚ùå ';
            color: var(--danger);
            font-weight: bold;
        }
        
        .alert-warning {
            border-left-color: var(--warning);
            color: var(--gray-700);
        }
        
        .alert-warning::before {
            content: '‚ö†Ô∏è ';
            color: var(--warning);
            font-weight: bold;
        }
        
        .alert-info {
            border-left-color: var(--info);
            color: var(--gray-700);
        }
        
        .alert-info::before {
            content: '‚ÑπÔ∏è ';
            color: var(--info);
            font-weight: bold;
        }
        
        /* Calendar */
        .calendar-container {
            background: white;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }
        
        .calendar-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .room-header, .day-header {
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            padding: 0.4rem;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        .day-header .day-number {
            font-size: 0.75rem;
            font-weight: 700;
            line-height: 1;
        }

        .day-header .day-name {
            font-size: 0.6rem;
            font-weight: 500;
            color: var(--gray-600);
            margin-top: 0.125rem;
            line-height: 1;
        }

        .room-cell {
            background: var(--gray-50);
            border: 1px solid var(--gray-300);
            padding: 0.3rem;
            text-align: center;
            font-weight: 600;
            position: sticky;
            left: 0;
            z-index: 5;
            font-size: 0.75rem;
            width: 70px; /* Erweitert f√ºr Zimmernamen */
        }

        .room-cell .room-number {
            font-weight: 700;
            font-size: 0.75rem;
        }

        .room-cell .room-name-small {
            font-size: 0.65rem;
            color: var(--primary);
            font-weight: 500;
            font-style: italic;
            margin-top: 1px;
            line-height: 1.1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .day-cell {
            border: 1px solid var(--gray-300);
            width: 28px;
            height: 28px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
            padding: 2px;
            min-width: 28px;
            max-width: 28px;
        }

        .day-cell:hover {
            background: var(--gray-100);
        }

        .day-cell.today {
            border: 2px solid var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .day-cell.weekend {
            background: rgba(239, 246, 255, 0.7);
        }
        
        .day-header.weekend {
            background: rgba(239, 246, 255, 0.8);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        /* Wochenend-Styling f√ºr verschiedene Status */
        .day-cell.weekend.status-frei {
            background: linear-gradient(135deg, var(--success) 0%, rgba(34, 197, 94, 0.9) 100%);
            border: 1px solid rgba(239, 246, 255, 0.3);
        }
        
        .day-cell.weekend.status-belegt {
            background: linear-gradient(135deg, var(--danger) 0%, rgba(239, 68, 68, 0.9) 100%);
            border: 1px solid rgba(239, 246, 255, 0.3);
        }
        
        .day-cell.weekend.status-reserviert {
            background: linear-gradient(135deg, var(--warning) 0%, rgba(245, 158, 11, 0.9) 100%);
            border: 1px solid rgba(239, 246, 255, 0.3);
        }

        .day-cell.status-frei {
            background: var(--success);
            color: white;
        }

        .day-cell.status-belegt {
            background: var(--danger);
            color: white;
        }

        .day-cell.status-reserviert {
            background: var(--warning);
            color: white;
        }

        .day-cell.status-wartung {
            background: var(--primary);
            color: white;
        }

        .day-cell.status-checkin {
            background: var(--info);
            color: white;
        }

        .day-cell.status-checkout {
            background: var(--orange);
            color: white;
        }

        .day-cell.status-checkout_checkin {
            background: linear-gradient(90deg, var(--orange) 50%, var(--info) 50%);
            color: white;
        }
        
        .day-cell.status-belegt_abgeschlossen {
            background: #9ca3af;
            color: white;
            opacity: 0.7;
        }
        
        .day-cell.status-checkin_completed {
            background: #9ca3af;
            color: white;
            opacity: 0.7;
            border-left: 4px solid var(--info);
        }
        
        .day-cell.status-checkout_completed {
            background: #9ca3af;
            color: white;
            opacity: 0.7;
            border-left: 4px solid var(--orange);
        }
        
        .day-cell.status-checkout_checkin_completed {
            background: linear-gradient(90deg, #9ca3af 50%, #9ca3af 50%);
            color: white;
            opacity: 0.7;
            border-left: 4px solid #6b7280;
        }
        
        /* Invoice Editor Styles */
        .invoice-items-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .invoice-items-header {
            display: grid;
            grid-template-columns: 60px 1fr 80px 120px 90px 120px 80px;
            gap: 10px;
            background: var(--primary);
            color: white;
            padding: 12px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .invoice-item {
            display: grid;
            grid-template-columns: 60px 1fr 80px 120px 90px 120px 80px;
            gap: 10px;
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            align-items: center;
        }
        
        .invoice-item:last-child {
            border-bottom: none;
        }
        
        .invoice-item input, .invoice-item textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .invoice-item .item-total {
            font-weight: 600;
            color: var(--primary);
        }
        
        .invoice-totals {
            margin-top: 20px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .total-final {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 2px solid var(--primary);
            padding-top: 15px;
            margin-top: 15px;
        }
        
        .company-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .company-preview h4 {
            margin: 0 0 10px 0;
            color: var(--primary);
        }
        
        .company-preview p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #64748b;
        }
        
        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            font-size: 0.875rem;
            width: 100%;
            max-width: 400px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            font-size: 0.875rem;
        }
        
        /* Important Events */
        .events-container {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-200);
        }
        
        .event-item {
            padding: 1rem;
            border-left: 4px solid var(--primary);
            background: var(--gray-50);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
        }
        
        .event-item:last-child {
            margin-bottom: 0;
        }
        
        .event-date {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        
        .event-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-top: 0.25rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                margin: 1rem;
            }
            
            .content {
                padding: 1.5rem;
            }
            
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.75rem;
            }
            
            .content {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .room-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                margin: 10% auto;
            }
            
            .room-filters {
                flex-direction: column;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .booking-filters .filter-group {
                margin-bottom: 1rem;
            }
            
            .btn-group {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 1.5rem 1rem;
            }
            
            .header h1 {
                font-size: 1.75rem;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .room-card {
                padding: 1rem;
            }
        }
        
        /* Utility Classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .font-bold { font-weight: 700; }
        .font-semibold { font-weight: 600; }
        .font-medium { font-weight: 500; }
        
        .text-gray-500 { color: var(--gray-500); }
        .text-gray-600 { color: var(--gray-600); }
        .text-gray-700 { color: var(--gray-700); }
        
        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .mb-8 { margin-bottom: 2rem; }
        
        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-6 { margin-top: 1.5rem; }
        .mt-8 { margin-top: 2rem; }
        
        .flex { display: flex; }
        .flex-1 { flex: 1; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        
        .hidden { display: none; }
        .block { display: block; }
        .inline { display: inline; }
        .inline-block { display: inline-block; }
        
        /* Button Groups */
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-group .btn {
            margin: 0;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius);
            background: var(--gray-50);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            border-color: var(--primary-light);
            background: rgba(99, 102, 241, 0.1);
        }

        .radio-option input[type="radio"] {
            margin: 0;
        }

        .radio-option input[type="radio"]:checked + .radio-label {
            color: var(--primary);
            font-weight: 600;
        }

        .radio-option:has(input:checked) {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        /* Global Alert Container */
        #global-alerts {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
        }

        .global-alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            border-left: 4px solid;
            box-shadow: var(--shadow-lg);
            background: white;
            animation: slideInRight 0.3s ease;
            font-size: 0.875rem;
            position: relative;
            cursor: pointer;
        }

        .global-alert-success {
            border-left-color: var(--success);
            color: var(--gray-700);
        }

        .global-alert-danger {
            border-left-color: var(--danger);
            color: var(--gray-700);
        }

        .global-alert-warning {
            border-left-color: var(--warning);
            color: var(--gray-700);
        }

        .global-alert-info {
            border-left-color: var(--info);
            color: var(--gray-700);
        }

        .alert-close {
            position: absolute;
            top: 0.5rem;
            right: 0.75rem;
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: 0.25rem;
            border-radius: var(--radius);
            transition: all 0.2s ease;
        }

        .alert-close:hover {
            color: var(--gray-600);
            background: var(--gray-100);
        }

        @keyframes slideOutRight {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        .alert-removing {
            animation: slideOutRight 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-logo-section">
                    <img id="hotel-logo" src="logo.png" alt="Hotel Logo" style="display: none;">
                    <div class="header-text">
                        <h1><i class="fas fa-hotel"></i> Hotel Verwaltung</h1>
                        <p>Modernes Management-System f√ºr Ihren Hotelbetrieb</p>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="openCompanySettings()" title="Firmendaten verwalten">
                        <i class="fas fa-building"></i> Firmendaten
                    </button>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard', event)">
                <i class="fas fa-chart-line"></i> Dashboard
            </button>
            <button class="nav-tab" onclick="showTab('zimmerplan', event)">
                <i class="fas fa-bed"></i> Zimmerplan
            </button>
            <button class="nav-tab" onclick="showTab('buchung', event)">
                <i class="fas fa-plus-circle"></i> Neue Buchung
            </button>
            <button class="nav-tab" onclick="showTab('kalender', event)">
                <i class="fas fa-calendar-alt"></i> Kalender
            </button>
            <button class="nav-tab" onclick="showTab('buchungen', event)">
                <i class="fas fa-list"></i> Buchungen
            </button>
            <button class="nav-tab" onclick="showTab('gaeste', event)">
                <i class="fas fa-users"></i> G√§ste
            </button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-pane active">
                <div class="dashboard" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-bed"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="total-rooms">25</div>
                        <div class="stat-label">Gesamtzimmer</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-door-closed"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="occupied-rooms">0</div>
                        <div class="stat-label">Belegte Zimmer</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-door-open"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="free-rooms">25</div>
                        <div class="stat-label">Freie Zimmer</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="occupancy-rate">0%</div>
                        <div class="stat-label">Auslastung</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-euro-sign"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="daily-revenue">‚Ç¨0</div>
                        <div class="stat-label">Tagesumsatz</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-sign-in-alt"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="checkins-today">0</div>
                        <div class="stat-label">Check-ins heute</div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-calendar-check"></i> Wichtige Termine</h3>
                    <div id="important-events" class="events-container">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-calendar-times"></i>
                            <p class="mt-2">Keine wichtigen Termine in den n√§chsten Tagen</p>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="showBackupAssistant()">
                        <i class="fas fa-download"></i> Backup-Assistent
                    </button>
                    <button class="btn btn-outline" onclick="resetAllData()">
                        <i class="fas fa-refresh"></i> Daten zur√ºcksetzen
                    </button>
                </div>
            </div>

            <!-- Zimmerplan Tab -->
            <div id="zimmerplan" class="tab-pane">
                <div class="room-header">
                    <h2><i class="fas fa-calendar-day"></i> Tagesstatus - <span id="current-date"></span></h2>
                    <p class="text-gray-600">Live-Status aller Zimmer f√ºr heute</p>
                </div>
                
                <div class="room-filters">
                    <button class="btn btn-outline" onclick="filterRooms('alle')">
                        <i class="fas fa-th"></i> Alle Zimmer
                    </button>
                    <button class="btn btn-success" onclick="filterRooms('frei')">
                        <i class="fas fa-door-open"></i> Freie Zimmer
                    </button>
                    <button class="btn btn-danger" onclick="filterRooms('belegt')">
                        <i class="fas fa-door-closed"></i> Belegte Zimmer
                    </button>
                    <button class="btn btn-info" onclick="filterRooms('checkin')">
                        <i class="fas fa-sign-in-alt"></i> Check-in heute
                    </button>
                    <button class="btn btn-warning" onclick="filterRooms('checkout')">
                        <i class="fas fa-sign-out-alt"></i> Check-out heute
                    </button>
                </div>
                
                <div class="room-grid" id="room-grid">
                    <!-- Rooms will be populated by JavaScript -->
                </div>
            </div>

            <!-- Neue Buchung Tab -->
            <div id="buchung" class="tab-pane">
                <form id="booking-form" onsubmit="createBooking(event)">
                    
                    <!-- G√§ste-Auswahl -->
                    <div class="form-section">
                        <h3><i class="fas fa-user-check"></i> Gast ausw√§hlen</h3>
                        <div class="form-group">
                            <label>Gast-Optionen</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="guest-type" value="existing" id="guest-type-existing" onchange="toggleGuestForm()">
                                    <span class="radio-label">
                                        <i class="fas fa-user"></i> Bestehenden Gast ausw√§hlen
                                    </span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="guest-type" value="new" id="guest-type-new" checked onchange="toggleGuestForm()">
                                    <span class="radio-label">
                                        <i class="fas fa-user-plus"></i> Neuen Gast erstellen
                                    </span>
                                </label>
                            </div>
                        </div>

                        <!-- Bestehender Gast Auswahl -->
                        <div id="existing-guest-selection" class="form-group" style="display: none;">
                            <label for="existing-guest-select">Gast ausw√§hlen *</label>
                            <select class="form-control" id="existing-guest-select" onchange="fillGuestData()">
                                <option value="">-- Gast ausw√§hlen --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Gast-Informationen -->
                    <div class="form-section" id="new-guest-form">
                        <h3><i class="fas fa-user-plus"></i> Gast-Informationen</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="guest-firstname">Vorname *</label>
                                <input type="text" class="form-control" id="guest-firstname" required>
                            </div>
                            <div class="form-group">
                                <label for="guest-lastname">Nachname *</label>
                                <input type="text" class="form-control" id="guest-lastname" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="guest-email">E-Mail</label>
                                <input type="email" class="form-control" id="guest-email">
                            </div>
                            <div class="form-group">
                                <label for="guest-phone">Telefon</label>
                                <input type="tel" class="form-control" id="guest-phone">
                            </div>
                        </div>
                    </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-calendar"></i> Reisedaten</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="checkin-date">Check-in Datum *</label>
                            <input type="date" class="form-control" id="checkin-date" required onchange="calculateNights(); updateAvailableRooms();">
                        </div>
                        <div class="form-group">
                            <label for="checkout-date">Check-out Datum *</label>
                            <input type="date" class="form-control" id="checkout-date" required onchange="calculateNights(); updateAvailableRooms();">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nights">Anzahl N√§chte</label>
                            <input type="number" class="form-control" id="nights" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-bed"></i> Zimmerauswahl</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="room-number">Zimmer *</label>
                            <select class="form-select" id="room-number" required onchange="setRoomInfo()">
                                <option value="">Zimmer ausw√§hlen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="room-type">Zimmertyp</label>
                            <input type="text" class="form-control" id="room-type" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="price-per-night">Preis pro Nacht (‚Ç¨)</label>
                            <input type="number" class="form-control" id="price-per-night" min="0" step="1" onchange="updateTotalPrice()">
                        </div>
                        <div class="form-group">
                            <label for="total-price">Gesamtpreis</label>
                            <input type="text" class="form-control" id="total-price" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Weitere Details</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-method">Zahlungsart</label>
                            <select class="form-select" id="payment-method">
                                <option value="Bar">Bar</option>
                                <option value="Kreditkarte">Kreditkarte</option>
                                <option value="EC-Karte">EC-Karte</option>
                                <option value="√úberweisung">√úberweisung</option>
                                <option value="PayPal">PayPal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="remarks">Bemerkungen</label>
                        <textarea class="form-control" id="remarks" rows="3" placeholder="Sonderw√ºnsche, Allergien, etc."></textarea>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Buchung erstellen
                    </button>
                    <button type="button" class="btn btn-outline" onclick="resetForm()">
                        <i class="fas fa-undo"></i> Zur√ºcksetzen
                    </button>
                </div>
                    </form>
                
                <div id="booking-alerts"></div>
            </div>

            <!-- Kalender Tab -->
            <div id="kalender" class="tab-pane">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn btn-outline" onclick="previousMonth()">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h2 id="calendar-month-year" class="font-semibold">
                            <!-- Month/Year will be populated by JavaScript -->
                        </h2>
                        <button class="btn btn-outline" onclick="nextMonth()">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <div class="calendar-table-container">
                        <table id="calendar-table" class="calendar-table">
                            <thead id="calendar-header">
                                <!-- Header row will be populated by JavaScript -->
                            </thead>
                            <tbody id="calendar-body">
                                <!-- Calendar rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Buchungen Tab -->
            <div id="buchungen" class="tab-pane">
                <div class="flex justify-between items-center mb-6">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="booking-search" placeholder="Nach Buchung, Gast oder Zimmer suchen..." onkeyup="searchBookings()">
                    </div>
                </div>
                
                <!-- Booking Filters -->
                <div class="booking-filters">
                    <div class="filter-group">
                        <h3><i class="fas fa-filter"></i> Status Filter</h3>
                        <div class="filter-buttons">
                            <button class="btn btn-outline active" onclick="filterBookingsByStatus('alle')">
                                <i class="fas fa-th"></i> Alle
                            </button>
                            <button class="btn btn-success" onclick="filterBookingsByStatus('Reserviert')">
                                <i class="fas fa-calendar-check"></i> Reserviert
                            </button>
                            <button class="btn btn-danger" onclick="filterBookingsByStatus('Aktiv')">
                                <i class="fas fa-door-closed"></i> Aktiv
                            </button>
                            <button class="btn btn-info" onclick="filterBookingsByStatus('Abgeschlossen')">
                                <i class="fas fa-check-circle"></i> Abgeschlossen
                            </button>
                            <button class="btn btn-warning" onclick="filterBookingsByStatus('Storniert')">
                                <i class="fas fa-times-circle"></i> Storniert
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <h3><i class="fas fa-calendar"></i> Zeit Filter</h3>
                        <div class="filter-buttons">
                            <button class="btn btn-outline active" onclick="filterBookingsByTime('alle')">
                                <i class="fas fa-calendar"></i> Alle Buchungen
                            </button>
                            <button class="btn btn-primary" onclick="filterBookingsByTime('heute')">
                                <i class="fas fa-calendar-day"></i> Heute
                            </button>
                            <button class="btn btn-secondary" onclick="filterBookingsByTime('woche')">
                                <i class="fas fa-calendar-week"></i> Diese Woche
                            </button>
                            <button class="btn btn-tertiary" onclick="filterBookingsByTime('monat')">
                                <i class="fas fa-calendar-alt"></i> Dieser Monat
                            </button>
                            <button class="btn btn-outline" onclick="filterBookingsByTime('zukunft')">
                                <i class="fas fa-calendar-plus"></i> Zuk√ºnftig
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Buchungs-ID</th>
                                <th>Gast</th>
                                <th>Zimmer</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Status</th>
                                <th>Preis</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="bookings-table-body">
                            <!-- Bookings will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- G√§ste Tab -->
            <div id="gaeste" class="tab-pane">
                <div class="flex justify-between items-center mb-6">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="guest-search" placeholder="Nach Name, E-Mail oder Telefon suchen..." onkeyup="searchGuests()">
                    </div>
                    <button class="btn btn-primary" onclick="showAddGuestModal()">
                        <i class="fas fa-user-plus"></i> Neuen Gast hinzuf√ºgen
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>E-Mail</th>
                                <th>Telefon</th>
                                <th>Adresse</th>
                                <th>Buchungen</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody id="guests-table-body">
                            <!-- Guests will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Alert Container -->
    <div id="global-alerts"></div>

    <!-- Modal f√ºr Zimmer-Details -->
    <div id="room-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-room-title">Zimmer Details</h2>
                <button class="close" onclick="closeModal('room-detail-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="modal-room-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-room-button" onclick="saveRoomDetails()" style="display: none;">
                    <i class="fas fa-save"></i> Zimmer Speichern
                </button>
                <button class="btn btn-outline" onclick="closeModal('room-detail-modal')">
                    <i class="fas fa-times"></i> Schlie√üen
                </button>
            </div>
        </div>
    </div>

    <!-- Modal f√ºr Buchung bearbeiten -->
    <div id="booking-edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Buchung bearbeiten</h2>
                <button class="close" onclick="closeModal('booking-edit-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="booking-edit-form" onsubmit="saveBookingEdit(event)">
                    <input type="hidden" id="edit-booking-id" value="">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Gast Vorname *</label>
                            <input type="text" class="form-control" id="edit-guest-firstname" required>
                        </div>
                        <div class="form-group">
                            <label>Gast Nachname *</label>
                            <input type="text" class="form-control" id="edit-guest-lastname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Check-in Datum *</label>
                            <input type="date" class="form-control" id="edit-checkin-date" required onchange="updateEditRoomAvailability()">
                        </div>
                        <div class="form-group">
                            <label>Check-out Datum *</label>
                            <input type="date" class="form-control" id="edit-checkout-date" required onchange="updateEditRoomAvailability()">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Zimmer *</label>
                            <select class="form-select" id="edit-room-number" required onchange="setEditRoomInfo()">
                                <option value="">Zimmer ausw√§hlen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Anzahl N√§chte</label>
                            <input type="number" class="form-control" id="edit-nights" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Preis pro Nacht (‚Ç¨)</label>
                            <input type="number" class="form-control" id="edit-price-per-night" min="0" step="1" onchange="updateEditTotalPrice()">
                        </div>
                        <div class="form-group">
                            <label>Gesamtpreis</label>
                            <input type="text" class="form-control" id="edit-total-price" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-select" id="edit-booking-status">
                                <option value="Reserviert">Reserviert</option>
                                <option value="Aktiv">Aktiv</option>
                                <option value="Abgeschlossen">Abgeschlossen</option>
                                <option value="Storniert">Storniert</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Zahlungsart</label>
                            <select class="form-select" id="edit-payment-method">
                                <option value="Bar">Bar</option>
                                <option value="Kreditkarte">Kreditkarte</option>
                                <option value="EC-Karte">EC-Karte</option>
                                <option value="√úberweisung">√úberweisung</option>
                                <option value="PayPal">PayPal</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Bemerkungen</label>
                        <textarea class="form-control" id="edit-remarks" rows="3" placeholder="Zus√§tzliche Informationen zur Buchung..."></textarea>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> √Ñnderungen speichern
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('booking-edit-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
                </form>
        </div>
    </div>

    <!-- Modal f√ºr Kalender-Details -->
    <div id="calendar-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="calendar-modal-title">Tag Details</h2>
                <button class="close" onclick="closeModal('calendar-detail-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="calendar-modal-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('calendar-detail-modal')">
                    <i class="fas fa-times"></i> Schlie√üen
                </button>
            </div>
        </div>
    </div>

    <!-- Modal f√ºr Gast hinzuf√ºgen -->
    <div id="add-guest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Neuen Gast hinzuf√ºgen</h2>
                <button class="close" onclick="closeModal('add-guest-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-guest-form" onsubmit="addGuest(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-guest-firstname">Vorname *</label>
                            <input type="text" class="form-control" id="new-guest-firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="new-guest-lastname">Nachname *</label>
                            <input type="text" class="form-control" id="new-guest-lastname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-guest-email">E-Mail</label>
                            <input type="email" class="form-control" id="new-guest-email">
                        </div>
                        <div class="form-group">
                            <label for="new-guest-phone">Telefon</label>
                            <input type="tel" class="form-control" id="new-guest-phone">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="new-guest-address">Adresse</label>
                        <textarea class="form-control" id="new-guest-address" rows="3" placeholder="Stra√üe, Hausnummer&#10;PLZ Ort&#10;Land"></textarea>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Gast hinzuf√ºgen
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('add-guest-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
                </form>
        </div>
    </div>

    <!-- Modal f√ºr Gast bearbeiten -->
    <div id="edit-guest-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gast bearbeiten</h2>
                <button class="close" onclick="closeModal('edit-guest-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-guest-form" onsubmit="updateGuest(event)">
                    <input type="hidden" id="edit-guest-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-guest-firstname">Vorname *</label>
                            <input type="text" class="form-control" id="edit-guest-firstname" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-guest-lastname">Nachname *</label>
                            <input type="text" class="form-control" id="edit-guest-lastname" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-guest-email">E-Mail</label>
                            <input type="email" class="form-control" id="edit-guest-email">
                        </div>
                        <div class="form-group">
                            <label for="edit-guest-phone">Telefon</label>
                            <input type="tel" class="form-control" id="edit-guest-phone">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Buchungen</label>
                        <p class="form-text">Anzahl Buchungen: <strong id="edit-guest-bookings-count">0</strong></p>
                        <p class="form-text text-muted">Die Buchungsanzahl wird automatisch verwaltet.</p>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> √Ñnderungen speichern
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('edit-guest-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
                </form>
        </div>
    </div>

    <!-- Modal f√ºr Backup-Assistent -->
    <div id="backup-assistant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-download"></i> Backup-Assistent</h2>
                <button class="close" onclick="closeModal('backup-assistant-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Aktuelle Daten</h3>
                    <div class="dashboard">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-bed"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="backup-rooms-count">25</div>
                            <div class="stat-label">Zimmer</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="backup-bookings-count">0</div>
                            <div class="stat-label">Buchungen</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="backup-guests-count">0</div>
                            <div class="stat-label">G√§ste</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-clock"></i> Letztes Backup</h3>
                    <p id="last-backup-info" class="text-gray-600">Noch kein Backup erstellt</p>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-shield-alt"></i> Backup-Arten</h3>
                    <div class="alert alert-info">
                        <strong>Automatisches Backup:</strong> Ihre Daten werden automatisch im Browser gespeichert (LocalStorage).
                        Diese Daten bleiben auch nach dem Schlie√üen des Browsers erhalten.
                    </div>
                    <div class="alert alert-warning">
                        <strong>Externes Backup:</strong> F√ºr maximale Sicherheit empfehlen wir zus√§tzlich ein externes JSON-Backup.
                        Diese Datei k√∂nnen Sie auf anderen Ger√§ten importieren oder als Sicherheitskopie aufbewahren.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="exportBackup()">
                    <i class="fas fa-download"></i> JSON-Backup erstellen
                </button>
                <button class="btn btn-outline" onclick="document.getElementById('import-backup-input').click()">
                    <i class="fas fa-upload"></i> Backup wiederherstellen
                </button>
                <input type="file" id="import-backup-input" accept=".json" style="display: none;" onchange="importBackup(event)">
            </div>
        </div>
    </div>

    <!-- Invoice Editor Modal -->
    <div id="invoice-editor-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px; width: 90vw;">
            <div class="modal-header">
                <h2><i class="fas fa-file-invoice-dollar"></i> Rechnung erstellen</h2>
                <button class="close" onclick="closeModal('invoice-editor-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="invoice-form">
                    <!-- Customer Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-user"></i> Kundeninformationen</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Vorname*:</label>
                                <input type="text" id="invoice-firstname" required>
                            </div>
                            <div class="form-group">
                                <label>Nachname*:</label>
                                <input type="text" id="invoice-lastname" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>E-Mail:</label>
                                <input type="email" id="invoice-email">
                            </div>
                            <div class="form-group">
                                <label>Telefon:</label>
                                <input type="text" id="invoice-phone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Adresse:</label>
                                <textarea id="invoice-address" rows="3" placeholder="Stra√üe, Hausnummer&#10;PLZ Ort&#10;Land"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Booking Information -->
                    <div class="form-section">
                        <h3><i class="fas fa-calendar"></i> Buchungsinformationen</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Check-in:</label>
                                <input type="date" id="invoice-checkin" readonly>
                            </div>
                            <div class="form-group">
                                <label>Check-out:</label>
                                <input type="date" id="invoice-checkout" readonly>
                            </div>
                            <div class="form-group">
                                <label>Zimmer:</label>
                                <input type="text" id="invoice-room" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Items -->
                    <div class="form-section">
                        <h3><i class="fas fa-list"></i> Rechnungspositionen</h3>
                        <div class="invoice-items-container">
                            <div class="invoice-items-header">
                                <span>Position</span>
                                <span>Beschreibung</span>
                                <span>Menge</span>
                                <span>Einzelpreis (‚Ç¨)</span>
                                <span>MwSt. (%)</span>
                                <span>Gesamt (‚Ç¨)</span>
                                <span>Aktion</span>
                            </div>
                            <div id="invoice-items-list">
                                <!-- Invoice items will be added here -->
                            </div>
                            <button type="button" class="btn btn-outline btn-sm" onclick="addInvoiceItemWithDefaultTax()">
                                <i class="fas fa-plus"></i> Position hinzuf√ºgen
                            </button>
                        </div>
                    </div>

                    <!-- Tax and Totals -->
                    <div class="form-section">
                        <h3><i class="fas fa-calculator"></i> Zahlungsart & Summe</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Standard-Steuersatz f√ºr neue Positionen (%):</label>
                                <input type="number" id="invoice-tax-rate" value="19" min="0" max="100" step="0.01">
                                <small style="color: #666;">Wird f√ºr neue Positionen als Voreinstellung verwendet</small>
                            </div>
                            <div class="form-group">
                                <label>Zahlungsart:</label>
                                <select id="invoice-payment">
                                    <option value="Bar">Bar</option>
                                    <option value="Kreditkarte">Kreditkarte</option>
                                    <option value="√úberweisung">√úberweisung</option>
                                    <option value="PayPal">PayPal</option>
                                    <option value="Rechnung">Rechnung</option>
                                </select>
                            </div>
                        </div>
                        <div class="invoice-totals">
                            <div class="total-row">
                                <span>Zwischensumme:</span>
                                <span id="invoice-subtotal">‚Ç¨0.00</span>
                            </div>
                            <div class="total-row">
                                <span>MwSt.:</span>
                                <span id="invoice-tax">‚Ç¨0.00</span>
                            </div>
                            <div class="total-row total-final">
                                <span>Gesamtbetrag:</span>
                                <span id="invoice-total">‚Ç¨0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Remarks -->
                    <div class="form-section">
                        <h3><i class="fas fa-sticky-note"></i> Bemerkungen</h3>
                        <div class="form-group">
                            <textarea id="invoice-remarks" rows="3" placeholder="Zus√§tzliche Bemerkungen zur Rechnung..."></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="generateAdvancedInvoice()">
                    <i class="fas fa-file-pdf"></i> PDF-Rechnung erstellen
                </button>
                <button class="btn btn-outline" onclick="closeModal('invoice-editor-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div id="company-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-building"></i> Firmendaten verwalten</h2>
                <button class="close" onclick="closeModal('company-settings-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="company-form">
                    <div class="form-section">
                        <h3><i class="fas fa-image"></i> Logo</h3>
                        <div class="form-group">
                            <label>Logo f√ºr PDF-Rechnungen:</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button type="button" class="btn btn-outline" onclick="loadLogoAsDataURL()">
                                    <i class="fas fa-upload"></i> Logo hochladen
                                </button>
                                <span id="logo-status" style="font-size: 0.9rem; color: #666;">
                                    Kein Logo f√ºr PDFs verf√ºgbar
                                </span>
                            </div>
                            <small style="color: #666; margin-top: 5px; display: block;">
                                Das Logo wird in generierten PDF-Rechnungen angezeigt. Unterst√ºtzte Formate: PNG, JPG, GIF
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> Firmeninformationen</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Firmenname*:</label>
                                <input type="text" id="company-name" required>
                            </div>
                            <div class="form-group">
                                <label>Zusatz:</label>
                                <input type="text" id="company-subtitle" placeholder="z.B. Hotel & Restaurant">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Stra√üe & Hausnummer*:</label>
                                <input type="text" id="company-street" required>
                            </div>
                            <div class="form-group">
                                <label>PLZ & Ort*:</label>
                                <input type="text" id="company-city" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Land:</label>
                                <input type="text" id="company-country" value="Deutschland">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-phone"></i> Kontaktdaten</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Telefon:</label>
                                <input type="text" id="company-phone">
                            </div>
                            <div class="form-group">
                                <label>E-Mail*:</label>
                                <input type="email" id="company-email" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website:</label>
                                <input type="text" id="company-website" placeholder="www.hotel-beispiel.de">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-file-alt"></i> Rechtliche Angaben</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Gesch√§ftsf√ºhrer:</label>
                                <input type="text" id="company-manager">
                            </div>
                            <div class="form-group">
                                <label>Handelsregister:</label>
                                <input type="text" id="company-register" placeholder="HRB 12345">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Steuernummer:</label>
                                <input type="text" id="company-tax-number">
                            </div>
                            <div class="form-group">
                                <label>USt-IdNr:</label>
                                <input type="text" id="company-vat-id" placeholder="DE123456789">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3><i class="fas fa-university"></i> Bankverbindung</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Bank:</label>
                                <input type="text" id="company-bank">
                            </div>
                            <div class="form-group">
                                <label>IBAN:</label>
                                <input type="text" id="company-iban" placeholder="DE89 3704 0044 0532 0130 00">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>BIC:</label>
                                <input type="text" id="company-bic" placeholder="COBADEFFXXX">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="saveCompanySettings()">
                    <i class="fas fa-save"></i> Firmendaten speichern
                </button>
                <button class="btn btn-outline" onclick="closeModal('company-settings-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- Initial Import Modal -->
    <div id="initial-import-modal" class="modal" style="background: rgba(0,0,0,0.8);">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-upload"></i> Willkommen im Hotel-Verwaltungssystem</h2>
                <!-- No close button - user must make a choice -->
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Keine Daten gefunden!</strong><br>
                    Das System startet mit leeren Daten. Sie haben folgende Optionen:
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-rocket"></i> Option 1: Mit Beispieldaten starten</h3>
                    <p>Starten Sie sofort mit vorkonfigurierten Beispieldaten (empfohlen f√ºr neue Benutzer).</p>
                    <button class="btn btn-primary" onclick="startWithSampleData()">
                        <i class="fas fa-play"></i> Mit Beispieldaten starten
                    </button>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-upload"></i> Option 2: Backup importieren</h3>
                    <p>Falls Sie bereits ein JSON-Backup haben, k√∂nnen Sie Ihre Daten hier wiederherstellen.</p>
                    <button class="btn btn-outline" onclick="document.getElementById('initial-import-input').click()">
                        <i class="fas fa-file-upload"></i> JSON-Backup importieren
                    </button>
                    <input type="file" id="initial-import-input" accept=".json" style="display: none;" onchange="importInitialBackup(event)">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rooms = [];
        let bookings = [];
        let guests = [];
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let currentSelectedRoom = null;

        // Guest form toggle function - defined early to be available for HTML onchange
        function toggleGuestForm() {
            const existingSelected = document.getElementById('guest-type-existing').checked;
            const existingSelection = document.getElementById('existing-guest-selection');
            const newGuestForm = document.getElementById('new-guest-form');
            
            if (existingSelected) {
                existingSelection.style.display = 'block';
                newGuestForm.style.display = 'none';
                updateExistingGuestSelect();
                // Make guest fields optional when selecting existing guest
                document.getElementById('guest-firstname').required = false;
                document.getElementById('guest-lastname').required = false;
            } else {
                existingSelection.style.display = 'none';
                newGuestForm.style.display = 'block';
                clearGuestData();
                // Make guest fields required when creating new guest
                document.getElementById('guest-firstname').required = true;
                document.getElementById('guest-lastname').required = true;
            }
        }

        function updateExistingGuestSelect() {
            const select = document.getElementById('existing-guest-select');
            select.innerHTML = '<option value="">-- Gast ausw√§hlen --</option>';
            
            // Sort guests by name
            const sortedGuests = [...guests].sort((a, b) => 
                `${a.firstname} ${a.lastname}`.localeCompare(`${b.firstname} ${b.lastname}`)
            );
            
            sortedGuests.forEach(guest => {
                const option = document.createElement('option');
                option.value = guest.id;
                option.textContent = `${guest.firstname} ${guest.lastname}`;
                if (guest.email) {
                    option.textContent += ` (${guest.email})`;
                }
                select.appendChild(option);
            });
        }

        function clearGuestData() {
            document.getElementById('guest-firstname').value = '';
            document.getElementById('guest-lastname').value = '';
            document.getElementById('guest-email').value = '';
            document.getElementById('guest-phone').value = '';
            document.getElementById('existing-guest-select').value = '';
        }

        function fillGuestData() {
            const selectedGuestId = document.getElementById('existing-guest-select').value;
            if (!selectedGuestId) {
                clearGuestData();
                return;
            }
            
            const guest = guests.find(g => g.id === selectedGuestId);
            if (guest) {
                document.getElementById('guest-firstname').value = guest.firstname;
                document.getElementById('guest-lastname').value = guest.lastname;
                document.getElementById('guest-email').value = guest.email || '';
                document.getElementById('guest-phone').value = guest.phone || '';
            }
        }

        function updateGuestBookingCounts() {
            console.log('=== updateGuestBookingCounts START ===');
            console.log('updateGuestBookingCounts called, guests:', guests.length, 'bookings:', bookings.length);
            console.log('Current guests:', guests.map(g => ({name: g.firstname + ' ' + g.lastname, email: g.email, currentBookings: g.bookings})));
            
            // Reset all guest booking counts
            guests.forEach(guest => {
                guest.bookings = 0;
            });
            
            // Count bookings for each guest (excluding cancelled bookings)
            bookings.forEach(booking => {
                console.log('Processing booking:', booking.firstname, booking.lastname, booking.email, 'Status:', booking.status);
                
                // Fix missing email
                if (!booking.email) {
                    booking.email = '';
                    console.log('Fixed missing email for booking:', booking.firstname, booking.lastname);
                }
                if (booking.status !== 'Storniert') {
                    const guest = guests.find(g => 
                        g.firstname === booking.firstname && 
                        g.lastname === booking.lastname &&
                        (g.email === booking.email || (!g.email && !booking.email))
                    );
                    if (guest) {
                        guest.bookings++;
                        console.log('Found matching guest, incremented count to:', guest.bookings);
                    } else {
                        console.log('No matching guest found for booking:', booking.firstname, booking.lastname, booking.email);
                    }
                } else {
                    console.log('Skipping cancelled booking');
                }
            });
            
            console.log('Final guest booking counts:', guests.map(g => ({name: g.firstname + ' ' + g.lastname, bookings: g.bookings})));
            console.log('=== updateGuestBookingCounts END ===');
        }

        // Initial Import Functions
        function startWithSampleData() {
            console.log('Starting with sample data...');
            
            // Initialize with default data
            initializeRooms();
            
            // Create sample guests
            guests = [
                {
                    id: 'G001',
                    firstname: 'Max',
                    lastname: 'Mustermann',
                    email: 'max.mustermann@example.com',
                    phone: '+49 123 456789',
                    bookings: 0,
                    regular: false
                }
            ];
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Close modal and initialize normally
            document.getElementById('initial-import-modal').style.display = 'none';
            
            // Complete normal initialization
            updateRoomStatusesFromBookings();
            updateCurrentDate();
            updateGuestBookingCounts();
            updateDashboard();
            renderRooms();
            renderCalendar();
            renderBookings();
            renderGuests();
            
            showAlert('System mit Beispieldaten initialisiert!', 'success');
        }

        function importInitialBackup(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.rooms && !data.bookings && !data.guests) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Import data
                    if (data.rooms) rooms = data.rooms;
                    if (data.bookings) bookings = data.bookings;
                    if (data.guests) guests = data.guests;
                    
                    // Ensure we have rooms
                    if (rooms.length === 0) {
                        initializeRooms();
                    }
                    
                    // Save to localStorage
                    saveToLocalStorage();
                    
                    // Close modal
                    document.getElementById('initial-import-modal').style.display = 'none';
                    
                    // Complete normal initialization
                    updateRoomStatusesFromBookings();
                    updateCurrentDate();
                    updateGuestBookingCounts();
                    updateDashboard();
                    renderRooms();
                    renderCalendar();
                    renderBookings();
                    renderGuests();
                    
                    showAlert('Backup erfolgreich importiert!', 'success');
                } catch (error) {
                    console.error('Import error:', error);
                    showAlert('Fehler beim Importieren des Backups. Datei ung√ºltig.', 'danger');
                }
            };
            reader.readAsText(file);
        }

        // Logo handling
        let logoDataURL = null; // Store logo as data URL for PDF

        function initializeLogo() {
            const logoImg = document.getElementById('hotel-logo');
            if (logoImg) {
                // Test if logo.png exists
                logoImg.onload = function() {
                    this.style.display = 'block';
                    // Skip canvas conversion to avoid CORS issues - we'll handle this differently in PDF
                    console.log('Logo loaded successfully for display');
                };
                logoImg.onerror = function() {
                    this.style.display = 'none';
                    logoDataURL = null;
                    console.log('Logo file (logo.png) not found - no logo will be displayed');
                };
                // Force load check by setting src again
                logoImg.src = logoImg.src;
            }
        }

        // Load logo as Data URL via file picker
        function loadLogoAsDataURL() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/png,image/jpeg,image/jpg,image/gif';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Check file size (max 2MB)
                    if (file.size > 2 * 1024 * 1024) {
                        showAlert('Das Logo ist zu gro√ü. Maximale Dateigr√∂√üe: 2MB', 'warning');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        logoDataURL = e.target.result;
                        
                        // Update header logo if it exists
                        const logoImg = document.getElementById('hotel-logo');
                        if (logoImg) {
                            logoImg.src = logoDataURL;
                            logoImg.style.display = 'block';
                        }
                        
                        // Update status
                        const statusSpan = document.getElementById('logo-status');
                        if (statusSpan) {
                            statusSpan.textContent = `‚úì ${file.name} geladen`;
                            statusSpan.style.color = '#059669';
                        }
                        
                        // Save to localStorage
                        localStorage.setItem('hotelLogoDataURL', logoDataURL);
                        
                        console.log('Logo loaded as Data URL for PDF usage');
                        showAlert('Logo erfolgreich hochgeladen und f√ºr PDFs verf√ºgbar!', 'success');
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Update logo status on page load
        function updateLogoStatus() {
            const savedLogo = localStorage.getItem('hotelLogoDataURL');
            if (savedLogo) {
                logoDataURL = savedLogo;
                
                // Update header logo with saved logo
                const logoImg = document.getElementById('hotel-logo');
                if (logoImg) {
                    logoImg.src = logoDataURL;
                    logoImg.style.display = 'block';
                }
                
                // Update status text
                const statusSpan = document.getElementById('logo-status');
                if (statusSpan) {
                    statusSpan.textContent = '‚úì Logo verf√ºgbar f√ºr PDFs';
                    statusSpan.style.color = '#059669';
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeLogo(); // Initialize logo first
            updateLogoStatus(); // Check for saved logo
            loadCompanyData(); // Initialize company data
            loadFromLocalStorage();
            // Note: initializeRooms() is called inside loadFromLocalStorage() if needed
            updateCurrentDate();
            updateGuestBookingCounts(); // Ensure booking counts are correct at startup
            updateDashboard();
            renderRooms();
            renderCalendar();
            renderBookings();
            renderGuests();
            
            // Set up auto-save
            window.addEventListener('beforeunload', function(e) {
                saveToLocalStorage();
                
                const confirmationMessage = 'M√∂chten Sie vor dem Schlie√üen ein Backup erstellen? Ihre Daten sind automatisch gespeichert, aber ein externes Backup bietet zus√§tzliche Sicherheit.';
                
                if (!localStorage.getItem('skipBackupWarning')) {
                    e.preventDefault();
                    e.returnValue = confirmationMessage;
                    
                    // Show backup assistant after a short delay
                    setTimeout(() => {
                        if (confirm('Backup-Assistent √∂ffnen?')) {
                            showBackupAssistant();
                        }
                    }, 100);
                    
                    return confirmationMessage;
                }
            });
            
            // Additional event listeners for mobile
            window.addEventListener('unload', saveToLocalStorage);
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'hidden') {
                    saveToLocalStorage();
                }
            });
        });

        // Initialize rooms
        function initializeRooms() {
            // Check if rooms already exist in localStorage
            const existingRooms = localStorage.getItem('hotelRooms');
            const migrationFlag = localStorage.getItem('roomNumberMigrated');
            const namesMigrationFlag = localStorage.getItem('roomNamesMigrated');
            
            if (!existingRooms || !migrationFlag) {
                // Initialize with new room structure (01-25)
                for (let i = 1; i <= 25; i++) {
                    const roomNumber = String(i).padStart(2, '0');
                    const types = ['Einzelzimmer', 'Doppelzimmer', 'Suite', 'Familienzimmer', 'Apartment'];
                    const prices = [89, 139, 259, 189, 299];
                    
                    const typeIndex = Math.floor((i-1) / 5) % types.length;
                    
                    rooms.push({
                        number: roomNumber,
                        name: '', // Neues Feld f√ºr Zimmernamen
                        type: types[typeIndex],
                        price: prices[typeIndex],
                        status: 'frei',
                        guest: '',
                        checkin: '',
                        checkout: '',
                        notes: ''
                    });
                }
                
                // Clear old localStorage data and set migration flag
                localStorage.removeItem('hotelBookings');
                localStorage.removeItem('hotelGuests');
                localStorage.setItem('roomNumberMigrated', 'true');
                localStorage.setItem('roomNamesMigrated', 'true');
                
                saveToLocalStorage();
            } else if (!namesMigrationFlag) {
                // Migrate existing rooms to add name field
                rooms.forEach(room => {
                    if (room.name === undefined) {
                        room.name = '';
                    }
                });
                localStorage.setItem('roomNamesMigrated', 'true');
                saveToLocalStorage();
            }
        }

        // Tab management
        function showTab(tabName, event) {
            console.log('showTab called with tabName:', tabName, 'event:', event);
            // Hide all tab panes
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabPanes.forEach(pane => pane.classList.remove('active'));
            
            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab pane
            const targetPane = document.getElementById(tabName);
            if (targetPane) {
                targetPane.classList.add('active');
                console.log('Tab pane activated:', tabName);
            } else {
                console.error('Tab pane not found:', tabName);
            }
            
            // Add active class to selected tab (only if event is provided)
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the correct tab button
                const targetTab = document.querySelector(`button[onclick*="${tabName}"]`);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Tab button activated for:', tabName);
                } else {
                    console.error('Tab button not found for:', tabName);
                }
            }
            
            // Update content based on tab
            if (tabName === 'dashboard') {
                updateDashboard();
            } else if (tabName === 'zimmerplan') {
                updateCurrentDate();
                renderRooms();
            } else if (tabName === 'kalender') {
                renderCalendar();
            } else if (tabName === 'buchungen') {
                renderBookings();
            } else if (tabName === 'gaeste') {
                renderGuests();
            }
        }

        // Global alert system
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('global-alerts');
            
            const alert = document.createElement('div');
            alert.className = `global-alert global-alert-${type}`;
            alert.innerHTML = `
                ${message}
                <button class="alert-close" onclick="removeAlert(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            alertContainer.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    removeAlert(alert.querySelector('.alert-close'));
                }
            }, 5000);
        }

        function removeAlert(button) {
            const alert = button.parentElement;
            alert.classList.add('alert-removing');
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 300);
        }

        // Dashboard functions
        function updateDashboard() {
            const totalRooms = rooms.length;
            const occupiedRooms = rooms.filter(room => room.status === 'belegt' || room.status === 'reserviert').length;
            const freeRooms = totalRooms - occupiedRooms;
            const occupancyRate = totalRooms > 0 ? Math.round((occupiedRooms / totalRooms) * 100) : 0;
            
            // Calculate daily revenue
            const today = new Date().toISOString().split('T')[0];
            const todayBookings = bookings.filter(booking => {
                return booking.status === 'Aktiv' && booking.checkin <= today && booking.checkout > today;
            });
            const dailyRevenue = todayBookings.reduce((sum, booking) => {
                const nights = Math.ceil((new Date(booking.checkout) - new Date(booking.checkin)) / (1000 * 60 * 60 * 24));
                return sum + (nights > 0 ? booking.total / nights : 0);
            }, 0);
            
            // Check-ins today
            const checkinsToday = bookings.filter(booking => booking.checkin === today && booking.status !== 'Storniert').length;
            
            document.getElementById('total-rooms').textContent = totalRooms;
            document.getElementById('occupied-rooms').textContent = occupiedRooms;
            document.getElementById('free-rooms').textContent = freeRooms;
            document.getElementById('occupancy-rate').textContent = occupancyRate + '%';
            document.getElementById('daily-revenue').textContent = '‚Ç¨' + dailyRevenue.toFixed(0);
            document.getElementById('checkins-today').textContent = checkinsToday;
            
            // Update important events
            updateImportantEvents();
        }

        function updateImportantEvents() {
            const eventsContainer = document.getElementById('important-events');
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const upcomingEvents = [];
            
            // Check-ins in next 7 days
            bookings.filter(booking => {
                const checkinDate = new Date(booking.checkin);
                return booking.status !== 'Storniert' && checkinDate >= today && checkinDate <= nextWeek;
            }).forEach(booking => {
                upcomingEvents.push({
                    date: booking.checkin,
                    title: `üè® Check-in: ${booking.firstname} ${booking.lastname} (Zimmer ${booking.room})`,
                    type: 'checkin',
                    remarks: booking.remarks
                });
            });
            
            // Check-outs in next 7 days
            bookings.filter(booking => {
                const checkoutDate = new Date(booking.checkout);
                return booking.status !== 'Storniert' && checkoutDate >= today && checkoutDate <= nextWeek;
            }).forEach(booking => {
                upcomingEvents.push({
                    date: booking.checkout,
                    title: `üõ´ Check-out: ${booking.firstname} ${booking.lastname} (Zimmer ${booking.room})`,
                    type: 'checkout',
                    remarks: booking.remarks
                });
            });
            
            // VIP bookings (over ‚Ç¨1000)
            bookings.filter(booking => {
                const checkinDate = new Date(booking.checkin);
                return booking.status !== 'Storniert' && booking.total > 1000 && checkinDate >= today && checkinDate <= nextWeek;
            }).forEach(booking => {
                upcomingEvents.push({
                    date: booking.checkin,
                    title: `üí∞ VIP-Buchung: ${booking.firstname} ${booking.lastname} (‚Ç¨${booking.total})`,
                    type: 'vip',
                    remarks: booking.remarks
                });
            });
            
            // Sort events by date
            upcomingEvents.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="text-center text-gray-500">
                        <i class="fas fa-calendar-times"></i>
                        <p class="mt-2">Keine wichtigen Termine in den n√§chsten Tagen</p>
                    </div>
                `;
            } else {
                eventsContainer.innerHTML = upcomingEvents.map(event => `
                    <div class="event-item">
                        <div class="event-date">${formatDateWithWeekday(event.date)}</div>
                        <div class="event-title">${event.title}</div>
                        ${event.remarks ? `<div class="event-remarks" style="font-size: 0.85em; color: #666; margin-top: 2px;"><i class="fas fa-sticky-note"></i> ${event.remarks}</div>` : ''}
                    </div>
                `).join('');
            }
        }

        // Room management functions
        function renderRooms() {
            const roomGrid = document.getElementById('room-grid');
            roomGrid.innerHTML = '';
            
            rooms.forEach(room => {
                const roomCard = document.createElement('div');
                roomCard.className = `room-card room-${room.status}`;
                roomCard.onclick = () => showRoomDetails(room);
                
                roomCard.innerHTML = `
                    <div class="room-number">${room.number}</div>
                    ${room.name ? `<div class="room-name">${room.name}</div>` : ''}
                    <div class="room-type">${room.type}</div>
                    <div class="room-status status-${room.status}">
                        <i class="fas fa-${getStatusIcon(room.status)}"></i>
                        ${getStatusText(room.status)}
                    </div>
                    ${room.guest ? `<div class="room-guest">${room.guest}</div>` : ''}
                `;
                
                roomGrid.appendChild(roomCard);
            });
        }

        function getStatusIcon(status) {
            switch (status) {
                case 'frei': return 'door-open';
                case 'belegt': return 'door-closed';
                case 'reserviert': return 'calendar-check';
                case 'wartung': return 'tools';
                case 'checkin': return 'sign-in-alt';
                case 'checkout': return 'sign-out-alt';
                default: return 'question';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'frei': return 'Frei';
                case 'belegt': return 'Belegt';
                case 'reserviert': return 'Reserviert';
                case 'wartung': return 'Wartung';
                case 'checkin': return 'Check-in';
                case 'checkout': return 'Check-out';
                case 'belegt_abgeschlossen': return 'Abgeschlossen';
                case 'checkin_completed': return 'Check-in (Abgeschlossen)';
                case 'checkout_completed': return 'Check-out (Abgeschlossen)';
                case 'checkout_checkin_completed': return 'Check-out & Check-in (Abgeschlossen)';
                default: return status;
            }
        }
        
        function getStatusSymbol(status) {
            switch (status) {
                case 'frei': return '‚óè';
                case 'belegt': return '‚óè';
                case 'reserviert': return '‚óè';
                case 'wartung': return 'üîß';
                case 'checkin': return '‚û°';
                case 'checkout': return '‚¨Ö';
                case 'checkout_checkin': return '‚¨Ö‚û°';
                case 'belegt_abgeschlossen': return '‚óë';
                case 'checkin_completed': return '‚§∑';
                case 'checkout_completed': return '‚§¥';
                case 'checkout_checkin_completed': return '‚§∑‚§¥';
                default: return '‚óè';
            }
        }

        function showRoomDetails(room) {
            currentSelectedRoom = room;
            document.getElementById('modal-room-title').textContent = `Zimmer ${room.number} bearbeiten`;
            
            document.getElementById('modal-room-content').innerHTML = `
                <div class="form-section">
                    <h3><i class="fas fa-home"></i> Zimmer-Eigenschaften</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label><strong>Zimmername (optional):</strong></label>
                            <input type="text" id="edit-room-name" class="form-control" placeholder="z.B. Rosenzimmer, Meerblick-Suite" value="${room.name || ''}" maxlength="50">
                        </div>
                        <div class="form-group">
                            <label><strong>Zimmerart/Kategorie:</strong></label>
                            <select id="edit-room-type" class="form-select">
                                <option value="Einzelzimmer" ${room.type === 'Einzelzimmer' ? 'selected' : ''}>Einzelzimmer</option>
                                <option value="Doppelzimmer" ${room.type === 'Doppelzimmer' ? 'selected' : ''}>Doppelzimmer</option>
                                <option value="Suite" ${room.type === 'Suite' ? 'selected' : ''}>Suite</option>
                                <option value="Familienzimmer" ${room.type === 'Familienzimmer' ? 'selected' : ''}>Familienzimmer</option>
                                <option value="Apartment" ${room.type === 'Apartment' ? 'selected' : ''}>Apartment</option>
                                <option value="Penthouse" ${room.type === 'Penthouse' ? 'selected' : ''}>Penthouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><strong>Standardpreis (‚Ç¨/Nacht):</strong></label>
                            <input type="number" id="edit-room-price" class="form-control" min="0" step="1" value="${room.price}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><strong>Bemerkungen:</strong></label>
                        <textarea id="edit-room-notes" class="form-control" rows="2" placeholder="z.B. Meerblick, renoviert, etc.">${room.notes || ''}</textarea>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Aktueller Status</h3>
                    <div class="badge badge-${getBadgeType(room.status)}">
                        <i class="fas fa-${getStatusIcon(room.status)}"></i>
                        ${getStatusText(room.status)}
                    </div>
                    ${room.guest ? `
                        <div class="mt-3">
                            <strong>Aktueller Gast:</strong> ${room.guest}<br>
                            <strong>Check-in:</strong> ${formatDate(room.checkin)}<br>
                            <strong>Check-out:</strong> ${formatDate(room.checkout)}
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('save-room-button').style.display = 'inline-flex';
            document.getElementById('room-detail-modal').style.display = 'block';
        }

        function saveRoomDetails() {
            if (!currentSelectedRoom) return;
            
            const newName = document.getElementById('edit-room-name').value.trim();
            const newType = document.getElementById('edit-room-type').value;
            const newPrice = parseFloat(document.getElementById('edit-room-price').value);
            const newNotes = document.getElementById('edit-room-notes').value;
            
            // Update room properties
            currentSelectedRoom.name = newName;
            currentSelectedRoom.type = newType;
            currentSelectedRoom.price = newPrice;
            currentSelectedRoom.notes = newNotes;
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Update displays
            renderRooms();
            updateDashboard();
            
            showAlert('Zimmer-Details erfolgreich gespeichert!', 'success');
            closeModal('room-detail-modal');
        }

        function getBadgeType(status) {
            switch (status) {
                case 'frei': return 'success';
                case 'belegt': return 'danger';
                case 'reserviert': return 'warning';
                case 'wartung': return 'primary';
                default: return 'info';
            }
        }

        function filterRooms(status) {
            const roomCards = document.querySelectorAll('.room-card');
            roomCards.forEach(card => {
                if (status === 'alle') {
                    card.style.display = 'block';
                } else {
                    const hasStatus = card.classList.contains(`room-${status}`);
                    card.style.display = hasStatus ? 'block' : 'none';
                }
            });
        }

        // Booking functions
        function calculateNights() {
            const checkin = document.getElementById('checkin-date').value;
            const checkout = document.getElementById('checkout-date').value;
            
            if (checkin && checkout) {
                const nights = Math.ceil((new Date(checkout) - new Date(checkin)) / (1000 * 60 * 60 * 24));
                document.getElementById('nights').value = Math.max(0, nights);
                updateTotalPrice();
            }
        }

        function updateAvailableRooms() {
            const checkinDate = document.getElementById('checkin-date').value;
            const checkoutDate = document.getElementById('checkout-date').value;
            const roomSelect = document.getElementById('room-number');
            
            if (checkinDate && checkoutDate) {
                calculateNights();
                
                // Clear current options
                roomSelect.innerHTML = '<option value="">Zimmer ausw√§hlen</option>';
                
                // Add available rooms
                rooms.filter(room => {
                    // Check if room is available during the requested period
                    const conflictingBookings = bookings.filter(booking => {
                        if (booking.status === 'Storniert' || booking.status === 'Abgeschlossen') return false;
                        if (booking.room !== room.number) return false;
                        
                        const bookingCheckin = new Date(booking.checkin);
                        const bookingCheckout = new Date(booking.checkout);
                        const requestCheckin = new Date(checkinDate);
                        const requestCheckout = new Date(checkoutDate);
                        
                        return (requestCheckin < bookingCheckout && requestCheckout > bookingCheckin);
                    });
                    
                    return conflictingBookings.length === 0;
                }).forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.number;
                    const roomDisplay = room.name 
                        ? `Zimmer ${room.number} "${room.name}" - ${room.type} (‚Ç¨${room.price}/Nacht)`
                        : `Zimmer ${room.number} - ${room.type} (‚Ç¨${room.price}/Nacht)`;
                    option.textContent = roomDisplay;
                    roomSelect.appendChild(option);
                });
            }
        }

        function setRoomInfo() {
            const roomNumber = document.getElementById('room-number').value;
            const room = rooms.find(r => r.number === roomNumber);
            
            if (room) {
                document.getElementById('room-type').value = room.type;
                const priceField = document.getElementById('price-per-night');
                if (!priceField.value || priceField.value === '0') {
                    priceField.value = room.price;
                }
                updateTotalPrice();
            }
        }

        function updateTotalPrice() {
            const nights = parseInt(document.getElementById('nights').value) || 0;
            const pricePerNight = parseFloat(document.getElementById('price-per-night').value) || 0;
            const totalPrice = nights * pricePerNight;
            document.getElementById('total-price').value = '‚Ç¨ ' + totalPrice.toFixed(2);
        }

        function checkForOverbooking(roomNumber, checkinDate, checkoutDate, excludeBookingId = null) {
            const checkin = new Date(checkinDate);
            const checkout = new Date(checkoutDate);
            
            const conflictingBookings = bookings.filter(booking => {
                // Skip cancelled and completed bookings
                if (booking.status === 'Storniert' || booking.status === 'Abgeschlossen') {
                    return false;
                }
                
                // Exclude current booking when editing
                if (excludeBookingId && booking.id === excludeBookingId) {
                    return false;
                }
                
                // Only check same room
                if (booking.room !== roomNumber) {
                    return false;
                }
                
                const bookingCheckin = new Date(booking.checkin);
                const bookingCheckout = new Date(booking.checkout);
                
                // Check for overlap
                return (checkin < bookingCheckout && checkout > bookingCheckin);
            });
            
            return {
                hasConflict: conflictingBookings.length > 0,
                conflictingBookings: conflictingBookings
            };
        }

        function createBooking(event) {
            console.log('=== createBooking FUNCTION CALLED ===');
            event.preventDefault();
            
            const firstname = document.getElementById('guest-firstname').value;
            const lastname = document.getElementById('guest-lastname').value;
            const email = document.getElementById('guest-email').value;
            const phone = document.getElementById('guest-phone').value;
            const roomNumber = document.getElementById('room-number').value;
            const checkin = document.getElementById('checkin-date').value;
            const checkout = document.getElementById('checkout-date').value;
            const payment = document.getElementById('payment-method').value;
            const remarks = document.getElementById('remarks').value;
            const totalPrice = parseFloat(document.getElementById('total-price').value.replace('‚Ç¨ ', ''));
            
            // Double booking protection
            console.log('Checking for overbooking...');
            const conflictCheck = checkForOverbooking(roomNumber, checkin, checkout);
            console.log('Conflict check result:', conflictCheck);
            if (conflictCheck.hasConflict) {
                console.log('CONFLICT DETECTED - returning early');
                const conflictDetails = conflictCheck.conflictingBookings.map(booking => 
                    `${booking.firstname} ${booking.lastname} (${booking.checkin} - ${booking.checkout})`
                ).join('\n');
                
                showAlert(
                    `‚ùå √úberbuchung erkannt!\n\nZimmer ${roomNumber} ist bereits gebucht:\n${conflictDetails}\n\nBitte w√§hlen Sie ein anderes Zimmer oder andere Daten.`, 
                    'danger'
                );
                return;
            }
            
            console.log('No conflicts found, proceeding with booking creation...');
            
            // Generate booking ID
            const bookingId = new Date().toISOString().slice(0, 10).replace(/-/g, '') + '-' + String(bookings.length + 1).padStart(3, '0');
            
            // Create new booking
            const newBooking = {
                id: bookingId,
                firstname: firstname,
                lastname: lastname,
                room: roomNumber,
                checkin: checkin,
                checkout: checkout,
                total: totalPrice,
                status: 'Reserviert',
                payment: payment,
                remarks: remarks
            };
            
            console.log('Adding booking to array:', newBooking);
            bookings.push(newBooking);
            console.log('Booking added successfully, total bookings:', bookings.length);
            console.log('About to update room status...');
            
            // Update room status
            const room = rooms.find(r => r.number === roomNumber);
            console.log('Found room for update:', room);
            if (room) {
                room.status = 'reserviert';
                room.guest = `${firstname} ${lastname}`;
                room.checkin = checkin;
                room.checkout = checkout;
                console.log('Room status updated');
            }
            
            // Add guest if not exists
            console.log('Checking for existing guest with email:', email);
            const existingGuest = guests.find(g => g.email === email && email);
            console.log('Existing guest found:', existingGuest);
            if (!existingGuest && email) {
                console.log('Adding new guest to database');
                const guestId = 'G' + String(guests.length + 1).padStart(3, '0');
                guests.push({
                    id: guestId,
                    firstname: firstname,
                    lastname: lastname,
                    email: email,
                    phone: phone,
                    bookings: 0, // Will be updated by updateGuestBookingCounts()
                    regular: false
                });
                console.log('New guest added to database');
            }
            // Booking count will be updated automatically by updateGuestBookingCounts()
            
            console.log('About to call updateRoomStatusesFromBookings...');
            updateRoomStatusesFromBookings();
            console.log('updateRoomStatusesFromBookings completed');
            
            resetForm();
            updateDashboard();
            renderRooms();
            renderGuests(); // This will update booking counts automatically
            try { renderCalendar(); } catch (e) { console.error('Error updating calendar:', e); }
            saveToLocalStorage();
            
            console.log('=== ABOUT TO EXECUTE TAB SWITCH ===');
            
            // Switch to calendar tab immediately after successful booking creation
            showAlert('Buchung erfolgreich erstellt!', 'success');
            console.log('Alert shown, setting up timeout for tab switch');
            
            // Switch to calendar tab after a short delay
            setTimeout(() => {
                console.log('=== TIMEOUT EXECUTED - SWITCHING TO CALENDAR ===');
                showTab('kalender');
                showAlert('Neue Buchung im Kalender sichtbar!', 'info');
            }, 800);
        }

        function resetForm() {
            document.getElementById('booking-form').reset();
            document.getElementById('room-number').innerHTML = '<option value="">Zimmer ausw√§hlen</option>';
            document.getElementById('room-type').value = '';
            document.getElementById('nights').value = '';
            document.getElementById('price-per-night').value = '';
            document.getElementById('total-price').value = '';
            
            // Reset guest selection
            document.getElementById('guest-type-new').checked = true;
            toggleGuestForm();
        }

        // G√§ste-Auswahl Funktionen

        function updateRoomStatusesFromBookings() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            // Reset all rooms to 'frei' first
            rooms.forEach(room => {
                room.status = 'frei';
                room.guest = '';
                room.checkin = '';
                room.checkout = '';
            });
            
            // Update room status based on TODAY'S bookings only
            bookings.forEach(booking => {
                if (booking.status === 'Storniert') return;
                
                const room = rooms.find(r => r.number === booking.room);
                if (!room) return;
                
                const checkinDate = booking.checkin;
                const checkoutDate = booking.checkout;
                
                // Check if room is occupied TODAY
                if (checkinDate <= todayStr && checkoutDate > todayStr) {
                    room.status = 'belegt';
                    room.guest = `${booking.firstname} ${booking.lastname}`;
                    room.checkin = booking.checkin;
                    room.checkout = booking.checkout;
                }
                // Check if it's a check-in day TODAY
                else if (checkinDate === todayStr) {
                    room.status = 'checkin';
                    room.guest = `${booking.firstname} ${booking.lastname}`;
                    room.checkin = booking.checkin;
                    room.checkout = booking.checkout;
                }
                // Check if it's a check-out day TODAY  
                else if (checkoutDate === todayStr) {
                    room.status = 'checkout';
                    room.guest = `${booking.firstname} ${booking.lastname}`;
                    room.checkin = booking.checkin;
                    room.checkout = booking.checkout;
                }
            });
        }

        // Booking management functions
        function renderBookings() {
            const tbody = document.getElementById('bookings-table-body');
            tbody.innerHTML = '';
            
            // Sort bookings by check-in date (newest first)
            const sortedBookings = [...bookings].sort((a, b) => new Date(b.checkin) - new Date(a.checkin));
            
            sortedBookings.forEach(booking => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${booking.id}</td>
                    <td>${booking.firstname} ${booking.lastname}</td>
                    <td>Zimmer ${booking.room}</td>
                    <td>${formatDate(booking.checkin)}</td>
                    <td>${formatDate(booking.checkout)}</td>
                    <td>
                        <span class="badge badge-${getBookingBadgeType(booking.status)} status-badge">
                            <i class="fas fa-${getBookingStatusIcon(booking.status)}"></i>
                            ${booking.status}
                        </span>
                    </td>
                    <td>‚Ç¨${booking.total.toFixed(2)}</td>
                    <td>
                        <div class="btn-group" style="display: flex; gap: 2px; flex-wrap: nowrap;">
                            <button class="btn btn-outline btn-xs" onclick="editBooking('${booking.id}')" title="Bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-info btn-xs" onclick="openInvoiceEditor('${booking.id}')" title="Rechnung erstellen">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                            ${booking.status !== 'Storniert' ? `
                                <button class="btn btn-warning btn-xs" onclick="cancelBooking('${booking.id}')" title="Stornieren">
                                    <i class="fas fa-ban"></i>
                                </button>
                            ` : `
                                <button class="btn btn-danger btn-xs" onclick="deleteBooking('${booking.id}')" title="L√∂schen">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Apply current filters after rendering
            applyBookingFilters();
        }

        function getBookingBadgeType(status) {
            switch (status) {
                case 'Reserviert': return 'warning';
                case 'Aktiv': return 'danger';
                case 'Abgeschlossen': return 'success';
                case 'Storniert': return 'secondary';
                default: return 'info';
            }
        }

        function getBookingStatusIcon(status) {
            switch (status) {
                case 'Reserviert': return 'calendar-check';
                case 'Aktiv': return 'bed';
                case 'Abgeschlossen': return 'check';
                case 'Storniert': return 'times';
                default: return 'question';
            }
        }

        function searchBookings() {
            const searchTerm = document.getElementById('booking-search').value.toLowerCase();
            
            if (searchTerm === '') {
                // If search is cleared, apply current filters
                applyBookingFilters();
                return;
            }
            
            const rows = document.querySelectorAll('#bookings-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                
                if (matchesSearch) {
                    // Show row, but still apply filters
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Booking filter variables
        let currentStatusFilter = 'alle';
        let currentTimeFilter = 'alle';
        
        function filterBookingsByStatus(status) {
            currentStatusFilter = status;
            
            // Update button states
            document.querySelectorAll('.booking-filters .filter-group:first-child .filter-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyBookingFilters();
        }
        
        function filterBookingsByTime(timeFilter) {
            currentTimeFilter = timeFilter;
            
            // Update button states  
            document.querySelectorAll('.booking-filters .filter-group:last-child .filter-buttons button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            applyBookingFilters();
        }
        
        function applyBookingFilters() {
            const rows = document.querySelectorAll('#bookings-table-body tr');
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            
            // Get start of week (Monday)
            const startOfWeek = new Date(today);
            const dayOfWeek = today.getDay();
            const daysFromMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1);
            startOfWeek.setDate(today.getDate() - daysFromMonday);
            const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
            
            // Get end of week (Sunday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            const endOfWeekStr = endOfWeek.toISOString().split('T')[0];
            
            // Get start/end of month
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const startOfMonthStr = startOfMonth.toISOString().split('T')[0];
            const endOfMonthStr = endOfMonth.toISOString().split('T')[0];
            
            rows.forEach(row => {
                const statusCell = row.querySelector('.status-badge');
                const checkinCell = row.cells[3]; 
                const checkoutCell = row.cells[4];
                
                if (!statusCell || !checkinCell || !checkoutCell) return;
                
                const status = statusCell.textContent.trim();
                const checkinDate = checkinCell.textContent.trim();
                const checkoutDate = checkoutCell.textContent.trim();
                
                // Convert German date format to ISO (dd.mm.yyyy -> yyyy-mm-dd)
                const checkinISO = convertGermanDateToISO(checkinDate);
                const checkoutISO = convertGermanDateToISO(checkoutDate);
                
                let showRow = true;
                
                // Apply status filter
                if (currentStatusFilter !== 'alle' && status !== currentStatusFilter) {
                    showRow = false;
                }
                
                // Apply time filter
                if (currentTimeFilter !== 'alle' && showRow) {
                    switch (currentTimeFilter) {
                        case 'heute':
                            showRow = (checkinISO === todayStr || checkoutISO === todayStr || 
                                     (checkinISO <= todayStr && checkoutISO >= todayStr));
                            break;
                        case 'woche':
                            showRow = (checkinISO <= endOfWeekStr && checkoutISO >= startOfWeekStr);
                            break;
                        case 'monat':
                            showRow = (checkinISO <= endOfMonthStr && checkoutISO >= startOfMonthStr);
                            break;
                        case 'zukunft':
                            showRow = checkinISO > todayStr;
                            break;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }
        
        function convertGermanDateToISO(germanDate) {
            if (!germanDate || germanDate === '-') return '';
            const parts = germanDate.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return germanDate;
        }

        function editBooking(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            document.getElementById('edit-booking-id').value = booking.id;
            document.getElementById('edit-guest-firstname').value = booking.firstname;
            document.getElementById('edit-guest-lastname').value = booking.lastname;
            document.getElementById('edit-checkin-date').value = booking.checkin;
            document.getElementById('edit-checkout-date').value = booking.checkout;
            document.getElementById('edit-booking-status').value = booking.status;
            document.getElementById('edit-payment-method').value = booking.payment;
            document.getElementById('edit-remarks').value = booking.remarks || '';
            
            // Load available rooms including current room
            updateEditRoomAvailability();
            
            // Set current room and calculate individual price
            setTimeout(() => {
                document.getElementById('edit-room-number').value = booking.room;
                
                const nights = Math.ceil((new Date(booking.checkout) - new Date(booking.checkin)) / (1000 * 60 * 60 * 24));
                const pricePerNight = nights > 0 ? (booking.total / nights) : 0;
                
                document.getElementById('edit-nights').value = nights;
                document.getElementById('edit-price-per-night').value = pricePerNight.toFixed(2);
                document.getElementById('edit-total-price').value = '‚Ç¨ ' + booking.total.toFixed(2);
            }, 100);
            
            document.getElementById('booking-edit-modal').style.display = 'block';
        }

        function updateEditRoomAvailability() {
            const checkinDate = document.getElementById('edit-checkin-date').value;
            const checkoutDate = document.getElementById('edit-checkout-date').value;
            const roomSelect = document.getElementById('edit-room-number');
            const currentBookingId = document.getElementById('edit-booking-id').value;
            
            if (checkinDate && checkoutDate) {
                // Calculate nights
                const nights = Math.ceil((new Date(checkoutDate) - new Date(checkinDate)) / (1000 * 60 * 60 * 24));
                document.getElementById('edit-nights').value = nights;
                
                // Update total price
                updateEditTotalPrice();
                
                // Clear and populate room options
                roomSelect.innerHTML = '<option value="">Zimmer ausw√§hlen</option>';
                
                // Add available rooms (including current room)
                rooms.filter(room => {
                    const conflictingBookings = bookings.filter(booking => {
                        if (booking.status === 'Storniert' || booking.status === 'Abgeschlossen') return false;
                        if (booking.id === currentBookingId) return false; // Exclude current booking
                        if (booking.room !== room.number) return false;
                        
                        const bookingCheckin = new Date(booking.checkin);
                        const bookingCheckout = new Date(booking.checkout);
                        const requestCheckin = new Date(checkinDate);
                        const requestCheckout = new Date(checkoutDate);
                        
                        return (requestCheckin < bookingCheckout && requestCheckout > bookingCheckin);
                    });
                    
                    return conflictingBookings.length === 0;
                }).forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.number;
                    const roomDisplay = room.name 
                        ? `Zimmer ${room.number} "${room.name}" - ${room.type} (‚Ç¨${room.price}/Nacht)`
                        : `Zimmer ${room.number} - ${room.type} (‚Ç¨${room.price}/Nacht)`;
                    option.textContent = roomDisplay;
                    roomSelect.appendChild(option);
                });
            }
        }

        function setEditRoomInfo() {
            const roomNumber = document.getElementById('edit-room-number').value;
            const room = rooms.find(r => r.number === roomNumber);
            
            if (room) {
                const priceField = document.getElementById('edit-price-per-night');
                if (!priceField.value || priceField.value === '0') {
                    priceField.value = room.price;
                }
                updateEditTotalPrice();
            }
        }

        function updateEditTotalPrice() {
            const nights = parseInt(document.getElementById('edit-nights').value) || 0;
            const pricePerNight = parseFloat(document.getElementById('edit-price-per-night').value) || 0;
            const totalPrice = nights * pricePerNight;
            document.getElementById('edit-total-price').value = '‚Ç¨ ' + totalPrice.toFixed(2);
        }

        function saveBookingEdit(event) {
            event.preventDefault();
            
            const bookingId = document.getElementById('edit-booking-id').value;
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) return;
            
            // Clear old room assignment
            const oldRoom = rooms.find(r => r.number === booking.room);
            if (oldRoom && (oldRoom.guest === `${booking.firstname} ${booking.lastname}`)) {
                oldRoom.status = 'frei';
                oldRoom.guest = '';
                oldRoom.checkin = '';
                oldRoom.checkout = '';
            }
            
            // Get new data
            const newFirstname = document.getElementById('edit-guest-firstname').value;
            const newLastname = document.getElementById('edit-guest-lastname').value;
            const newRoomNumber = document.getElementById('edit-room-number').value;
            const newCheckin = document.getElementById('edit-checkin-date').value;
            const newCheckout = document.getElementById('edit-checkout-date').value;
            const newStatus = document.getElementById('edit-booking-status').value;
            const newPayment = document.getElementById('edit-payment-method').value;
            const newTotal = parseFloat(document.getElementById('edit-total-price').value.replace('‚Ç¨ ', ''));
            const newRemarks = document.getElementById('edit-remarks').value;
            
            // Double booking protection (exclude current booking)
            const conflictCheck = checkForOverbooking(newRoomNumber, newCheckin, newCheckout, bookingId);
            if (conflictCheck.hasConflict) {
                const conflictDetails = conflictCheck.conflictingBookings.map(booking => 
                    `${booking.firstname} ${booking.lastname} (${booking.checkin} - ${booking.checkout})`
                ).join('\n');
                
                showAlert(
                    `‚ùå √úberbuchung erkannt!\n\nZimmer ${newRoomNumber} ist bereits gebucht:\n${conflictDetails}\n\nBitte w√§hlen Sie ein anderes Zimmer oder andere Daten.`, 
                    'danger'
                );
                return;
            }
            
            // Update booking
            booking.firstname = newFirstname;
            booking.lastname = newLastname;
            booking.room = newRoomNumber;
            booking.checkin = newCheckin;
            booking.checkout = newCheckout;
            booking.status = newStatus;
            booking.payment = newPayment;
            booking.total = newTotal;
            booking.remarks = newRemarks;
            
            // Update new room assignment
            const newRoom = rooms.find(r => r.number === newRoomNumber);
            if (newRoom && newStatus !== 'Storniert') {
                const today = new Date();
                const checkinDate = new Date(newCheckin);
                const checkoutDate = new Date(newCheckout);
                
                if (newStatus === 'Aktiv' || (checkinDate <= today && checkoutDate > today)) {
                    newRoom.status = 'belegt';
                } else if (checkinDate > today) {
                    newRoom.status = 'reserviert';
                }
                
                newRoom.guest = `${newFirstname} ${newLastname}`;
                newRoom.checkin = newCheckin;
                newRoom.checkout = newCheckout;
            }
            
            updateRoomStatusesFromBookings();
            saveToLocalStorage();
            updateDashboard();
            renderRooms();
            renderBookings();
            renderGuests(); // Update booking counts
            renderCalendar();
            
            showAlert('Buchung erfolgreich aktualisiert!', 'success');
            closeModal('booking-edit-modal');
        }

        function cancelBooking(bookingId) {
            if (confirm('M√∂chten Sie diese Buchung wirklich stornieren?')) {
                const booking = bookings.find(b => b.id === bookingId);
                if (booking) {
                    booking.status = 'Storniert';
                    
                    // Free up the room
                    const room = rooms.find(r => r.number === booking.room);
                    if (room && room.guest === `${booking.firstname} ${booking.lastname}`) {
                        room.status = 'frei';
                        room.guest = '';
                        room.checkin = '';
                        room.checkout = '';
                    }
                    
                    updateRoomStatusesFromBookings();
                    saveToLocalStorage();
                    updateDashboard();
                    renderRooms();
                    renderBookings();
                    renderGuests(); // Update booking counts
                    renderCalendar();
                    
                    showAlert('Buchung wurde storniert.', 'warning');
                }
            }
        }

        function deleteBooking(bookingId) {
            if (confirm('M√∂chten Sie diese stornierte Buchung endg√ºltig l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                const bookingIndex = bookings.findIndex(b => b.id === bookingId);
                if (bookingIndex > -1) {
                    bookings.splice(bookingIndex, 1);
                    
                    saveToLocalStorage();
                    updateDashboard();
                    renderBookings();
                    renderGuests(); // Update booking counts
                    renderCalendar();
                    
                    showAlert('Buchung wurde endg√ºltig gel√∂scht.', 'info');
                }
            }
        }

        // Invoice generation function
        function generateInvoice(bookingId) {
            try {
                const booking = bookings.find(b => b.id === bookingId);
                if (!booking) {
                    showAlert('Buchung nicht gefunden!', 'danger');
                    return;
                }

                const room = rooms.find(r => r.number === booking.room);
                if (!room) {
                    showAlert('Zimmer-Informationen nicht gefunden!', 'danger');
                    return;
                }

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font
                doc.setFont("helvetica");
                
                // Company Header
                doc.setFontSize(20);
                doc.setTextColor(99, 102, 241); // Primary color
                doc.text('Hotel Verwaltung', 20, 25);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Musterstra√üe 123', 20, 32);
                doc.text('12345 Musterstadt', 20, 37);
                doc.text('Tel: +49 (0) 123 456789', 20, 42);
                doc.text('E-Mail: info@hotel.example.com', 20, 47);
                
                // Invoice Title
                doc.setFontSize(18);
                doc.setTextColor(99, 102, 241);
                doc.text('RECHNUNG', 120, 25);
                
                // Invoice Details
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Rechnungsnummer: ${booking.id}`, 120, 35);
                doc.text(`Rechnungsdatum: ${new Date().toLocaleDateString('de-DE')}`, 120, 40);
                doc.text(`Buchungsnummer: ${booking.id}`, 120, 45);
                
                // Customer Details
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Rechnungsadresse:', 20, 65);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`${booking.firstname} ${booking.lastname}`, 20, 75);
                if (booking.email) {
                    doc.text(booking.email, 20, 80);
                }
                if (booking.phone) {
                    doc.text(booking.phone, 20, 85);
                }
                
                // Booking Details Section
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Buchungsdetails:', 20, 105);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Check-in: ${formatDate(booking.checkin)}`, 20, 115);
                doc.text(`Check-out: ${formatDate(booking.checkout)}`, 20, 120);
                
                // Calculate nights
                const checkinDate = new Date(booking.checkin);
                const checkoutDate = new Date(booking.checkout);
                const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
                
                doc.text(`Anzahl N√§chte: ${nights}`, 20, 125);
                doc.text(`Zimmer: ${booking.room} (${room.category})`, 20, 130);
                doc.text(`Status: ${booking.status}`, 20, 135);
                
                // Invoice Table Header
                const tableStartY = 155;
                doc.setFillColor(99, 102, 241);
                doc.rect(20, tableStartY, 170, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('Position', 25, tableStartY + 7);
                doc.text('Beschreibung', 60, tableStartY + 7);
                doc.text('Menge', 120, tableStartY + 7);
                doc.text('Einzelpreis', 140, tableStartY + 7);
                doc.text('Gesamtpreis', 165, tableStartY + 7);
                
                // Invoice Items
                doc.setTextColor(0, 0, 0);
                let yPosition = tableStartY + 20;
                
                // Main accommodation item
                doc.text('1', 25, yPosition);
                doc.text(`√úbernachtung Zimmer ${booking.room}`, 60, yPosition);
                doc.text(`${nights}`, 125, yPosition);
                doc.text(`‚Ç¨${room.price.toFixed(2)}`, 145, yPosition);
                doc.text(`‚Ç¨${booking.total.toFixed(2)}`, 170, yPosition);
                
                // Add line below item
                yPosition += 5;
                doc.line(20, yPosition, 190, yPosition);
                
                // Totals Section
                yPosition += 15;
                doc.setFontSize(10);
                
                const subtotal = booking.total;
                const taxRate = 0.19; // 19% MwSt
                const taxAmount = subtotal * taxRate;
                const total = subtotal + taxAmount;
                
                // Subtotal
                doc.text('Zwischensumme:', 140, yPosition);
                doc.text(`‚Ç¨${subtotal.toFixed(2)}`, 170, yPosition);
                
                yPosition += 8;
                doc.text(`MwSt. (${(taxRate * 100).toFixed(0)}%):`, 140, yPosition);
                doc.text(`‚Ç¨${taxAmount.toFixed(2)}`, 170, yPosition);
                
                yPosition += 8;
                doc.line(140, yPosition, 190, yPosition);
                
                yPosition += 10;
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Gesamtbetrag:', 140, yPosition);
                doc.text(`‚Ç¨${total.toFixed(2)}`, 170, yPosition);
                
                // Payment Information
                yPosition += 20;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Zahlungsart:', 20, yPosition);
                doc.text(booking.payment || 'Nicht angegeben', 60, yPosition);
                
                if (booking.remarks) {
                    yPosition += 10;
                    doc.text('Bemerkungen:', 20, yPosition);
                    doc.text(booking.remarks, 20, yPosition + 5);
                }
                
                // Footer
                yPosition = 260;
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Vielen Dank f√ºr Ihren Aufenthalt bei uns!', 20, yPosition);
                doc.text('Bei Fragen zur Rechnung wenden Sie sich gerne an uns.', 20, yPosition + 5);
                
                doc.text(`Erstellt am: ${new Date().toLocaleString('de-DE')}`, 20, yPosition + 15);
                doc.text('Hotel Verwaltungssystem - Moderne Hotelmanagement-Software', 20, yPosition + 20);
                
                // Save PDF
                const fileName = `Rechnung_${booking.id}_${booking.lastname}.pdf`;
                doc.save(fileName);
                
                showAlert(`Rechnung "${fileName}" wurde erfolgreich erstellt und heruntergeladen!`, 'success');
                
            } catch (error) {
                console.error('Error generating invoice:', error);
                showAlert('Fehler beim Erstellen der Rechnung. Bitte versuchen Sie es erneut.', 'danger');
            }
        }

        // Company Settings Management
        let companyData = {
            name: 'Hotel Verwaltung',
            subtitle: '',
            street: 'Musterstra√üe 123',
            city: '12345 Musterstadt',
            country: 'Deutschland',
            phone: '+49 (0) 123 456789',
            email: 'info@hotel.example.com',
            website: '',
            manager: '',
            register: '',
            taxNumber: '',
            vatId: '',
            bank: '',
            iban: '',
            bic: ''
        };

        function loadCompanyData() {
            try {
                const saved = localStorage.getItem('hotelCompanyData');
                if (saved) {
                    companyData = { ...companyData, ...JSON.parse(saved) };
                }
            } catch (error) {
                console.error('Error loading company data:', error);
            }
        }

        function saveCompanyData() {
            try {
                localStorage.setItem('hotelCompanyData', JSON.stringify(companyData));
            } catch (error) {
                console.error('Error saving company data:', error);
            }
        }

        function openCompanySettings() {
            loadCompanyData();
            updateLogoStatus(); // Update logo status when opening modal
            
            // Fill form with current data
            document.getElementById('company-name').value = companyData.name || '';
            document.getElementById('company-subtitle').value = companyData.subtitle || '';
            document.getElementById('company-street').value = companyData.street || '';
            document.getElementById('company-city').value = companyData.city || '';
            document.getElementById('company-country').value = companyData.country || 'Deutschland';
            document.getElementById('company-phone').value = companyData.phone || '';
            document.getElementById('company-email').value = companyData.email || '';
            document.getElementById('company-website').value = companyData.website || '';
            document.getElementById('company-manager').value = companyData.manager || '';
            document.getElementById('company-register').value = companyData.register || '';
            document.getElementById('company-tax-number').value = companyData.taxNumber || '';
            document.getElementById('company-vat-id').value = companyData.vatId || '';
            document.getElementById('company-bank').value = companyData.bank || '';
            document.getElementById('company-iban').value = companyData.iban || '';
            document.getElementById('company-bic').value = companyData.bic || '';
            
            document.getElementById('company-settings-modal').style.display = 'block';
        }

        function saveCompanySettings() {
            // Validate required fields
            const requiredFields = ['company-name', 'company-street', 'company-city', 'company-email'];
            for (let fieldId of requiredFields) {
                if (!document.getElementById(fieldId).value.trim()) {
                    showAlert(`Bitte f√ºllen Sie das Feld "${document.querySelector(`label[for="${fieldId}"]`)?.textContent || fieldId}" aus.`, 'warning');
                    return;
                }
            }

            // Update company data
            companyData = {
                name: document.getElementById('company-name').value,
                subtitle: document.getElementById('company-subtitle').value,
                street: document.getElementById('company-street').value,
                city: document.getElementById('company-city').value,
                country: document.getElementById('company-country').value,
                phone: document.getElementById('company-phone').value,
                email: document.getElementById('company-email').value,
                website: document.getElementById('company-website').value,
                manager: document.getElementById('company-manager').value,
                register: document.getElementById('company-register').value,
                taxNumber: document.getElementById('company-tax-number').value,
                vatId: document.getElementById('company-vat-id').value,
                bank: document.getElementById('company-bank').value,
                iban: document.getElementById('company-iban').value,
                bic: document.getElementById('company-bic').value
            };

            saveCompanyData();
            closeModal('company-settings-modal');
            showAlert('Firmendaten wurden erfolgreich gespeichert!', 'success');
        }

        // Advanced Invoice Editor
        let currentInvoiceItems = [];
        let invoiceItemCounter = 0;

        function openInvoiceEditor(bookingId) {
            const booking = bookings.find(b => b.id === bookingId);
            if (!booking) {
                showAlert('Buchung nicht gefunden!', 'danger');
                return;
            }

            const room = rooms.find(r => r.number === booking.room);
            if (!room) {
                showAlert('Zimmer-Informationen nicht gefunden!', 'danger');
                return;
            }

            // Reset invoice items
            currentInvoiceItems = [];
            invoiceItemCounter = 0;

            // Fill customer information
            // Try to find guest data for address
            const guest = guests.find(g => 
                g.firstname === booking.firstname && 
                g.lastname === booking.lastname && 
                (g.email === booking.email || !booking.email)
            );
            
            document.getElementById('invoice-firstname').value = booking.firstname || '';
            document.getElementById('invoice-lastname').value = booking.lastname || '';
            document.getElementById('invoice-email').value = booking.email || '';
            document.getElementById('invoice-phone').value = booking.phone || '';
            document.getElementById('invoice-address').value = guest?.address || '';

            // Fill booking information
            document.getElementById('invoice-checkin').value = booking.checkin || '';
            document.getElementById('invoice-checkout').value = booking.checkout || '';
            const roomDisplayForInvoice = room.name 
                ? `Zimmer ${booking.room} "${room.name}" (${room.type})`
                : `Zimmer ${booking.room} (${room.type})`;
            document.getElementById('invoice-room').value = roomDisplayForInvoice;

            // Set payment method
            document.getElementById('invoice-payment').value = booking.payment || 'Bar';

            // Set remarks
            document.getElementById('invoice-remarks').value = booking.remarks || '';

            // Add default accommodation item
            const checkinDate = new Date(booking.checkin);
            const checkoutDate = new Date(booking.checkout);
            const nights = Math.ceil((checkoutDate - checkinDate) / (1000 * 60 * 60 * 24));
            
            const defaultTaxRate = parseFloat(document.getElementById('invoice-tax-rate').value) || 19;
            const roomDisplay = room.name 
                ? `Zimmer ${booking.room} "${room.name}"`
                : `Zimmer ${booking.room}`;
            addInvoiceItem(`√úbernachtung ${roomDisplay}`, nights, room.price, defaultTaxRate);

            // Store booking reference
            document.getElementById('invoice-editor-modal').dataset.bookingId = bookingId;

            // Show modal
            document.getElementById('invoice-editor-modal').style.display = 'block';
        }

        function addInvoiceItemWithDefaultTax() {
            const defaultTaxRate = parseFloat(document.getElementById('invoice-tax-rate').value) || 19;
            addInvoiceItem('', 1, 0, defaultTaxRate);
        }

        function addInvoiceItem(description = '', quantity = 1, unitPrice = 0, taxRate = 19) {
            invoiceItemCounter++;
            const itemId = `item-${invoiceItemCounter}`;
            
            const item = {
                id: itemId,
                description: description,
                quantity: parseFloat(quantity) || 1,
                unitPrice: parseFloat(unitPrice) || 0,
                taxRate: parseFloat(taxRate) || 19
            };

            currentInvoiceItems.push(item);
            renderInvoiceItems();
        }

        function removeInvoiceItem(itemId) {
            currentInvoiceItems = currentInvoiceItems.filter(item => item.id !== itemId);
            renderInvoiceItems();
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoice-items-list');
            container.innerHTML = '';

            // Ensure all items have a taxRate
            currentInvoiceItems.forEach(item => {
                if (item.taxRate === undefined || item.taxRate === null) {
                    item.taxRate = 19; // Default tax rate
                }
            });

            currentInvoiceItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'invoice-item';
                itemDiv.innerHTML = `
                    <span>${index + 1}</span>
                    <textarea rows="2" placeholder="Beschreibung" onchange="updateInvoiceItem('${item.id}', 'description', this.value)">${item.description}</textarea>
                    <input type="number" min="0" step="0.01" value="${item.quantity}" onchange="updateInvoiceItem('${item.id}', 'quantity', this.value)">
                    <input type="number" min="0" step="0.01" value="${item.unitPrice.toFixed(2)}" onchange="updateInvoiceItem('${item.id}', 'unitPrice', this.value)">
                    <input type="number" min="0" max="100" step="0.01" value="${(item.taxRate || 19).toFixed(2)}" onchange="updateInvoiceItem('${item.id}', 'taxRate', this.value)">
                    <span class="item-total">‚Ç¨${(item.quantity * item.unitPrice).toFixed(2)}</span>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem('${item.id}')" title="Position entfernen">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(itemDiv);
            });

            calculateInvoiceTotal();
        }

        function updateInvoiceItem(itemId, property, value) {
            const item = currentInvoiceItems.find(i => i.id === itemId);
            if (item) {
                if (property === 'quantity' || property === 'unitPrice' || property === 'taxRate') {
                    item[property] = parseFloat(value) || 0;
                } else {
                    item[property] = value;
                }
                renderInvoiceItems();
            }
        }

        function calculateInvoiceTotal() {
            let subtotal = 0;
            let totalTaxAmount = 0;

            currentInvoiceItems.forEach(item => {
                const itemSubtotal = item.quantity * item.unitPrice;
                const itemTaxAmount = (itemSubtotal * (item.taxRate || 19)) / 100;
                
                subtotal += itemSubtotal;
                totalTaxAmount += itemTaxAmount;
            });

            const total = subtotal + totalTaxAmount;

            document.getElementById('invoice-subtotal').textContent = `‚Ç¨${subtotal.toFixed(2)}`;
            document.getElementById('invoice-tax').textContent = `‚Ç¨${totalTaxAmount.toFixed(2)}`;
            document.getElementById('invoice-total').textContent = `‚Ç¨${total.toFixed(2)}`;
        }

        function generateAdvancedInvoice() {
            try {
                if (currentInvoiceItems.length === 0) {
                    showAlert('Bitte f√ºgen Sie mindestens eine Position hinzu!', 'warning');
                    return;
                }

                const bookingId = document.getElementById('invoice-editor-modal').dataset.bookingId;
                
                // Load company data
                loadCompanyData();

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Set font
                doc.setFont("helvetica");
                
                let yPosition = 20;

                // Add logo if available
                if (logoDataURL) {
                    try {
                        // Use the pre-converted logo data URL
                        const logoImg = document.getElementById('hotel-logo');
                        const logoWidth = 40;
                        const logoHeight = (logoImg.naturalHeight / logoImg.naturalWidth) * logoWidth;
                        doc.addImage(logoDataURL, 'PNG', 20, yPosition, logoWidth, logoHeight);
                        yPosition = Math.max(yPosition + logoHeight + 5, yPosition + 25);
                    } catch (error) {
                        console.warn('Could not add logo to PDF:', error);
                        yPosition += 5;
                    }
                } else {
                    yPosition += 5;
                }

                // Company Header
                doc.setFontSize(20);
                doc.setTextColor(99, 102, 241);
                doc.text(companyData.name, 20, yPosition);
                
                yPosition += 7;
                if (companyData.subtitle) {
                    doc.setFontSize(12);
                    doc.text(companyData.subtitle, 20, yPosition);
                    yPosition += 7;
                }
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(companyData.street, 20, yPosition);
                yPosition += 5;
                doc.text(companyData.city, 20, yPosition);
                yPosition += 5;
                if (companyData.country !== 'Deutschland') {
                    doc.text(companyData.country, 20, yPosition);
                    yPosition += 5;
                }
                if (companyData.phone) {
                    doc.text(`Tel: ${companyData.phone}`, 20, yPosition);
                    yPosition += 5;
                }
                doc.text(`E-Mail: ${companyData.email}`, 20, yPosition);
                if (companyData.website) {
                    yPosition += 5;
                    doc.text(`Web: ${companyData.website}`, 20, yPosition);
                }
                
                // Invoice Title and Details (right side)
                doc.setFontSize(18);
                doc.setTextColor(99, 102, 241);
                doc.text('RECHNUNG', 120, 30);
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Rechnungsnummer: ${bookingId}`, 120, 40);
                doc.text(`Rechnungsdatum: ${new Date().toLocaleDateString('de-DE')}`, 120, 45);
                doc.text(`Buchungsnummer: ${bookingId}`, 120, 50);
                
                // Customer Details
                yPosition = Math.max(yPosition + 20, 70);
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Rechnungsadresse:', 20, yPosition);
                
                yPosition += 10;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const firstname = document.getElementById('invoice-firstname').value;
                const lastname = document.getElementById('invoice-lastname').value;
                doc.text(`${firstname} ${lastname}`, 20, yPosition);
                
                const address = document.getElementById('invoice-address').value;
                if (address) {
                    const addressLines = address.split('\n');
                    addressLines.forEach(line => {
                        yPosition += 5;
                        doc.text(line.trim(), 20, yPosition);
                    });
                }
                
                const email = document.getElementById('invoice-email').value;
                if (email) {
                    yPosition += 5;
                    doc.text(email, 20, yPosition);
                }
                
                const phone = document.getElementById('invoice-phone').value;
                if (phone) {
                    yPosition += 5;
                    doc.text(phone, 20, yPosition);
                }
                
                // Booking Details
                yPosition += 20;
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Buchungsdetails:', 20, yPosition);
                
                yPosition += 10;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const checkin = document.getElementById('invoice-checkin').value;
                const checkout = document.getElementById('invoice-checkout').value;
                doc.text(`Check-in: ${formatDate(checkin)}`, 20, yPosition);
                yPosition += 5;
                doc.text(`Check-out: ${formatDate(checkout)}`, 20, yPosition);
                yPosition += 5;
                doc.text(`${document.getElementById('invoice-room').value}`, 20, yPosition);
                
                // Invoice Items Table
                yPosition += 20;
                const tableStartY = yPosition;
                
                // Table header
                doc.setFillColor(99, 102, 241);
                doc.rect(20, tableStartY, 170, 10, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('Pos.', 25, tableStartY + 7);
                doc.text('Beschreibung', 40, tableStartY + 7);
                doc.text('Menge', 120, tableStartY + 7);
                doc.text('Einzelpreis', 140, tableStartY + 7);
                doc.text('Gesamtpreis', 165, tableStartY + 7);
                
                // Table items
                yPosition = tableStartY + 15;
                doc.setTextColor(0, 0, 0);
                
                currentInvoiceItems.forEach((item, index) => {
                    const itemTotal = item.quantity * item.unitPrice;
                    
                    doc.text(`${index + 1}`, 25, yPosition);
                    
                    // Handle long descriptions
                    const description = item.description || '';
                    const maxDescriptionWidth = 75;
                    const descriptionLines = doc.splitTextToSize(description, maxDescriptionWidth);
                    doc.text(descriptionLines, 40, yPosition);
                    
                    doc.text(`${item.quantity}`, 125, yPosition);
                    doc.text(`‚Ç¨${item.unitPrice.toFixed(2)}`, 145, yPosition);
                    doc.text(`‚Ç¨${itemTotal.toFixed(2)}`, 170, yPosition);
                    
                    yPosition += Math.max(5, descriptionLines.length * 5);
                });
                
                // Add line below items
                yPosition += 5;
                doc.line(20, yPosition, 190, yPosition);
                
                // Totals with individual tax rates
                let subtotal = 0;
                let totalTaxAmount = 0;
                const taxBreakdown = new Map();

                currentInvoiceItems.forEach(item => {
                    const itemSubtotal = item.quantity * item.unitPrice;
                    const taxRate = item.taxRate || 19;
                    const itemTaxAmount = (itemSubtotal * taxRate) / 100;
                    
                    subtotal += itemSubtotal;
                    totalTaxAmount += itemTaxAmount;
                    
                    // Group by tax rate for breakdown
                    const taxKey = taxRate.toFixed(1);
                    if (!taxBreakdown.has(taxKey)) {
                        taxBreakdown.set(taxKey, { subtotal: 0, tax: 0 });
                    }
                    taxBreakdown.get(taxKey).subtotal += itemSubtotal;
                    taxBreakdown.get(taxKey).tax += itemTaxAmount;
                });

                const total = subtotal + totalTaxAmount;
                
                yPosition += 15;
                doc.text('Zwischensumme:', 140, yPosition);
                doc.text(`‚Ç¨${subtotal.toFixed(2)}`, 170, yPosition);
                
                yPosition += 8;
                // Show tax breakdown by rate
                if (taxBreakdown.size === 1) {
                    const [taxRate] = taxBreakdown.keys();
                    doc.text(`MwSt. (${taxRate}%):`, 140, yPosition);
                    doc.text(`‚Ç¨${totalTaxAmount.toFixed(2)}`, 170, yPosition);
                } else {
                    doc.text('MwSt.:', 140, yPosition);
                    doc.text(`‚Ç¨${totalTaxAmount.toFixed(2)}`, 170, yPosition);
                    yPosition += 5;
                    doc.setFontSize(8);
                    for (const [taxRate, breakdown] of taxBreakdown) {
                        yPosition += 4;
                        doc.text(`  ${taxRate}%: ‚Ç¨${breakdown.tax.toFixed(2)}`, 140, yPosition);
                    }
                    doc.setFontSize(10);
                }
                
                yPosition += 8;
                doc.line(140, yPosition, 190, yPosition);
                
                yPosition += 10;
                doc.setFontSize(12);
                doc.setTextColor(99, 102, 241);
                doc.text('Gesamtbetrag:', 140, yPosition);
                doc.text(`‚Ç¨${total.toFixed(2)}`, 170, yPosition);
                
                // Payment and Remarks
                yPosition += 20;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                const payment = document.getElementById('invoice-payment').value;
                doc.text('Zahlungsart:', 20, yPosition);
                doc.text(payment, 60, yPosition);
                
                const remarks = document.getElementById('invoice-remarks').value;
                if (remarks) {
                    yPosition += 10;
                    doc.text('Bemerkungen:', 20, yPosition);
                    yPosition += 5;
                    const remarkLines = doc.splitTextToSize(remarks, 170);
                    doc.text(remarkLines, 20, yPosition);
                    yPosition += remarkLines.length * 5;
                }

                // Bank details if available
                if (companyData.iban) {
                    yPosition += 10;
                    doc.setFontSize(9);
                    doc.setTextColor(64, 64, 64);
                    doc.text('Bankverbindung:', 20, yPosition);
                    yPosition += 4;
                    if (companyData.bank) {
                        doc.text(`Bank: ${companyData.bank}`, 20, yPosition);
                        yPosition += 4;
                    }
                    doc.text(`IBAN: ${companyData.iban}`, 20, yPosition);
                    if (companyData.bic) {
                        yPosition += 4;
                        doc.text(`BIC: ${companyData.bic}`, 20, yPosition);
                    }
                }
                
                // Footer
                yPosition = Math.max(yPosition + 20, 260);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text('Vielen Dank f√ºr Ihren Aufenthalt bei uns!', 20, yPosition);
                doc.text('Bei Fragen zur Rechnung wenden Sie sich gerne an uns.', 20, yPosition + 5);
                
                // Legal footer
                yPosition += 15;
                let footerText = `Erstellt am: ${new Date().toLocaleString('de-DE')} | Hotel Verwaltungssystem`;
                if (companyData.manager) {
                    footerText += ` | Gesch√§ftsf√ºhrer: ${companyData.manager}`;
                }
                if (companyData.register) {
                    footerText += ` | ${companyData.register}`;
                }
                if (companyData.taxNumber) {
                    footerText += ` | Steuernr: ${companyData.taxNumber}`;
                }
                if (companyData.vatId) {
                    footerText += ` | USt-IdNr: ${companyData.vatId}`;
                }
                
                const footerLines = doc.splitTextToSize(footerText, 170);
                doc.text(footerLines, 20, yPosition);
                
                // Save PDF
                const fileName = `Rechnung_${bookingId}_${lastname}.pdf`;
                doc.save(fileName);
                
                closeModal('invoice-editor-modal');
                showAlert(`Rechnung "${fileName}" wurde erfolgreich erstellt und heruntergeladen!`, 'success');
                
            } catch (error) {
                console.error('Error generating advanced invoice:', error);
                showAlert('Fehler beim Erstellen der Rechnung. Bitte versuchen Sie es erneut.', 'danger');
            }
        }

        // Guest management functions
        function renderGuests() {
            console.log('=== renderGuests START ===');
            console.log('renderGuests called');
            // Update booking counts before rendering
            updateGuestBookingCounts();
            console.log('After updateGuestBookingCounts, guests:', guests.map(g => ({name: g.firstname + ' ' + g.lastname, bookings: g.bookings})));
            
            const tbody = document.getElementById('guests-table-body');
            tbody.innerHTML = '';
            
            // Sort guests by name
            const sortedGuests = [...guests].sort((a, b) => 
                `${a.lastname} ${a.firstname}`.localeCompare(`${b.lastname} ${b.firstname}`)
            );
            
            console.log('Rendering guests:', sortedGuests.map(g => ({name: g.firstname + ' ' + g.lastname, bookings: g.bookings})));
            
            sortedGuests.forEach(guest => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${guest.id}</td>
                    <td>${guest.firstname} ${guest.lastname}</td>
                    <td>${guest.email || '-'}</td>
                    <td>${guest.phone || '-'}</td>
                    <td style="max-width: 150px; white-space: pre-line; font-size: 0.85em;">${guest.address || '-'}</td>
                    <td>${guest.bookings}</td>
                    <td>
                        <span class="badge ${guest.bookings > 1 ? 'badge-primary' : 'badge-info'}">
                            <i class="fas fa-${guest.bookings > 1 ? 'star' : 'user'}"></i>
                            ${guest.bookings > 1 ? 'Stammgast' : 'Neuer Gast'}
                        </span>
                    </td>
                    <td>
                        <div class="btn-group" style="display: flex; gap: 2px; flex-wrap: nowrap;">
                            <button class="btn btn-outline btn-xs" onclick="editGuest('${guest.id}')" title="Bearbeiten">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-xs" onclick="deleteGuest('${guest.id}')" title="L√∂schen">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function searchGuests() {
            const searchTerm = document.getElementById('guest-search').value.toLowerCase();
            const rows = document.querySelectorAll('#guests-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function showAddGuestModal() {
            document.getElementById('add-guest-form').reset();
            document.getElementById('add-guest-modal').style.display = 'block';
        }

        function addGuest(event) {
            event.preventDefault();
            
            const firstname = document.getElementById('new-guest-firstname').value;
            const lastname = document.getElementById('new-guest-lastname').value;
            const email = document.getElementById('new-guest-email').value;
            const phone = document.getElementById('new-guest-phone').value;
            const address = document.getElementById('new-guest-address').value;
            
            // Check if guest already exists
            if (email && guests.find(g => g.email === email)) {
                showAlert('Ein Gast mit dieser E-Mail-Adresse existiert bereits!', 'warning');
                return;
            }
            
            const guestId = 'G' + String(guests.length + 1).padStart(3, '0');
            
            guests.push({
                id: guestId,
                firstname: firstname,
                lastname: lastname,
                email: email,
                phone: phone,
                address: address,
                bookings: 0,
                regular: false
            });
            
            saveToLocalStorage();
            renderGuests();
            updateDashboard();
            
            showAlert('Gast erfolgreich hinzugef√ºgt!', 'success');
            closeModal('add-guest-modal');
        }

        function deleteGuest(guestId) {
            if (confirm('M√∂chten Sie diesen Gast wirklich l√∂schen?')) {
                const guestIndex = guests.findIndex(g => g.id === guestId);
                if (guestIndex > -1) {
                    guests.splice(guestIndex, 1);
                    saveToLocalStorage();
                    renderGuests();
                    showAlert('Gast wurde gel√∂scht.', 'info');
                }
            }
        }

        function editGuest(guestId) {
            const guest = guests.find(g => g.id === guestId);
            if (!guest) {
                showAlert('Gast nicht gefunden!', 'danger');
                return;
            }

            // HTML-Escape-Funktion f√ºr sichere Template-Strings
            const escapeHtml = (str) => {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            // Modal-Inhalt mit innerHTML erstellen (V12 Ansatz mit HTML-Escaping)
            const modalBody = document.querySelector('#edit-guest-modal .modal-body');
            const modalFooter = document.querySelector('#edit-guest-modal .modal-footer');
            
            modalBody.innerHTML = `
                <form id="edit-guest-form-dynamic">
                    <input type="hidden" id="edit-guest-id-dynamic" value="${escapeHtml(guest.id)}">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-guest-firstname-dynamic">Vorname *</label>
                            <input type="text" class="form-control" id="edit-guest-firstname-dynamic" value="${escapeHtml(guest.firstname)}" required>
                        </div>
                        <div class="form-group">
                            <label for="edit-guest-lastname-dynamic">Nachname *</label>
                            <input type="text" class="form-control" id="edit-guest-lastname-dynamic" value="${escapeHtml(guest.lastname)}" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-guest-email-dynamic">E-Mail</label>
                            <input type="email" class="form-control" id="edit-guest-email-dynamic" value="${escapeHtml(guest.email || '')}">
                        </div>
                        <div class="form-group">
                            <label for="edit-guest-phone-dynamic">Telefon</label>
                            <input type="tel" class="form-control" id="edit-guest-phone-dynamic" value="${escapeHtml(guest.phone || '')}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-guest-address-dynamic">Adresse</label>
                        <textarea class="form-control" id="edit-guest-address-dynamic" rows="3" placeholder="Stra√üe, Hausnummer&#10;PLZ Ort&#10;Land">${escapeHtml(guest.address || '')}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Buchungen</label>
                        <p class="form-text">Anzahl Buchungen: <strong>${guest.bookings}</strong></p>
                        <p class="form-text text-muted">Die Buchungsanzahl wird automatisch verwaltet.</p>
                    </div>
                </form>
            `;
            
            console.log('HTML created for guest:', {
                id: guest.id,
                firstname: guest.firstname,
                lastname: guest.lastname,
                escapedFirstname: escapeHtml(guest.firstname),
                escapedLastname: escapeHtml(guest.lastname)
            });
            
            modalFooter.innerHTML = `
                <button type="button" class="btn btn-primary" onclick="saveGuestChanges()">
                    <i class="fas fa-save"></i> √Ñnderungen speichern
                </button>
                <button type="button" class="btn btn-outline" onclick="closeModal('edit-guest-modal')">
                    <i class="fas fa-times"></i> Abbrechen
                </button>
            `;

            // Modal √∂ffnen
            document.getElementById('edit-guest-modal').style.display = 'block';

            // Nach dem √ñffnen pr√ºfen, ob die Werte in den Feldern stehen
            setTimeout(() => {
                const firstnameField = document.getElementById('edit-guest-firstname-dynamic');
                const lastnameField = document.getElementById('edit-guest-lastname-dynamic');
                const emailField = document.getElementById('edit-guest-email-dynamic');
                const phoneField = document.getElementById('edit-guest-phone-dynamic');
                
                console.log('Values check after modal open:', {
                    firstnameField: !!firstnameField,
                    lastnameField: !!lastnameField,
                    firstnameValue: firstnameField ? firstnameField.value : 'field not found',
                    lastnameValue: lastnameField ? lastnameField.value : 'field not found',
                    emailValue: emailField ? emailField.value : 'field not found',
                    phoneValue: phoneField ? phoneField.value : 'field not found'
                });
            }, 100);
        }

        function saveGuestChanges() {
            console.log('saveGuestChanges called - START');
            
            const guestIdEl = document.getElementById('edit-guest-id-dynamic');
            const firstnameEl = document.getElementById('edit-guest-firstname-dynamic');
            const lastnameEl = document.getElementById('edit-guest-lastname-dynamic');
            const emailEl = document.getElementById('edit-guest-email-dynamic');
            const phoneEl = document.getElementById('edit-guest-phone-dynamic');
            const addressEl = document.getElementById('edit-guest-address-dynamic');

            console.log('Elements search result:', {
                guestIdEl: !!guestIdEl,
                firstnameEl: !!firstnameEl,
                lastnameEl: !!lastnameEl,
                emailEl: !!emailEl,
                phoneEl: !!phoneEl
            });

            if (!firstnameEl || !lastnameEl || !guestIdEl) {
                console.log('Elements not found - ABORT');
                showAlert('Formular-Elemente nicht gefunden!', 'danger');
                return;
            }
            
            console.log('All elements found - CONTINUE');

            const guestId = guestIdEl.value;
            
            // Debug: Schauen was wirklich in den Feldern steht
            console.log('Debug form elements:', {
                firstnameEl,
                lastnameEl,
                firstnameValue: firstnameEl.value,
                lastnameValue: lastnameEl.value,
                firstnameAttribute: firstnameEl.getAttribute('value'),
                lastnameAttribute: lastnameEl.getAttribute('value')
            });
            
            const firstname = firstnameEl.value.trim();
            const lastname = lastnameEl.value.trim();
            const email = emailEl ? emailEl.value.trim() : '';
            const phone = phoneEl ? phoneEl.value.trim() : '';
            const address = addressEl ? addressEl.value.trim() : '';
            
            console.log('Final extracted values:', {
                firstname: `"${firstname}"`,
                lastname: `"${lastname}"`,
                email: `"${email}"`,
                phone: `"${phone}"`
            });

            if (!firstname || !lastname) {
                showAlert('Vorname und Nachname sind Pflichtfelder!', 'warning');
                return;
            }

            const guestIndex = guests.findIndex(g => g.id === guestId);
            if (guestIndex === -1) {
                showAlert('Gast nicht gefunden!', 'danger');
                return;
            }

            // Pr√ºfen ob E-Mail bereits von anderem Gast verwendet wird
            if (email && guests.find(g => g.email === email && g.id !== guestId)) {
                showAlert('Ein anderer Gast verwendet bereits diese E-Mail-Adresse!', 'warning');
                return;
            }

            // Gast-Daten aktualisieren
            console.log('Before update:', guests[guestIndex]);
            guests[guestIndex].firstname = firstname;
            guests[guestIndex].lastname = lastname;
            guests[guestIndex].email = email;
            guests[guestIndex].phone = phone;
            guests[guestIndex].address = address;
            console.log('After update:', guests[guestIndex]);

            // Auch alle Buchungen mit diesem Gast aktualisieren
            bookings.forEach(booking => {
                if (booking.guestId === guestId) {
                    booking.firstname = firstname;
                    booking.lastname = lastname;
                    booking.email = email;
                    booking.phone = phone;
                }
            });

            saveToLocalStorage();
            console.log('Data saved to localStorage. Current guests array:', guests);
            renderGuests();
            renderBookings(); // Buchungen auch neu rendern, falls Namen ge√§ndert wurden
            updateDashboard();
            
            showAlert('Gast erfolgreich aktualisiert!', 'success');
            closeModal('edit-guest-modal');
        }

        function updateGuest(event) {
            // Legacy function - should not be called anymore
            event.preventDefault();
            saveGuestChanges();
        }

        // Calendar functions
        function renderCalendar() {
            const calendarHeader = document.getElementById('calendar-header');
            const calendarBody = document.getElementById('calendar-body');
            const monthYearElement = document.getElementById('calendar-month-year');
            
            // Set month/year header
            const monthNames = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni',
                               'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            monthYearElement.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;
            
            // Get first and last day of month
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1);
            const lastDay = new Date(currentCalendarYear, currentCalendarMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // Clear calendar header and body
            calendarHeader.innerHTML = '';
            calendarBody.innerHTML = '';
            
            // Create header row with days
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="room-header">Zimmer</th>';
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                
                const th = document.createElement('th');
                th.className = 'day-header';
                if (dateStr === todayStr) {
                    th.classList.add('today');
                }
                if (isWeekend) {
                    th.classList.add('weekend');
                }
                // Wochentag-Namen auf Deutsch
                const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
                const dayName = dayNames[date.getDay()];
                th.innerHTML = `<div class="day-number">${day}</div><div class="day-name">${dayName}</div>`;
                headerRow.appendChild(th);
            }
            
            calendarHeader.appendChild(headerRow);
            
            // Create rows for each room
            rooms.forEach(room => {
                
                const row = document.createElement('tr');
                
                // Room number cell
                const roomCell = document.createElement('td');
                roomCell.className = 'room-cell';
                if (room.name) {
                    roomCell.innerHTML = `<div class="room-number">${room.number}</div><div class="room-name-small">${room.name}</div>`;
                } else {
                    roomCell.textContent = room.number;
                }
                row.appendChild(roomCell);
                
                // Day cells for this room
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(currentCalendarYear, currentCalendarMonth, day);
                    const dateStr = `${currentCalendarYear}-${String(currentCalendarMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const today = new Date();
                    const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    
                    const cell = document.createElement('td');
                    cell.className = 'day-cell';
                    
                    // Add today and weekend classes
                    if (dateStr === todayStr) {
                        cell.classList.add('today');
                    }
                    if (isWeekend) {
                        cell.classList.add('weekend');
                    }
                    
                    // Get room status for this date
                    const status = getRoomStatusForDate(room, dateStr);
                    cell.classList.add(`status-${status.status}`);
                    cell.innerHTML = getStatusSymbol(status.status);
                    
                    // Add click handler
                    cell.onclick = function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        try {
                            console.log('CLICK: Attempting to call showDayDetails');
                            showDayDetails(room, dateStr, status);  // Pass the complete room object!
                        } catch (error) {
                            console.error('CLICK ERROR:', error);
                            alert('Fehler beim √ñffnen der Zimmer-Details: ' + error.message);
                        }
                    };
                    
                    row.appendChild(cell);
                }
                
                calendarBody.appendChild(row);
            });
        }

        function getRoomStatusForDate(room, dateStr) {
            // Pr√ºfen ob Wartung
            if (room.status === 'wartung') {
                return { status: 'wartung' };
            }
            
            // Alle Ereignisse f√ºr diesen Tag sammeln
            let events = [];
            let guests = [];
            
            // Check-out Events suchen - aktive und abgeschlossene Buchungen (f√ºr historische Anzeige)
            const checkoutBookings = bookings.filter(b => {
                return b.room === room.number && 
                       b.checkout === dateStr && 
                       b.status !== 'Storniert';
            });
            
            checkoutBookings.forEach(b => {
                if (b.status === 'Abgeschlossen') {
                    events.push('checkout_completed');
                } else {
                    events.push('checkout');
                }
                guests.push(`${b.firstname} ${b.lastname}`);
            });
            
            // Check-in Events suchen - aktive und abgeschlossene Buchungen (f√ºr historische Anzeige)
            const checkinBookings = bookings.filter(b => {
                return b.room === room.number && 
                       b.checkin === dateStr && 
                       b.status !== 'Storniert';
            });
            
            checkinBookings.forEach(b => {
                if (b.status === 'Abgeschlossen') {
                    events.push('checkin_completed');
                } else {
                    events.push('checkin');
                }
                guests.push(`${b.firstname} ${b.lastname}`);
            });
            
            // Wenn Events an diesem Tag stattfinden
            if (events.length > 0) {
                // Pr√ºfe auf abgeschlossene Events
                const hasCompletedCheckout = events.includes('checkout_completed');
                const hasCompletedCheckin = events.includes('checkin_completed');
                const hasActiveCheckout = events.includes('checkout');
                const hasActiveCheckin = events.includes('checkin');
                
                // Kombinierte Events
                if ((hasActiveCheckout || hasCompletedCheckout) && (hasActiveCheckin || hasCompletedCheckin)) {
                    if (hasCompletedCheckout || hasCompletedCheckin) {
                        return { 
                            status: 'checkout_checkin_completed', 
                            guest: guests.join(' / '),
                            events: events,
                            guests: guests 
                        };
                    } else {
                        return { 
                            status: 'checkout_checkin', 
                            guest: guests.join(' / '),
                            events: events,
                            guests: guests 
                        };
                    }
                } else if (hasCompletedCheckout) {
                    return { 
                        status: 'checkout_completed', 
                        guest: guests[0] 
                    };
                } else if (hasActiveCheckout) {
                    return { 
                        status: 'checkout', 
                        guest: guests[0] 
                    };
                } else if (hasCompletedCheckin) {
                    return { 
                        status: 'checkin_completed', 
                        guest: guests[0] 
                    };
                } else if (hasActiveCheckin) {
                    return { 
                        status: 'checkin', 
                        guest: guests[0] 
                    };
                }
            }
            
            // Normale Buchung pr√ºfen (zwischen Check-in und Check-out)
            // Erst aktive/reservierte Buchungen pr√ºfen
            const activeBooking = bookings.find(b => {
                return b.room === room.number && 
                       b.checkin < dateStr && 
                       b.checkout > dateStr && 
                       b.status !== 'Storniert' && 
                       b.status !== 'Abgeschlossen';
            });
            
            if (activeBooking) {
                const status = activeBooking.status === 'Aktiv' ? 'belegt' : 'reserviert';
                return { status: status, guest: `${activeBooking.firstname} ${activeBooking.lastname}` };
            }
            
            // Dann abgeschlossene Buchungen pr√ºfen (f√ºr historische Anzeige)
            const completedBooking = bookings.find(b => {
                return b.room === room.number && 
                       b.checkin < dateStr && 
                       b.checkout > dateStr && 
                       b.status === 'Abgeschlossen';
            });
            
            if (completedBooking) {
                return { 
                    status: 'belegt_abgeschlossen', 
                    guest: `${completedBooking.firstname} ${completedBooking.lastname}` 
                };
            }
            
            return { status: 'frei' };
        }

        function showDayDetails(room, dateStr, status) {
            console.log('DEBUG: showDayDetails called with room object:', room);
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('de-DE');
            
            // Modal-Titel setzen
            document.getElementById('calendar-modal-title').textContent = `Zimmer ${room.number} - ${formattedDate}`;
            
            // Modal-Inhalt erstellen
            let actionsHtml = '';
            try {
                actionsHtml = getStatusActions(room.number, dateStr, status);
            } catch (error) {
                console.error('Error in getStatusActions:', error);
                actionsHtml = `<p class="text-red-500">Fehler beim Laden der Aktionen: ${error.message}</p>`;
            }
            
            let content = `
                <div class="mb-4">
                    <p><strong>Zimmerart:</strong> ${room.type || 'Standard'}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${getBadgeType(status.status)}">${getStatusText(status.status)}</span></p>
                    ${status.guest ? `<p><strong>Gast:</strong> ${status.guest}</p>` : ''}
                    <p><strong>Preis:</strong> ‚Ç¨${room.price || '0'}/Nacht</p>
                </div>
                <div class="btn-group">
                    ${actionsHtml}
                </div>
            `;
            
            document.getElementById('calendar-modal-content').innerHTML = content;
            document.getElementById('calendar-detail-modal').style.display = 'block';
        }

        function getStatusText(status) {
            switch (status) {
                case 'frei': return 'Frei';
                case 'belegt': return 'Belegt';
                case 'reserviert': return 'Reserviert';
                case 'wartung': return 'Wartung';
                case 'checkin': return 'Check-in';
                case 'checkout': return 'Check-out';
                case 'checkout_checkin': return 'Check-out & Check-in';
                case 'belegt_abgeschlossen': return 'Abgeschlossen (Aufenthalt)';
                case 'checkin_completed': return 'Check-in (Abgeschlossen)';
                case 'checkout_completed': return 'Check-out (Abgeschlossen)';
                case 'checkout_checkin_completed': return 'Check-out & Check-in (Abgeschlossen)';
                default: return 'Unbekannt';
            }
        }

        function getStatusActions(roomNumber, dateStr, status) {
            let actions = '';
            
            if (status.status === 'frei') {
                actions = `<button class="btn btn-primary" onclick="createBookingFromCalendar('${roomNumber}', '${dateStr}')">
                    <i class="fas fa-plus"></i> Neue Buchung erstellen
                </button>`;
            } else if (status.status === 'checkin' || status.status === 'checkout' || status.status === 'checkout_checkin') {
                // Finde die entsprechenden Buchungen
                const relevantBookings = bookings.filter(b => 
                    b.room === roomNumber && 
                    (b.checkin === dateStr || b.checkout === dateStr) &&
                    b.status !== 'Storniert'
                );
                
                relevantBookings.forEach(booking => {
                    actions += `
                        <div class="mb-2">
                            <strong>${booking.firstname} ${booking.lastname}</strong>
                            <div class="btn-group mt-2">
                                <button class="btn btn-outline btn-sm" onclick="editBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="cancelBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-ban"></i> Stornieren
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                if (status.status === 'checkout' || status.status === 'checkout_checkin') {
                    actions += `
                        <button class="btn btn-primary btn-sm" onclick="createBookingFromCalendar('${roomNumber}', '${dateStr}')">
                            <i class="fas fa-plus"></i> Neue Buchung ab heute
                        </button>
                    `;
                }
            } else if (status.status === 'belegt' || status.status === 'reserviert') {
                // Finde die Buchung f√ºr dieses Zimmer und Datum
                const booking = bookings.find(b => 
                    b.room === roomNumber && 
                    b.checkin <= dateStr && 
                    b.checkout > dateStr && 
                    b.status !== 'Storniert' && 
                    b.status !== 'Abgeschlossen'
                );
                
                if (booking) {
                    actions = `
                        <div class="mb-2">
                            <strong>${booking.firstname} ${booking.lastname}</strong><br>
                            <small>${booking.checkin} bis ${booking.checkout}</small>
                            <div class="btn-group mt-2">
                                <button class="btn btn-outline btn-sm" onclick="editBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-edit"></i> Buchung bearbeiten
                                </button>
                                <button class="btn btn-warning btn-sm" onclick="cancelBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-ban"></i> Buchung stornieren
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            return actions;
        }


        function editBookingFromCalendar(bookingId) {
            closeModal('calendar-detail-modal');
            editBooking(bookingId);
        }

        function cancelBookingFromCalendar(bookingId) {
            closeModal('calendar-detail-modal');
            cancelBooking(bookingId);
        }

        function generateInvoiceFromCalendar(bookingId) {
            closeModal('calendar-detail-modal');
            openInvoiceEditor(bookingId);
        }


        function previousMonth() {
            currentCalendarMonth--;
            if (currentCalendarMonth < 0) {
                currentCalendarMonth = 11;
                currentCalendarYear--;
            }
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarMonth++;
            if (currentCalendarMonth > 11) {
                currentCalendarMonth = 0;
                currentCalendarYear++;
            }
            renderCalendar();
        }

        // Backup and data management functions
        function showBackupAssistant() {
            // Update backup info
            document.getElementById('backup-rooms-count').textContent = rooms.length;
            document.getElementById('backup-bookings-count').textContent = bookings.length;
            document.getElementById('backup-guests-count').textContent = guests.length;
            
            const lastBackup = localStorage.getItem('lastBackupDate');
            if (lastBackup) {
                document.getElementById('last-backup-info').textContent = `Letztes Backup: ${formatDate(lastBackup)}`;
            } else {
                document.getElementById('last-backup-info').textContent = 'Noch kein Backup erstellt';
            }
            
            document.getElementById('backup-assistant-modal').style.display = 'block';
        }

        function exportBackup() {
            const backupData = {
                rooms: rooms,
                bookings: bookings,
                guests: guests,
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            // Zeitstempel mit Datum und Uhrzeit f√ºr eindeutige Backup-Namen
            const now = new Date();
            const timestamp = now.toISOString()
                .replace(/T/, '_')
                .replace(/:/g, '-')
                .slice(0, 19);
            link.download = `hotel-backup-${timestamp}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            localStorage.setItem('lastBackupDate', new Date().toISOString().split('T')[0]);
            
            showAlert('Backup erfolgreich erstellt und heruntergeladen!', 'success');
            closeModal('backup-assistant-modal');
        }

        function importBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (confirm('Warnung: Der Import √ºberschreibt alle aktuellen Daten. M√∂chten Sie fortfahren?')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (backupData.rooms && backupData.bookings && backupData.guests) {
                            rooms = backupData.rooms;
                            bookings = backupData.bookings;
                            guests = backupData.guests;
                            
                            saveToLocalStorage();
                            
                            updateDashboard();
                            renderRooms();
                            renderCalendar();
                            renderBookings();
                            renderGuests();
                            
                            showAlert('Backup erfolgreich wiederhergestellt!', 'success');
                            closeModal('backup-assistant-modal');
                        } else {
                            throw new Error('Invalid backup format');
                        }
                    } catch (error) {
                        showAlert('Fehler beim Importieren des Backups. Datei ung√ºltig.', 'danger');
                    }
                };
                reader.readAsText(file);
            }
            
            // Reset file input
            event.target.value = '';
        }

        function resetAllData() {
            if (confirm('Warnung: Alle Daten werden gel√∂scht und das System auf Werkszustand zur√ºckgesetzt. M√∂chten Sie fortfahren?')) {
                if (confirm('Sind Sie sicher? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden!')) {
                    localStorage.clear();
                    
                    rooms = [];
                    bookings = [];
                    guests = [];
                    
                    initializeRooms();
                    updateDashboard();
                    renderRooms();
                    renderCalendar();
                    renderBookings();
                    renderGuests();
                    
                    showAlert('System wurde zur√ºckgesetzt.', 'info');
                }
            }
        }

        // Local storage functions
        function saveToLocalStorage() {
            try {
                localStorage.setItem('hotelRooms', JSON.stringify(rooms));
                localStorage.setItem('hotelBookings', JSON.stringify(bookings));
                localStorage.setItem('hotelGuests', JSON.stringify(guests));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showAlert('Warnung: Daten konnten nicht gespeichert werden.', 'warning');
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedRooms = localStorage.getItem('hotelRooms');
                const savedBookings = localStorage.getItem('hotelBookings');
                const savedGuests = localStorage.getItem('hotelGuests');
                
                console.log('Checking for existing data:', { savedRooms: !!savedRooms, savedBookings: !!savedBookings, savedGuests: !!savedGuests });
                
                // Check if any real data exists (not just empty arrays)
                let hasRealData = false;
                
                if (savedRooms) {
                    const roomsData = JSON.parse(savedRooms);
                    if (roomsData.length > 0) {
                        rooms = roomsData;
                        hasRealData = true;
                    }
                }
                
                if (savedBookings) {
                    const bookingsData = JSON.parse(savedBookings);
                    if (bookingsData.length > 0) {
                        bookings = bookingsData;
                        hasRealData = true;
                    }
                }
                
                if (savedGuests) {
                    const guestsData = JSON.parse(savedGuests);
                    if (guestsData.length > 0) {
                        guests = guestsData;
                        
                        // Migrate existing guests to add address field
                        guests.forEach(guest => {
                            if (guest.address === undefined) {
                                guest.address = '';
                            }
                        });
                        
                        hasRealData = true;
                    }
                }
                
                console.log('Has real data:', hasRealData);
                
                // Show import dialog if no real data exists
                if (!hasRealData) {
                    console.log('No real data found, showing import dialog');
                    setTimeout(() => {
                        document.getElementById('initial-import-modal').style.display = 'block';
                    }, 500);
                    // Still initialize empty rooms for the UI, but don't save them yet
                    initializeRooms();
                    return; // Don't proceed with normal initialization
                }
                
                // Ensure rooms are initialized if we have data but no rooms
                if (rooms.length === 0) {
                    initializeRooms();
                }
                
                // Update room statuses based on bookings
                updateRoomStatusesFromBookings();
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showAlert('Warnung: Gespeicherte Daten konnten nicht geladen werden.', 'warning');
            }
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Utility functions
        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('de-DE');
        }

        function formatDateWithWeekday(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const weekdayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const weekday = weekdayNames[date.getDay()];
            const formattedDate = date.toLocaleDateString('de-DE');
            return `${weekday}, ${formattedDate}`;
        }
        
        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            const formattedDate = today.toLocaleDateString('de-DE', options);
            const currentDateElement = document.getElementById('current-date');
            if (currentDateElement) {
                currentDateElement.textContent = formattedDate;
            }
        }

        // Show day details for calendar
        function showDayDetails(room, dateStr, status) {
            const date = new Date(dateStr);
            const formattedDate = formatDate(dateStr);
            
            // Set modal title
            document.getElementById('calendar-modal-title').innerHTML = `üìÖ Zimmer ${room.number} - ${formattedDate}`;
            
            // Create modal content
            let content = `
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Zimmerinformationen</h3>
                    <p><strong>Zimmerart:</strong> ${room.type}</p>
                    <p><strong>Status:</strong> <span class="badge badge-${getBadgeType(status.status)}">
                        <i class="fas fa-${getStatusIcon(status.status)}"></i>
                        ${getStatusText(status.status)}
                    </span></p>
                    ${status.guest ? `<p><strong>Gast:</strong> ${status.guest}</p>` : ''}
                    <p><strong>Preis:</strong> ‚Ç¨${room.price}/Nacht</p>
                </div>
            `;
            
            // Action buttons based on status
            if (status.status === 'belegt' || status.status === 'reserviert') {
                // Find booking
                const booking = bookings.find(b => 
                    b.room === room.number && 
                    b.checkin <= dateStr && 
                    b.checkout > dateStr &&
                    b.status !== 'Storniert'
                );
                
                if (booking) {
                    content += `
                        <div class="form-section">
                            <h3><i class="fas fa-calendar-check"></i> Buchungsdetails</h3>
                            <p><strong>Buchungs-Nr:</strong> ${booking.id}</p>
                            <p><strong>Check-in:</strong> ${formatDate(booking.checkin)}</p>
                            <p><strong>Check-out:</strong> ${formatDate(booking.checkout)}</p>
                            <p><strong>Gesamtpreis:</strong> ‚Ç¨${booking.total}</p>
                            <p><strong>Zahlungsart:</strong> ${booking.payment}</p>
                            ${booking.remarks ? `<p><strong>Bemerkungen:</strong> ${booking.remarks}</p>` : ''}
                            
                            <div class="btn-group mt-4">
                                <button class="btn btn-primary" onclick="editBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-edit"></i> Buchung bearbeiten
                                </button>
                                <button class="btn btn-danger" onclick="cancelBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-ban"></i> Buchung stornieren
                                </button>
                                <button class="btn btn-info" onclick="generateInvoiceFromCalendar('${booking.id}')">
                                    <i class="fas fa-file-invoice"></i> Rechnung generieren
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else if (status.status === 'checkin') {
                // Check-in day - booking editable
                const booking = bookings.find(b => 
                    b.room === room.number && 
                    b.checkin === dateStr &&
                    b.status !== 'Storniert'
                );
                
                if (booking) {
                    content += `
                        <div class="form-section">
                            <h3><i class="fas fa-sign-in-alt text-blue-500"></i> Check-in Details</h3>
                            <p><strong>Buchungs-Nr:</strong> ${booking.id}</p>
                            <p><strong>Gast:</strong> ${booking.firstname} ${booking.lastname}</p>
                            <p><strong>Check-out:</strong> ${formatDate(booking.checkout)}</p>
                            <p><strong>Gesamtpreis:</strong> ‚Ç¨${booking.total}</p>
                            <p><strong>Status:</strong> ${booking.status}</p>
                            ${booking.remarks ? `<p><strong>Bemerkungen:</strong> ${booking.remarks}</p>` : ''}
                            
                            <div class="btn-group mt-4">
                                <button class="btn btn-primary" onclick="editBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-edit"></i> Buchung bearbeiten
                                </button>
                                <button class="btn btn-danger" onclick="cancelBookingFromCalendar('${booking.id}')">
                                    <i class="fas fa-ban"></i> Buchung stornieren
                                </button>
                                <button class="btn btn-info" onclick="generateInvoiceFromCalendar('${booking.id}')">
                                    <i class="fas fa-file-invoice"></i> Rechnung generieren
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else if (status.status === 'checkout') {
                // Check-out day - booking editable AND new booking possible
                const checkoutBooking = bookings.find(b => 
                    b.room === room.number && 
                    b.checkout === dateStr &&
                    b.status !== 'Storniert'
                );
                
                if (checkoutBooking) {
                    content += `
                        <div class="form-section">
                            <h3><i class="fas fa-sign-out-alt text-orange-500"></i> Check-out Details</h3>
                            <p><strong>Buchungs-Nr:</strong> ${checkoutBooking.id}</p>
                            <p><strong>Gast:</strong> ${checkoutBooking.firstname} ${checkoutBooking.lastname}</p>
                            <p><strong>Check-in:</strong> ${formatDate(checkoutBooking.checkin)}</p>
                            <p><strong>Gesamtpreis:</strong> ‚Ç¨${checkoutBooking.total}</p>
                            <p><strong>Status:</strong> ${checkoutBooking.status}</p>
                            ${checkoutBooking.remarks ? `<p><strong>Bemerkungen:</strong> ${checkoutBooking.remarks}</p>` : ''}
                            
                            <div class="btn-group mt-4">
                                <button class="btn btn-primary" onclick="editBookingFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-edit"></i> Check-out Buchung bearbeiten
                                </button>
                                <button class="btn btn-danger" onclick="cancelBookingFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-ban"></i> Buchung stornieren
                                </button>
                                <button class="btn btn-info" onclick="generateInvoiceFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-file-invoice"></i> Rechnung generieren
                                </button>
                            </div>
                            
                            <div class="btn-group mt-4">
                                <button class="btn btn-success" onclick="createBookingFromCalendar('${room.number}', '${dateStr}')">
                                    <i class="fas fa-plus"></i> Neue Buchung ab heute
                                </button>
                            </div>
                        </div>
                    `;
                }
            } else if (status.status === 'checkout_checkin') {
                // Check-out AND Check-in on same day
                const checkoutBooking = bookings.find(b => 
                    b.room === room.number && 
                    b.checkout === dateStr &&
                    b.status !== 'Storniert'
                );
                const checkinBooking = bookings.find(b => 
                    b.room === room.number && 
                    b.checkin === dateStr &&
                    b.status !== 'Storniert'
                );
                
                content += `
                    <div class="form-section">
                        <h3><i class="fas fa-exchange-alt"></i> Check-out & Check-in Tag</h3>
                `;
                
                if (checkoutBooking) {
                    content += `
                        <div class="p-3 bg-orange-50 rounded-lg mb-3">
                            <h4><i class="fas fa-sign-out-alt"></i> Check-out: ${checkoutBooking.firstname} ${checkoutBooking.lastname}</h4>
                            <p class="text-sm">Buchungs-Nr: ${checkoutBooking.id}</p>
                            <div class="btn-group mt-2">
                                <button class="btn btn-outline btn-sm" onclick="editBookingFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="cancelBookingFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-ban"></i> Stornieren
                                </button>
                                <button class="btn btn-info btn-sm" onclick="generateInvoiceFromCalendar('${checkoutBooking.id}')">
                                    <i class="fas fa-file-invoice"></i> Rechnung
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                if (checkinBooking) {
                    content += `
                        <div class="p-3 bg-blue-50 rounded-lg mb-3">
                            <h4><i class="fas fa-sign-in-alt"></i> Check-in: ${checkinBooking.firstname} ${checkinBooking.lastname}</h4>
                            <p class="text-sm">Buchungs-Nr: ${checkinBooking.id}</p>
                            <div class="btn-group mt-2">
                                <button class="btn btn-outline btn-sm" onclick="editBookingFromCalendar('${checkinBooking.id}')">
                                    <i class="fas fa-edit"></i> Bearbeiten
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="cancelBookingFromCalendar('${checkinBooking.id}')">
                                    <i class="fas fa-ban"></i> Stornieren
                                </button>
                                <button class="btn btn-info btn-sm" onclick="generateInvoiceFromCalendar('${checkinBooking.id}')">
                                    <i class="fas fa-file-invoice"></i> Rechnung
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                content += `</div>`;
            } else if (status.status === 'frei') {
                content += `
                    <div class="form-section">
                        <div class="text-center">
                            <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
                            <p class="text-green-600 font-semibold mb-4">‚úÖ Zimmer ist an diesem Tag verf√ºgbar</p>
                            
                            <button class="btn btn-success" onclick="createBookingFromCalendar('${room.number}', '${dateStr}')">
                                <i class="fas fa-plus"></i> Neue Buchung erstellen
                            </button>
                        </div>
                    </div>
                `;
            } else if (status.status === 'wartung') {
                content += `
                    <div class="form-section">
                        <div class="text-center">
                            <i class="fas fa-tools text-4xl text-purple-500 mb-4"></i>
                            <p class="text-purple-600 font-semibold mb-4">üîß Zimmer ist in Wartung</p>
                            
                            <p class="text-sm text-gray-600">Buchungen sind f√ºr diesen Tag nicht m√∂glich.</p>
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('calendar-modal-content').innerHTML = content;
            document.getElementById('calendar-detail-modal').style.display = 'block';
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'frei': return 'var(--success)';
                case 'belegt': return 'var(--danger)';
                case 'reserviert': return 'var(--warning)';
                case 'wartung': return 'var(--primary)';
                case 'checkin': return '#0984e3';
                case 'checkout': return '#ff9f43';
                case 'checkout_checkin': return '#e17055';
                default: return 'var(--gray-500)';
            }
        }
        
        function createBookingFromCalendar(roomNumber, dateStr) {
            closeModal('calendar-detail-modal');
            showTab('buchung');
            
            // Pre-fill check-in date
            document.getElementById('checkin-date').value = dateStr;
            
            // Set check-out to next day
            const nextDay = new Date(dateStr);
            nextDay.setDate(nextDay.getDate() + 1);
            const nextDayStr = `${nextDay.getFullYear()}-${String(nextDay.getMonth() + 1).padStart(2, '0')}-${String(nextDay.getDate()).padStart(2, '0')}`;
            document.getElementById('checkout-date').value = nextDayStr;
            
            // Calculate nights and update available rooms
            calculateNights();
            updateAvailableRooms();
            
            // Pre-select room if specified
            if (roomNumber) {
                setTimeout(() => {
                    const roomSelect = document.getElementById('room-number');
                    for (let option of roomSelect.options) {
                        if (option.value === roomNumber) {
                            roomSelect.value = roomNumber;
                            setRoomInfo();
                            break;
                        }
                    }
                }, 100);
            }
        }

        // Click outside modal to close
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
        
    </script>
</body>
</html>